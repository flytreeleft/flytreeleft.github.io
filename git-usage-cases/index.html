<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Git使用案例"><meta name="keywords" content="git"><meta name="author" content="flytreeleft,flytreeleft@126.com"><meta name="copyright" content="flytreeleft"><title>Git使用案例 | flytreeleft's Blog</title><link rel="shortcut icon" href="/assets/profile/favicon.png"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.3"><script>var GLOBAL = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: {"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}"},"path":"search.xml"}
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#拆分子目录到新仓库"><span class="toc-number">1.</span> <span class="toc-text">拆分子目录到新仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#场景"><span class="toc-number">1.1.</span> <span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作"><span class="toc-number">1.2.</span> <span class="toc-text">操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-number">1.3.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改变更提交人的信息"><span class="toc-number">2.</span> <span class="toc-text">修改变更提交人的信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#场景-1"><span class="toc-number">2.1.</span> <span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作-1"><span class="toc-number">2.2.</span> <span class="toc-text">操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考-1"><span class="toc-number">2.3.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#迁移子分支至新仓库"><span class="toc-number">3.</span> <span class="toc-text">迁移子分支至新仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#场景-2"><span class="toc-number">3.1.</span> <span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作-2"><span class="toc-number">3.2.</span> <span class="toc-text">操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考-2"><span class="toc-number">3.3.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改历史提交备注信息"><span class="toc-number">4.</span> <span class="toc-text">修改历史提交备注信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#场景-3"><span class="toc-number">4.1.</span> <span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作-3"><span class="toc-number">4.2.</span> <span class="toc-text">操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考-3"><span class="toc-number">4.3.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/assets/profile/avatar.jpg"></div><div class="author-info__name text-center">flytreeleft</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">3</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">1</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">1</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://coolshell.cn/" target="_blank">酷壳</a><a class="author-info-links__name text-center" href="https://www.infoq.com/" target="_blank">InfoQ</a><a class="author-info-links__name text-center" href="http://www.yinwang.org/" target="_blank">当然我在扯淡</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/assets/profile/walle-watch-the-stars-sky.jpg);"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">flytreeleft's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">Git使用案例</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-05-28</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/开发工具/">开发工具</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">1,355</span><span class="post-meta__separator">|</span><span>阅读时长: 6 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><h2 id="拆分子目录到新仓库"><a href="#拆分子目录到新仓库" class="headerlink" title="拆分子目录到新仓库"></a>拆分子目录到新仓库</h2><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>通常为便于项目开发和调试，开发前期会将多个组件放在同一仓库中，而当各个组件的功能结构和代码逐渐区域稳定后，<br>便需要将其拆分出来进行独立开发和管理，以便于与其他项目共享组件。</p>
<p>此时，不仅需要将组件所在目录内的代码全部拆分到单独的仓库，同时，还需要确保历史记录能够完整保留。</p>
<a id="more"></a>
<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Clone the repository that contains the subfolder.</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/USERNAME/REPOSITORY-NAME</span><br><span class="line"><span class="built_in">cd</span> REPOSITORY-NAME</span><br><span class="line"></span><br><span class="line"><span class="comment"># To filter out the subfolder from the rest of the files in the repository</span></span><br><span class="line"><span class="comment">## FOLDER-NAME: The folder within your project that you'd like to create a separate repository from.</span></span><br><span class="line"><span class="comment">## BRANCH-NAME: The default branch for your current project, for example, 'master' or 'gh-pages'</span></span><br><span class="line">git filter-branch --prune-empty --subdirectory-filter FOLDER-NAME BRANCH-NAME</span><br><span class="line"></span><br><span class="line"><span class="comment"># Change the existing remote 'origin' (or other name) URL to the new repository URL</span></span><br><span class="line">git remote <span class="built_in">set</span>-url origin https://github.com/USERNAME/NEW-REPOSITORY-NAME.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># [Optional] Change BRANCH-NAME to the default branch (e.g. 'master') of the new repository</span></span><br><span class="line">git branch -m BRANCH-NAME master</span><br><span class="line"></span><br><span class="line"><span class="comment"># Push your changes to the new repository</span></span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<ul>
<li>在第二步操作后，当前目录将会只剩下子目录中的文件</li>
<li>最好在新的目录中进行上述操作：可以直接clone，也可以从复制已有项目到其他目录</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://help.github.com/articles/splitting-a-subfolder-out-into-a-new-repository/" target="_blank" rel="noopener">Splitting a subfolder out into a new repository</a></li>
</ul>
<h2 id="修改变更提交人的信息"><a href="#修改变更提交人的信息" class="headerlink" title="修改变更提交人的信息"></a>修改变更提交人的信息</h2><h3 id="场景-1"><a href="#场景-1" class="headerlink" title="场景"></a>场景</h3><p>基于项目长远发展考虑，将某个具有实用价值且吸引力极大的项目开源，<br>需要将项目从公司内部仓库开放到Github上，但相关开发人员在两个系统中所用帐号不一致，<br>为了便于issue交流以及PR提交，这时，需要更改历史中的提交人信息。</p>
<p>其实，大多数时候，很可能是要弃用内部仓库并将工作全部移到公共仓库时才有这么做的需求，其余情况并不需要这么做。</p>
<h3 id="操作-1"><a href="#操作-1" class="headerlink" title="操作"></a>操作</h3><ul>
<li>部分替换：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git filter-branch --commit-filter \</span><br><span class="line">        <span class="string">'if [ "$GIT_AUTHOR_NAME" = "OldAuthor Name" ]; then \</span></span><br><span class="line"><span class="string">             export GIT_AUTHOR_NAME="Author Name"; \</span></span><br><span class="line"><span class="string">             export GIT_AUTHOR_EMAIL=authorEmail@example.com; \</span></span><br><span class="line"><span class="string">             export GIT_COMMITTER_NAME="Commmiter Name"; \</span></span><br><span class="line"><span class="string">             export GIT_COMMITTER_EMAIL=commiterEmail@example.com; \</span></span><br><span class="line"><span class="string">         fi; \</span></span><br><span class="line"><span class="string">         git commit-tree "$@" '</span></span><br><span class="line"><span class="comment"># Push to the branch 'master' of the existing repository</span></span><br><span class="line">git push --force origin master</span><br></pre></td></tr></table></figure>
<ul>
<li>全部替换：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git filter-branch --commit-filter \</span><br><span class="line">        <span class="string">'export GIT_AUTHOR_NAME="Author Name"; \</span></span><br><span class="line"><span class="string">         export GIT_AUTHOR_EMAIL=authorEmail@example.com; \</span></span><br><span class="line"><span class="string">         export GIT_COMMITTER_NAME="Commmiter Name"; \</span></span><br><span class="line"><span class="string">         export GIT_COMMITTER_EMAIL=commiterEmail@example.com; \</span></span><br><span class="line"><span class="string">         git commit-tree "$@" '</span></span><br><span class="line"><span class="comment"># Push to the branch 'master' of the existing repository</span></span><br><span class="line">git push --force origin master</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<ul>
<li>若出现类似<code>Cannot create a new backup. A previous backup already exists in refs/original/. Force overwriting the backup with -f</code>的异常提示，则需要在<code>filter-branch</code>命令中添加选项<code>-f</code>，即<code>git filter-branch -f</code>，以强制进行修改</li>
<li>如果提交的分支是受保护的，则在提交时会出现<code>remote: GitLab: You are not allowed to force push code to a protected branch on this project.</code>的错误信息，此时，需要调整仓库设置，临时取消对目标分支的保护</li>
</ul>
<h3 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://stackoverflow.com/questions/4493936/could-i-change-my-name-and-surname-in-all-previous-commits" target="_blank" rel="noopener">Could I change my name and surname in all previous commits?</a></li>
</ul>
<h2 id="迁移子分支至新仓库"><a href="#迁移子分支至新仓库" class="headerlink" title="迁移子分支至新仓库"></a>迁移子分支至新仓库</h2><h3 id="场景-2"><a href="#场景-2" class="headerlink" title="场景"></a>场景</h3><p>某个项目仓库中可能存在多个功能特性（features）分支，在一段时候后，基于产品功能规划和开发维护等方面的考虑，<br>需要将某些特性分支独立成新的项目或子项目，将其迁移到新的仓库中。</p>
<h3 id="操作-2"><a href="#操作-2" class="headerlink" title="操作"></a>操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Push 'feature-branch' to the branch 'master' (or others) of new repository</span></span><br><span class="line">git push url://to/new/repository.git feature-branch:master</span><br><span class="line"></span><br><span class="line"><span class="comment"># [Optional] Delete the 'feature-branch' from current repository</span></span><br><span class="line">git branch -d feature-branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clone codes from new repository</span></span><br><span class="line">git <span class="built_in">clone</span> url://to/new/repository.git feature-branch</span><br></pre></td></tr></table></figure>
<h3 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://stackoverflow.com/questions/2227062/how-do-i-move-a-git-branch-out-into-its-own-repository" target="_blank" rel="noopener">How do I move a Git branch out into its own repository?</a></li>
</ul>
<h2 id="修改历史提交备注信息"><a href="#修改历史提交备注信息" class="headerlink" title="修改历史提交备注信息"></a>修改历史提交备注信息</h2><h3 id="场景-3"><a href="#场景-3" class="headerlink" title="场景"></a>场景</h3><p>在<a href="#拆分子目录到新仓库">拆分子目录</a>和<a href="#迁移子分支至新仓库">迁移子分支</a>两个场景中，<br>在新仓库中的历史提交记录的备注信息可能存在与项目不相关的信息或者包含原始项目中的一些敏感内容。<br>这个时候，就可能需要修改这些备注信息。</p>
<p>当然，也可能是因为发现以前的提交备注中包含错别字或者表达不清晰，为了避免对其他人产生误导或困惑，<br>将提交的备注信息予以纠正也是很有必要的。</p>
<h3 id="操作-3"><a href="#操作-3" class="headerlink" title="操作"></a>操作</h3><ul>
<li>获取提交ID并Rebase到该提交</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># List histories and get the commit id which should be modified</span></span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rebase to 3 commits before the specified commit (e.g. 'ce0ac37c83')</span></span><br><span class="line">git rebase --interactive ce0ac37c83~3</span><br></pre></td></tr></table></figure>
<p><img src="/assets/images/git-usage-cases-rebase-to-target-commit.png" alt=""></p>
<ul>
<li>将提交所在行开始处的<code>pick</code>修改为<code>edit</code></li>
</ul>
<p><img src="/assets/images/git-usage-cases-change-history-commit.png" alt=""></p>
<ul>
<li>提交并应用修改</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># New commit message</span></span><br><span class="line">git commit --amend -m <span class="string">"fix that the dragging preview can not be shown"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Apply the changes and return to HEAD</span></span><br><span class="line">git rebase --<span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Push to the branch 'master' of the existing repository</span></span><br><span class="line"><span class="comment">## Make sure that the remote branch 'master' is unprotected</span></span><br><span class="line">git push --force origin master</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<ul>
<li>如果需要放弃修改，则运行命令<code>git rebase --abort</code></li>
<li>若直接<code>rebase</code>到目标commit，则该提交不会显示在可修改清单内，故，需选择从其之前的第N个（e.g. <code>~3</code>）提交开始</li>
<li>若提交至非空的仓库，需确保目标分支不是受保护（<code>protected</code>）的</li>
<li>在应用修改后，git将从修改位置开始重新构建commit tree，因此，从该位置开始到HEAD的commit id均会发生变化，但原始commit tree依然存在，通过<code>git diff ce0ac37c83</code>等可看到该提交的变更情况</li>
</ul>
<h3 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://stackoverflow.com/questions/179123/how-to-modify-existing-unpushed-commits" target="_blank" rel="noopener">How to modify existing, unpushed commits?</a></li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:flytreeleft@126.com">flytreeleft</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://flytreeleft.github.io/git-usage-cases/">https://flytreeleft.github.io/git-usage-cases/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">知识共享署名 4.0 国际许可协议</a> 许可协议。转载请注明来自 <a href="https://flytreeleft.github.io" target="_blank">flytreeleft's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/git/">git</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/assets/profile/wechatpay.png"><div class="post-qr-code__desc"></div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/assets/profile/alipay.png"><div class="post-qr-code__desc"></div></div></div></article><nav id="pagination"><div class="prev-post pull-left"><a href="/how-to-break-out-of-your-limit/"><i class="fa fa-chevron-left">  </i><span>如何突破自己的瓶颈？</span></a></div><div class="next-post pull-right"><a href="/hello-world/"><span>Hello world!</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 By flytreeleft</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.3"></script><script src="/js/fancybox.js?version=1.3"></script><script src="/js/sidebar.js?version=1.3"></script><script src="/js/copy.js?version=1.3"></script><script src="/js/fireworks.js?version=1.3"></script><script src="/js/transition.js?version=1.3"></script><script src="/js/scroll.js?version=1.3"></script><script src="/js/head.js?version=1.3"></script></body></html>