<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content><meta name="keywords" content="IT,KISS"><meta name="author" content="flytreeleft,flytreeleft@126.com"><meta name="copyright" content="flytreeleft"><title>Keep it simple, stupid! | flytreeleft's Blog</title><link rel="shortcut icon" href="/assets/profile/favicon.png"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.3"><script>var GLOBAL = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: {"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}"},"path":"search.xml"}
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/assets/profile/avatar.jpg"></div><div class="author-info__name text-center">flytreeleft</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">17</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">29</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">10</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://coolshell.cn/" target="_blank">酷壳</a><a class="author-info-links__name text-center" href="https://www.infoq.com/" target="_blank">InfoQ</a><a class="author-info-links__name text-center" href="http://www.yinwang.org/" target="_blank">当然我在扯淡</a></div></div></div><nav id="nav" style="background-image: url(/assets/profile/walle-watch-the-stars-sky.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">flytreeleft's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/quotes">Quotes</a><a class="site-page" href="/about">About</a></span></div><div id="site-info"><div id="site-title">flytreeleft's Blog</div><div id="site-sub-title">Keep it simple, stupid!</div><div id="site-social-icons"><a class="social-icon" href="https://social.crazydan.org/main/public" target="_blank"><i class="fa fa-home"></i></a><a class="social-icon" href="https://github.com/flytreeleft" target="_blank"><i class="fa fa-github"></i></a><a class="social-icon" href="https://twitter.com/flytreeleft" target="_blank"><i class="fa fa-twitter"></i></a><a class="social-icon search"><i class="fa fa-search"></i></a></div></div><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local Search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><hr class="local-search-stats__hr">Powered by <span style="color: #49B1F5">hexo-generator-search</span></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item"><a class="article-title" href="/the-future-social-formation/">未来社会形态畅想</a><time class="post-meta__date"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2020-06-25</time><span class="post-meta__separator">|</span><time class="post-meta__date"><i class="fa fa-calendar-o" aria-hidden="true"></i> 2017-12-10</time><div class="content"><blockquote>
<p>The post isn’t finished yet, it will be updated anytime!</p>
</blockquote>
<h2 id="无现金社会"><a href="#无现金社会" class="headerlink" title="无现金社会"></a>无现金社会</h2><p>提要：</p>
<ul>
<li>比特币、比特交易网络</li>
<li><a href="https://www.ethereum.org/" target="_blank" rel="noopener">以太坊</a></li>
<li><a href="http://www.iotachina.com/what-is-iota" target="_blank" rel="noopener">IOTA</a><ul>
<li><a href="http://www.iotachina.com/ruhezhaohuiiotayue.html" target="_blank" rel="noopener">如何找回IOTA余额</a>：可以从中了解转账机制与流程</li>
</ul>
</li>
</ul></div><a class="more" href="/the-future-social-formation/#more">阅读更多</a><hr></div><div class="recent-post-item"><a class="article-title" href="/the-jvm-dump-analyse-for-connection-pool-exhausted/">JVM内存分析：数据库连接池耗尽</a><time class="post-meta__date"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2020-06-25</time><span class="post-meta__separator">|</span><time class="post-meta__date"><i class="fa fa-calendar-o" aria-hidden="true"></i> 2019-10-05</time><div class="content"><h2 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h2><p>由于数据库连接十分耗时，采取<strong>即需即连</strong>的方式会导致应用响应缓慢，因此，在Java应用中均采用<strong>数据库连接池</strong>统一维护一定数量的<code>Connection</code>对象，连接池中的<code>Connection</code>均保持与数据库的长连接，这样，该连接将随时可用，从而提高应用响应和处理速度。</p>
<p>但是，在普遍的使用不当的情形中，最多的问题便是没有及时<code>释放连接</code>，这里的释放是指将<code>Connection</code>对象归还连接池。若连接未被释放，则连接池将被很快耗尽（Exhausted），从而无法提供新的连接，最终导致应用不能进行数据库操作，并在尝试获取新的连接时出现以下异常：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Caused by: org.hibernate.exception.GenericJDBCException: Could not open connection</span><br><span class="line">    at org.hibernate.exception.internal.StandardSQLExceptionConverter.convert(StandardSQLExceptionConverter.java:<span class="number">54</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:<span class="number">125</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:<span class="number">110</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.internal.LogicalConnectionImpl.obtainConnection(LogicalConnectionImpl.java:<span class="number">221</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.internal.LogicalConnectionImpl.getConnection(LogicalConnectionImpl.java:<span class="number">157</span>)</span><br><span class="line">    at org.hibernate.internal.SessionImpl.connection(SessionImpl.java:<span class="number">550</span>)</span><br><span class="line">    at org.springframework.orm.hibernate4.HibernateTransactionManager.doBegin(HibernateTransactionManager.java:<span class="number">426</span>)</span><br><span class="line">    ... <span class="number">9</span> more</span><br><span class="line">Caused by: org.apache.commons.dbcp.SQLNestedException: Cannot get a connection, pool error Timeout waiting <span class="keyword">for</span> idle object</span><br><span class="line">    at org.apache.commons.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:<span class="number">114</span>)</span><br><span class="line">    at org.apache.commons.dbcp.BasicDataSource.getConnection(BasicDataSource.java:<span class="number">1044</span>)</span><br><span class="line">    at org.hibernate.service.jdbc.connections.internal.DatasourceConnectionProviderImpl.getConnection(DatasourceConnectionProviderImpl.java:<span class="number">141</span>)</span><br><span class="line">    at org.hibernate.internal.AbstractSessionImpl$NonContextualJdbcConnectionAccess.obtainConnection(AbstractSessionImpl.java:<span class="number">292</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.internal.LogicalConnectionImpl.obtainConnection(LogicalConnectionImpl.java:<span class="number">214</span>)</span><br><span class="line">    ... <span class="number">12</span> more</span><br><span class="line">Caused by: java.util.NoSuchElementException: Timeout waiting <span class="keyword">for</span> idle object</span><br><span class="line">    at org.apache.commons.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:<span class="number">1174</span>)</span><br><span class="line">    at org.apache.commons.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:<span class="number">106</span>)</span><br><span class="line">    ... <span class="number">16</span> more</span><br></pre></td></tr></table></figure></p></div><a class="more" href="/the-jvm-dump-analyse-for-connection-pool-exhausted/#more">阅读更多</a><hr></div><div class="recent-post-item"><a class="article-title" href="/the-jvm-dump-analyse-for-the-thread-dead-lock/">JVM内存分析：线程死锁</a><time class="post-meta__date"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2020-06-25</time><span class="post-meta__separator">|</span><time class="post-meta__date"><i class="fa fa-calendar-o" aria-hidden="true"></i> 2019-10-07</time><div class="content"><h2 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h2><p>线程转储可用于分析Java应用在某一运行时刻的内部线程的运行情况，包括线程数、线程状态（死锁、运行、等待等），并且可得到线程的执行轨迹，对于分析线程死锁十分有益。</p>
<p>通过JDK内置的工具<code>jstack</code>可转储Java线程：<code>sudo -u tomcat jstack -l &lt;java_pid&gt; &gt; jstack.dump</code>，注意，<code>&lt;java_pid&gt;</code>为主进程ID，无法dump某个线程。</p>
<blockquote>
<p>获取Java线程ID：<code>ps aux | grep java</code>；<br>需确保转储用户与线程用户相同，否则，易出现<a href="https://stackoverflow.com/questions/26140182/running-jmap-getting-unable-to-open-socket-file#answer-35963059" target="_blank" rel="noopener">Unable to open socket file: target process not responding or HotSpot VM not loaded</a>的问题；<br>当出现死锁时，dump操作可能失败，可以通过<code>kill -3 &lt;java_pid&gt;</code>终止死锁（其不会杀死进程或线程！）；</p>
</blockquote>
<p>得到转储文件后，可将其上传到<a href="http://fastthread.io/index.jsp" target="_blank" rel="noopener">fastThread</a>进行在线分析，该服务可提供直观的分析图表和相关报告。</p>
<p>也可以下载IBM提供的工具<a href="ftp://public.dhe.ibm.com/software/websphere/appserv/support/tools/jca/jca447.jar" target="_blank" rel="noopener">IBM Thread and Monitor Dump Analyze</a>，其同样提供图表分析功能，但整体上没有fastThread的直观。其启动命令为：<code>java -jar jca447.jar</code>。<br></p></div><a class="more" href="/the-jvm-dump-analyse-for-the-thread-dead-lock/#more">阅读更多</a><hr></div><div class="recent-post-item"><a class="article-title" href="/the-jvm-dump-analyse-for-tomcat-memory-leak/">JVM内存分析：Tomcat内存泄漏</a><time class="post-meta__date"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2020-06-25</time><span class="post-meta__separator">|</span><time class="post-meta__date"><i class="fa fa-calendar-o" aria-hidden="true"></i> 2019-10-04</time><div class="content"><h2 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h2><p>通过内存转储可对Java应用内各对象的内存使用情况进行分析，从而找出过度消耗内存或无法及时释放的对象，进而为异常修复以及提升应用加载速度和运行性能提供帮助。</p>
<p>内存转储使用JDK自带的工具<code>jmap</code>（<code>sudo -u tomcat jmap -dump:format=b,file=heap-dump.bin &lt;java_pid&gt;</code>）将应用内存以二进制格式转储到<code>heap-dump.bin</code>中。</p>
<blockquote>
<p>需确保转储用户与线程用户相同，否则会出现<a href="https://stackoverflow.com/questions/26140182/running-jmap-getting-unable-to-open-socket-file#answer-35963059" target="_blank" rel="noopener">Unable to open socket file: target process not responding or HotSpot VM not loaded</a>的问题；</p>
<p>转储文件可能会被放到临时目录中，该目录会在Tomcat重启时被删除，所以，一定要在重启前将转储文件转移到安全位置；</p>
<p>转储的文件一般为GB级，可通过命令<code>xz -k heap-dump.bin</code>进行高强度压缩，得到压缩文件<code>heap-dump.bin.xz</code>。解压使用命令<code>unxz -k heap-dump.bin.xz</code>，其中，<code>-k</code>选项均表示保留原文件，否则原文件将会被删除；<br></p></blockquote></div><a class="more" href="/the-jvm-dump-analyse-for-tomcat-memory-leak/#more">阅读更多</a><hr></div><div class="recent-post-item"><a class="article-title" href="/the-jvm-dump-analyse-for-where-is-the-memory/">JVM内存分析：内存都去哪儿了</a><time class="post-meta__date"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2020-06-25</time><span class="post-meta__separator">|</span><time class="post-meta__date"><i class="fa fa-calendar-o" aria-hidden="true"></i> 2019-10-05</time><div class="content"><h2 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h2><p>在开始分析之前先了解一下下面几个相关术语：</p>
<ul>
<li><strong>Shallow Heap</strong>：对象自身占用的内存大小（包含基本数据类型），不包括它引用对象的大小；</li>
<li><strong>Retained Heap</strong>：<strong>Shallow Heap</strong> + 所有直接或者间接引用对象占用的内存（即该对象被GC回收后，可以被回收的内存）；</li>
<li><strong>GC Root</strong>：被堆外对象引用的对象；</li>
<li><strong>Dominator Tree</strong>：以支配树方式描述的对象引用关系；</li>
</ul>
<blockquote>
<p>有关JVM内存转储方式的说明见<a href="/the-jvm-dump-analyse-for-tomcat-memory-leak/">JVM内存分析：Tomcat内存泄漏</a>。</p>
</blockquote>
<h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><p>最近服务器的内存又在狂飙了，网关响应缓慢，Jenkins完成构建需要长达2个多小时。到底疯狂到什么程度呢？用<code>htop</code>命令看看：</p>
<p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-high-memory-usage-analysis-via-htop.png" alt><br></p></div><a class="more" href="/the-jvm-dump-analyse-for-where-is-the-memory/#more">阅读更多</a><hr></div><div class="recent-post-item"><a class="article-title" href="/the-software-development-criterion/">软件开发行为准则</a><time class="post-meta__date"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2020-06-25</time><span class="post-meta__separator">|</span><time class="post-meta__date"><i class="fa fa-calendar-o" aria-hidden="true"></i> 2017-12-04</time><div class="content"><blockquote>
<p>The post isn’t finished yet, it will be updated anytime!</p>
</blockquote>
<h2 id="谨慎对待用户隐私"><a href="#谨慎对待用户隐私" class="headerlink" title="谨慎对待用户隐私"></a>谨慎对待用户隐私</h2><p>提要：</p>
<ul>
<li>不是仅用户确认后的数据才算是「用户隐私」，任何与用户相关的数据都应该「默认」视为用户隐私，<u>不需要任何形式的确认</u>，<br>而只有经过用户确认和同意的数据方可用作其他用途，且前提必须是明确告知数据为何要做此用途，以及将被如何利用、涉及哪些风险等</li>
</ul></div><a class="more" href="/the-software-development-criterion/#more">阅读更多</a><hr></div><div class="recent-post-item"><a class="article-title" href="/the-special-case-configuration-of-nginx/">Nginx特例场景配置</a><time class="post-meta__date"><i class="fa fa-calendar-check-o" aria-hidden="true"></i> 2020-06-25</time><span class="post-meta__separator">|</span><time class="post-meta__date"><i class="fa fa-calendar-o" aria-hidden="true"></i> 2018-02-05</time><div class="content"><blockquote>
<p>本文所使用的相关代码片段可从 <a href="https://github.com/flytreeleft/docker-nginx-gateway" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway</a> 得到完整内容。</p>
</blockquote>
<h2 id="Nginx随机展示自定义错误页面"><a href="#Nginx随机展示自定义错误页面" class="headerlink" title="Nginx随机展示自定义错误页面"></a>Nginx随机展示自定义错误页面</h2><blockquote>
<p>Source code: <a href="https://github.com/flytreeleft/docker-nginx-gateway/tree/master/config/error-pages" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway/tree/master/config/error-pages</a><br>Custom error pages: <a href="https://github.com/flytreeleft/docker-nginx-gateway/tree/master/examples/epage.d/all" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway/tree/master/examples/epage.d/all</a></p>
</blockquote>
<p><strong>关键字</strong>：</p>
<ul>
<li>随机展示多个错误页面</li>
<li>Nginx自定义错误页面</li>
</ul>
<p>在访问HTTP站点时最容易出现的错误就是404，于是就有许多非常有个性的404错误页面。而为我们自己的站点放置一些简洁、清爽的错误页面，在资源再利用的前提下，也将为我们自身增加不少好感和亲和力。</p>
<p>这里将要介绍的便是如何为我们的站点配置自定义错误页面，并同时支持为相同错误随机展示不同的错误页面。</p></div><a class="more" href="/the-special-case-configuration-of-nginx/#more">阅读更多</a><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By flytreeleft</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/haoel/anti-baidu/js/anti-baidu-latest.min.js"></script><script src="/js/utils.js?version=1.3"></script><script src="/js/fancybox.js?version=1.3"></script><script src="/js/sidebar.js?version=1.3"></script><script src="/js/copy.js?version=1.3"></script><script src="/js/fireworks.js?version=1.3"></script><script src="/js/transition.js?version=1.3"></script><script src="/js/scroll.js?version=1.3"></script><script src="/js/head.js?version=1.3"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async data-ad-client="ca-pub-6398287269510744"></script></body></html>