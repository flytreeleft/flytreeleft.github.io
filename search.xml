<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>JVM内存分析：线程死锁</title>
      <link href="/the-jvm-dump-analyse-for-the-thread-dead-lock/"/>
      <url>/the-jvm-dump-analyse-for-the-thread-dead-lock/</url>
      
        <content type="html"><![CDATA[<h2 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h2><p>线程转储可用于分析Java应用在某一运行时刻的内部线程的运行情况，包括线程数、线程状态（死锁、运行、等待等），并且可得到线程的执行轨迹，对于分析线程死锁十分有益。</p><p>通过JDK内置的工具<code>jstack</code>可转储Java线程：<code>sudo -u tomcat jstack -l &lt;java_pid&gt; &gt; jstack.dump</code>，注意，<code>&lt;java_pid&gt;</code>为主进程ID，无法dump某个线程。</p><blockquote><p>获取Java线程ID：<code>ps aux | grep java</code>；<br>需确保转储用户与线程用户相同，否则，易出现<a href="https://stackoverflow.com/questions/26140182/running-jmap-getting-unable-to-open-socket-file#answer-35963059" target="_blank" rel="noopener">Unable to open socket file: target process not responding or HotSpot VM not loaded</a>的问题；<br>当出现死锁时，dump操作可能失败，可以通过<code>kill -3 &lt;java_pid&gt;</code>终止死锁（其不会杀死进程或线程！）；</p></blockquote><p>得到转储文件后，可将其上传到<a href="http://fastthread.io/index.jsp" target="_blank" rel="noopener">fastThread</a>进行在线分析，该服务可提供直观的分析图表和相关报告。</p><p>也可以下载IBM提供的工具<a href="ftp://public.dhe.ibm.com/software/websphere/appserv/support/tools/jca/jca447.jar" target="_blank" rel="noopener">IBM Thread and Monitor Dump Analyze</a>，其同样提供图表分析功能，但整体上没有fastThread的直观。其启动命令为：<code>java -jar jca447.jar</code>。<br><a id="more"></a></p><h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><p>以下为某次测试环境出现线程死锁后通过fastThread得到的分析报告内容：</p><p><b><font color="#cc3300">pool-297-thread-25</font></b> is in deadlock with <b><font color="#cc3300">http-nio-8080-exec-548</font></b><br><b><font color="#003300">pool-297-thread-25</font></b> - priority:5 - threadId:0x00007fdf2784f800 - nativeId:0x1474 - state:<b><font color="#cc3300">BLOCKED</font></b><br>stackTrace:<br>java.lang.Thread.State: BLOCKED (on object monitor)<br>at com.mysql.jdbc.ResultSetImpl.fastTimestampCreate(<font color="#000080">ResultSetImpl.java:1062</font>)<br><font color="#cc3300">- waiting to lock <b>&lt;0x000000070618c2c0&gt;</b> (a com.mysql.jdbc.JDBC4Connection)<br>at com.mysql.jdbc.ResultSetRow.getTimestampFast(<font color="#000080">ResultSetRow.java:1393</font>)<br>- locked <b>&lt;0x00000007061996b8&gt;</b> (a java.util.GregorianCalendar)<br></font>at com.mysql.jdbc.BufferRow.getTimestampFast(<font color="#000080">BufferRow.java:576</font>)<br>at com.mysql.jdbc.ResultSetImpl.getTimestampInternal(<font color="#000080">ResultSetImpl.java:6588</font>)<br>at com.mysql.jdbc.ResultSetImpl.getTimestamp(<font color="#000080">ResultSetImpl.java:6188</font>)<br>at com.mysql.jdbc.ResultSetImpl.getTimestamp(<font color="#000080">ResultSetImpl.java:6226</font>)<br>at org.apache.commons.dbcp.DelegatingResultSet.getTimestamp(<font color="#000080">DelegatingResultSet.java:300</font>)<br>at org.apache.commons.dbcp.DelegatingResultSet.getTimestamp(<font color="#000080">DelegatingResultSet.java:300</font>)<br>at org.apache.commons.dbcp.DelegatingResultSet.getTimestamp(<font color="#000080">DelegatingResultSet.java:300</font>)<br>at org.hibernate.type.descriptor.sql.TimestampTypeDescriptor$2.doExtract(<font color="#000080">TimestampTypeDescriptor.java:67</font>)<br>at ...<br>at org.hibernate.loader.Loader.loadFromResultSet(<font color="#000080">Loader.java:1673</font>)<br>at ...<br>at org.hibernate.internal.SessionImpl.fireLoad(<font color="#000080">SessionImpl.java:1098</font>)<br>at org.hibernate.internal.SessionImpl.immediateLoad(<font color="#000080">SessionImpl.java:1013</font>)<br>at org.hibernate.proxy.AbstractLazyInitializer.initialize(<font color="#000080">AbstractLazyInitializer.java:173</font>)<br>at <font color="#ff0000">org.hibernate.proxy.AbstractLazyInitializer</font>.getImplementation(<font color="#000080">AbstractLazyInitializer.java:285</font>)<br>at org.hibernate.proxy.pojo.javassist.JavassistLazyInitializer.invoke(<font color="#000080">JavassistLazyInitializer.java:185</font>)<br>at com.xx.zz.model.User_$$_jvst8ac_ac.equals(<font color="#000080">User_$$_jvst8ac_ac.java</font>)<br>at java.util.Vector.indexOf(<font color="#000080">Vector.java:408</font>)<br>- locked <b>&lt;0x000000070624bc10&gt;</b> (a java.util.Stack)<br>at java.util.Vector.contains(<font color="#000080">Vector.java:367</font>)<br>at com.xx.zz.json.JSONWriter.value(<font color="#000080">Unknown Source</font>)<br>at com.xx.zz.json.JSONWriter.appendProp(<font color="#000080">Unknown Source</font>)<br>at com.xx.zz.json.JSONWriter.bean(<font color="#000080">Unknown Source</font>)<br>at com.xx.zz.json.JSONWriter.doValue(<font color="#000080">Unknown Source</font>)<br>at com.xx.zz.json.JSONWriter.value(<font color="#000080">Unknown Source</font>)<br>at com.xx.zz.json.JSONWriter.write(<font color="#000080">Unknown Source</font>)<br>at com.xx.zz.json.JSONUtil.serialize(<font color="#000080">Unknown Source</font>)<br>at com.xx.zz.slm.OlaEngine.getJsonObejct(<font color="#000080">OlaEngine.java:191</font>)<br>at com.xx.zz.slm.OlaEngine.startMonitor(<font color="#000080">OlaEngine.java:61</font>)<br>at <font color="#ff0000">com.xx.zz.slm.manager.XxxThreadPoolManager$1.run</font>(<font color="#000080">XxxThreadPoolManager.java:68</font>)<br>- locked <b>&lt;0x000000070624bcb0&gt;</b> (a com.xx.zz.slm.manager.XxxThreadPoolManager$1)<br>at java.util.concurrent.ThreadPoolExecutor.runWorker(<font color="#000080">ThreadPoolExecutor.java:1142</font>)<br>at java.util.concurrent.ThreadPoolExecutor$Worker.run(<font color="#000080">ThreadPoolExecutor.java:617</font>)<br>at java.lang.Thread.run(<font color="#000080">Thread.java:745</font>)<br>Locked ownable synchronizers:<br>- <b>&lt;0x0000000706073548&gt;</b> (a java.util.concurrent.ThreadPoolExecutor$Worker)<br><br><b><font color="#003300">http-nio-8080-exec-548</font></b> - priority:5 - threadId:0x00007fe02c00c000 - nativeId:0x146e - state:<b><font color="#cc3300">BLOCKED</font></b><br>stackTrace:<br>java.lang.Thread.State: BLOCKED (on object monitor)<br>at com.mysql.jdbc.PreparedStatement.setTimestampInternal(<font color="#000080">PreparedStatement.java:4819</font>)<br><font color="#cc3300">- waiting to lock <b>&lt;0x00000007061996b8&gt;</b> (a java.util.GregorianCalendar)<br>- locked <b>&lt;0x000000070618c2c0&gt;</b> (a com.mysql.jdbc.JDBC4Connection)<br></font>at com.mysql.jdbc.PreparedStatement.setTimestamp(<font color="#000080">PreparedStatement.java:4786</font>)<br>at org.apache.commons.dbcp.DelegatingPreparedStatement.setTimestamp(<font color="#000080">DelegatingPreparedStatement.java:147</font>)<br>at org.apache.commons.dbcp.DelegatingPreparedStatement.setTimestamp(<font color="#000080">DelegatingPreparedStatement.java:147</font>)<br>at org.apache.commons.dbcp.DelegatingPreparedStatement.setTimestamp(<font color="#000080">DelegatingPreparedStatement.java:147</font>)<br>at org.hibernate.type.descriptor.sql.TimestampTypeDescriptor$1.doBind(<font color="#000080">TimestampTypeDescriptor.java:58</font>)<br>at ...<br>at org.hibernate.persister.entity.AbstractEntityPersister.update(<font color="#000080">AbstractEntityPersister.java:3205</font>)<br>at ...<br>at org.hibernate.event.internal.DefaultFlushEventListener.onFlush(<font color="#000080">DefaultFlushEventListener.java:52</font>)<br>at <font color="#ff0000">org.hibernate.internal.SessionImpl</font>.flush(<font color="#000080">SessionImpl.java:1240</font>)<br>at <font color="#ff0000">com.xx.zz.StartProcessInstanceListener</font>.onEvent(<font color="#000080">StartProcessInstanceListener.java:114</font>)<br>at ...<br>at com.xx.zz.activiti.cmd.SuperCompleteTaskCmd.execute(<font color="#000080">SuperCompleteTaskCmd.java:68</font>)<br>at ...<br>at com.xx.zz.activiti.BaseActivitiTaskService.completeTask(<font color="#000080">BaseActivitiTaskService.java:82</font>)<br>at com.xx.zz.BusinessProcessServiceImpl.completeTask(<font color="#000080">BusinessProcessServiceImpl.java:313</font>)<br>at ...<br>at com.sun.proxy.$Proxy1859.completeTask(<font color="#000080">Unknown Source</font>)<br>at com.xx.zz.BaseController.completeTask(<font color="#000080">BaseController.java:216</font>)<br>at <font color="#ff0000">com.xx.zz.CompleteTask.execute</font>(<font color="#000080">CompleteTask.java:57</font>)<br>at ...<br>at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(<font color="#000080">AbstractProtocol.java:802</font>)<br>at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(<font color="#000080">NioEndpoint.java:1410</font>)<br>at org.apache.tomcat.util.net.SocketProcessorBase.run(<font color="#000080">SocketProcessorBase.java:49</font>)<br>- locked <b>&lt;0x000000070624fcb0&gt;</b> (a org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper)<br>at java.util.concurrent.ThreadPoolExecutor.runWorker(<font color="#000080">ThreadPoolExecutor.java:1142</font>)<br>at java.util.concurrent.ThreadPoolExecutor$Worker.run(<font color="#000080">ThreadPoolExecutor.java:617</font>)<br>at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(<font color="#000080">TaskThread.java:61</font>)<br>at java.lang.Thread.run(<font color="#000080">Thread.java:745</font>)<br>Locked ownable synchronizers:<br>- <b>&lt;0x0000000705c194b0&gt;</b> (a java.util.concurrent.ThreadPoolExecutor$Worker)<br></p><p>报告第一行即说明了<code>pool-297-thread-25</code>与<code>http-nio-8080-exec-548</code>两个线程出现了竞争死锁，前者已经锁住<code>&lt;0x00000007061996b8&gt; (a java.util.GregorianCalendar)</code>并正在尝试锁住<code>&lt;0x000000070618c2c0&gt; (a com.mysql.jdbc.JDBC4Connection)</code>，而后者已经锁住相同（内存地址相同）的JDBC Connection，并试图对<code>&lt;0x00000007061996b8&gt; (a java.util.GregorianCalendar)</code>加锁，因此，两者持锁等待，结果出现了死锁！</p><p>下面来分析一下两个线程在何时因为什么而发生了死锁。</p><p>线程<code>pool-297-thread-25</code>正在对某个BO（业务模型）做与监控相关的处理，并使用<code>JSONWriter</code>序列化该BO，由于Hibernate的懒加载特性，<code>AbstractLazyInitializer</code>还需要从数据库中获取级联对象的数据，并最终在获取JDBC时间戳时出现了资源竞争。</p><p>而线程<code>http-nio-8080-exec-548</code>是一个HTTP请求/响应线程，其负责处理流程任务的完成操作，其在尝试更新JDBC时间戳时先于前一个线程对JDBC Connection加锁成功，却未能锁住<code>GregorianCalendar</code>。</p><p>根据Hibernate的特性以及懒加载所带来的副作用不受重视的现实进行分析，可以大致还原出整个处理过程：</p><ul><li>用户点击了任务完成按钮，应用也已经完成了对该任务的处理，并正在创建下一个任务实例；</li><li>OLA（运营级别协议）的逻辑需要监听流程任务的创建事件，以便于及时得到相关的BO信息并做相关业务处理；</li><li>流程任务创建事件触发后，OLA先在任务创建的Listener中获取到BO对象，再将该BO对象放到OLA监控器中；</li><li>OLA监控器会启动新的线程（由线程池分配和调度），并在线程中序列化该BO对象，进而做存储或其他事情；</li><li>这里存在两个线程：任务创建线程（<code>http-nio-8080-exec-548</code>）和OLA监控线程（<code>pool-297-thread-25</code>）；</li><li>而由于懒加载的缘故，BO的级联对象将继续持有查询时所使用的Session实例，而该Session在HTTP请求线程中将被独占使用，相应的JDBC Connection也是被独占的；</li><li>因此，JDBC Connection的共享导致了死锁；</li></ul><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>针对上述问题，根本的解决方案就是：</p><ul><li>流程任务创建时，仅将与BO相关的id和类型传递给OLA监控器；</li><li>OLA监控器在所创建的线程内独自创建Hibernate Session（注意用后释放），再根据BO的id和类型查询所需信息；</li></ul><p>因此，需牢记接口数据的交互原则：</p><ul><li>拒绝共享；</li><li>仅交换Plain数据（非对象、非结构），即核心基础数据，其他业务数据通过基础数据获取；</li></ul>]]></content>
      
      
      <categories>
          
          <category> JVM内存分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 线程死锁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内存都去哪儿了</title>
      <link href="/the-jvm-dump-analyse-for-where-is-the-memory/"/>
      <url>/the-jvm-dump-analyse-for-where-is-the-memory/</url>
      
        <content type="html"><![CDATA[<h2 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h2><p>在开始分析之前先了解一下下面几个相关术语：</p><ul><li><strong>Shallow Heap</strong>：对象自身占用的内存大小（包含基本数据类型），不包括它引用对象的大小；</li><li><strong>Retained Heap</strong>：<strong>Shallow Heap</strong> + 所有直接或者间接引用对象占用的内存（即该对象被GC回收后，可以被回收的内存）；</li><li><strong>GC Root</strong>：被堆外对象引用的对象；</li><li><strong>Dominator Tree</strong>：以支配树方式描述的对象引用关系；</li></ul><blockquote><p>有关JVM内存转储方式的说明见<a href="/the-jvm-dump-analyse-for-tomcat-memory-leak/">JVM内存分析：Tomcat内存泄漏</a>。</p></blockquote><h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><p>最近服务器的内存又在狂飙了，网关响应缓慢，Jenkins完成构建需要长达2个多小时。到底疯狂到什么程度呢？用<code>htop</code>命令看看：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-high-memory-usage-analysis-via-htop.png" alt><br><a id="more"></a></p><p>不仅64G内存几乎耗尽，还占用了大量的交换分区空间（也就是虚拟内存），实在异常恐怖！</p><p>再查看哪些进程耗用内存较多，结果发现都是Docker容器内的应用进程消耗最多。那使用命令<code>docker stats --format &quot;table {{.Name}}\t{{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}&quot;</code>看看各个容器的内存使用情况：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-high-memory-usage-of-docker-apps.png" alt></p><p>从使用情况来看，有多个应用容器的内存使用量在5GB以上，而且部分应用实际上并没有什么耗内存的地方，却也占用了5GB，实在是不可理喻。</p><p>没有办法了，只能dump出应用的堆内存，再详细分析内存都消耗在哪些对象上了。</p><p>在容器内运行命令<code>sudo -u tomcat jmap -dump:format=b,file=heap-dump.bin &lt;java_pid&gt;</code>将Tomcat进程的堆内存转储至<code>heap-dump.bin</code>中。</p><p>转储完成后，通过<a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">Eclipse Memory Analyzer - MAT</a>自带的工具<code>ParseHeapDump.sh</code>分析堆内存（也同时分析其中的<code>unreachable</code>对象以得到对象内部数据）：<code>ParseHeapDump.sh -keep_unreachable_objects heap-dump.bin</code>。</p><p>最后，启动MAT并点击菜单<code>File -&gt; Open Heap Dump</code>选择文件<code>heap-dump.bin</code>，得到如下结果：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-heap-dump-overview-in-mat.png" alt></p><p>结果很出乎意料：<code>int[]</code>数组居然占用了数十兆内存，总计占了1/4！</p><p>接着看看直方图（<code>Histogram</code>），注意需将结果按<code>Shallow Heap</code>降序排序：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-heap-dump-histogram-in-mat.png" alt></p><p>这更是惊人：<code>int[]</code>数据总共为<code>505,211,152</code>字节，也就是<code>481MB</code>！</p><p>惊讶继续！</p><p>右键点击<code>int[]</code>并选择<code>List objects -&gt; with incoming references</code>（PS：同样按<code>Shallow Heap</code>降序排序）：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-heap-dump-incoming-references-of-int-in-mat.png" alt></p><p>从<code>incoming references</code>中可以发现以下问题：</p><ul><li>几乎所有的<code>int[]</code>都是<code>unreachable</code>的；</li><li>靠前的<code>int[]</code>长度都达到数十万，甚至百万、千万；</li></ul><p>那么，问题来了：</p><ul><li>谁创建了这么多且这么大的数组，又为何创建？</li><li>数组里存的是什么数据，干什么用的？</li></ul><p>第一个问题没有可解答的线索，因为查不到引用这些数组的对象。不过从第二个问题中应该能找寻到一些蛛丝马迹。</p><p>在<code>incoming references</code>中右键点击第一条并选择<code>Copy -&gt; Save Value To File</code>，将数组内的数据保存到文件<code>int-bytes.bin</code>中。</p><p>因为得到的文件为二进制的，故需使用工具<a href="https://linux.die.net/man/1/hexedit" target="_blank" rel="noopener">hexedit</a>查看其内容（PS：也可用其他二进制查看工具）。</p><p>打开文件后向下翻页直至右侧出现有大量连续可识别的字符为止：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-binary-view-to-chars-in-hexedit.png" alt></p><p>截取其中的一段内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">002CEEA8   00 00 00 00  00 00 00 00  00 00 00 01  00 00 00 00  F8 00 00 ED  00 00 00 3A  41 54 45 4D  46 4E 49 2D  72 65 73 2F  65 63 69 76  .......................:ATEMFNI-res/eciv</span><br><span class="line">002CEED0   61 6A 2F 73  2E 78 61 76  2E 6C 6D 78  73 72 61 70  2E 73 72 65  75 63 6F 44  74 6E 65 6D  6C 69 75 42  46 72 65 64  6F 74 63 61  aj/s.xav.lmxsrap.sreucoDtnemliuBFredotca</span><br><span class="line">002CEEF8   00 00 79 72  00 00 00 00  00 00 00 01  00 00 00 00  F8 00 00 3F  00 00 00 3A  00 45 00 4D  00 41 00 54  00 49 00 2D  00 46 00 4E  ..yr...............?...:.E.M.A.T.I.-.F.N</span><br><span class="line">002CEF20   00 73 00 2F  00 72 00 65  00 69 00 76  00 65 00 63  00 2F 00 73  00 61 00 6A  00 61 00 76  00 2E 00 78  00 6D 00 78  00 2E 00 6C  .s./.r.e.i.v.e.c./.s.a.j.a.v...x.m.x...l</span><br><span class="line">002CEF48   00 61 00 70  00 73 00 72  00 72 00 65  00 2E 00 73  00 6F 00 44  00 75 00 63  00 65 00 6D  00 74 00 6E  00 75 00 42  00 6C 00 69  .a.p.s.r.r.e...s.o.D.u.c.e.m.t.n.u.B.l.i</span><br><span class="line">002CEF70   00 65 00 64  00 46 00 72  00 63 00 61  00 6F 00 74  00 79 00 72  00 00 00 00  00 00 00 01  00 00 00 00  F8 00 00 ED  00 00 00 AE  .e.d.F.r.c.a.o.t.y.r....................</span><br><span class="line">002CEF98   41 54 45 4D  46 4E 49 2D  72 65 73 2F  65 63 69 76  61 6A 2F 73  2E 78 61 76  2E 6C 6D 78  73 72 61 70  2E 73 72 65  75 63 6F 44  ATEMFNI-res/ecivaj/s.xav.lmxsrap.sreucoD</span><br><span class="line">002CEFC0   74 6E 65 6D  6C 69 75 42  46 72 65 64  6F 74 63 61  00 00 79 72  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  tnemliuBFredotca..yr....................</span><br></pre></td></tr></table></figure><p>这里会发现一个问题：这些字符看起来很有规律，感觉很熟悉但却又很陌生。</p><p>不过仔细辨别还是可以发现：每四个相邻字符反序再组合也就能够还原出正确的字符串。比如，截图中便可识别出一串字符：<code>META-INF/services/javax.xml.parsers.DocumentBuilderFactory</code>。</p><p>为什么转存的二进制文件会出现字符串反序呢？其实，这便是著名的<a href="http://www.ruanyifeng.com/blog/2016/11/byte-order.html" target="_blank" rel="noopener">大小端</a>字节序。而该文件正好为<strong>小端字节序</strong>（低位字节在前，高位字节在后），和人类的读写顺序（大端字节序）正好相反。</p><p>有点「反人类」了。</p><p>为了确保能正常识别<code>int[]</code>中存储的内容，我们需要将小端字节序转换为大端字节序。</p><p>不幸的是，没能找到直接可用的大小端转换工具，于是拿起遗忘已久的<strong>C语言</strong>编写以下一段代码来进行转换：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// https://stackoverflow.com/questions/2182002/convert-big-endian-to-little-endian-in-c-without-using-provided-func#answer-2637138</span></span><br><span class="line"><span class="keyword">uint32_t</span> swap_uint32( <span class="keyword">uint32_t</span> val ) &#123;</span><br><span class="line">    val = ((val &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xFF00FF00</span> ) | ((val &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00FF</span> );</span><br><span class="line">    <span class="keyword">return</span> (val &lt;&lt; <span class="number">16</span>) | (val &gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *in = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">char</span> *out = argv[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    FILE *file_in = fopen(in, <span class="string">"r"</span>);</span><br><span class="line">    FILE *file_out = fopen(out, <span class="string">"w"</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_in == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"File '%s' not found!\n"</span>, in);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"Reading from '%s'\n"</span>, in);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> value;</span><br><span class="line">    <span class="keyword">while</span> (fread(&amp;value, <span class="keyword">sizeof</span>(value), <span class="number">1</span>, file_in) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> new_value = swap_uint32(value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fwrite(&amp;new_value, <span class="keyword">sizeof</span>(new_value), <span class="number">1</span>, file_out) != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to write to file '%s'!\n"</span>, out);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"[DONE] Write to '%s'\n"</span>, out);</span><br><span class="line"></span><br><span class="line">    fclose(file_out);</span><br><span class="line">    fclose(file_in);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<strong>GCC</strong>编译（<code>gcc -o swap-endian main.c</code>）并运行<code>swap-endian</code>以转换大小端：<code>./swap-endian ./int-bytes.bin ./int-bytes.bin.swap</code>。</p><p>然后，再用<code>hexedit</code>打开<code>int-bytes.bin.swap</code>并按组合键<code>Ctrl+G</code>跳转到刚才查看的位置。这下字符顺序终于正常了：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-binary-view-to-normal-chars-in-hexedit.png" alt></p><p>反序问题解决了，接下来就来擦亮眼睛去发现<code>int[]</code>中都有些什么吧。</p><p>最后从该数组中发现其包含了以下一些字符串：</p><ul><li><code>jar:file:/xxx/xxx/xxx.jar</code></li><li><code>META-INF/services/xxx.xxx.XxxXX</code></li><li><code>/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/xerces.properties</code></li><li><code>com/sun/org/apache/xpath/internal/jaxp/XPathFactoryImpl.class</code></li><li><code>org/activiti/db/mapping/entity/Task.xml</code>（及其内容）、<code>org.activiti.engine.impl.TablePageMap.class</code></li><li><code>jar:file:/xxx/xxx/WEB-INF/lib/xercesImpl-2.6.2.jar!/META-INF/services/javax.xml.parsers.DocumentBuilderFactory</code></li></ul><p>有什么发现没？反正我是感觉这可能是<code>ClassLoader</code>的内容或者与此相关的某些东西。而且这些也不是业务对象数据，基本都是<code>*.class</code>、<code>*.java</code>以及<u><code>jar</code>中的资源文件</u>的名称和内容，那这就和应用本身没啥关系了，问题出在JVM层面的可能性更大。</p><p>如果是这样，那为何会出现这样的问题呢？</p><p>我也是茫然无知，多番假设和验证后也没有结果，最后，只得Google了一下关键字<code>java big int array unreachable</code>，并从<a href="https://stackoverflow.com/questions/11772512/java-string-objects-not-getting-garbage-collected-on-time" target="_blank" rel="noopener">Java String objects not getting garbage collected on time</a>中找到了些线索：</p><ul><li><code>This means the VM will eat memory until it hits the maximum and then, it will do one huge GC run</code>：即，<u>Java GC的开销很大（<code>evil</code>），因此其会尽可能多地使用内存直到超过最大限定值，非万不得已不会主动GC</u></li><li><code>Unless you see OutOfMemoryException, you don&#39;t have a leak</code>：即，<u>如果没有抛出<code>OutOfMemoryException</code>异常，那么就不会是内存泄漏，那怕是内存被全部耗尽</u></li><li><code>However when we inspect these char[], Strings we find that they do not have GC roots which means that they shouldn&#39;t be the cause of leak. Since they are a part of heap, it means they are waiting to get garbage collected</code>：即，<u><code>Unreachable</code>对象不会引发内存泄漏，其属于堆内数据，正等待被垃圾回收</u></li></ul><p>联系实际情况：在Docker镜像构建配置中，Tomcat的启动脚本并未设置JVM的堆大小，而且从长时间的观察来看，容器的内存消耗会随时间逐步增长，并且在多次数据查询后内存使用也是会直线增长。再结合以上线索，便可初步确定这是JVM没有GC造成的。</p><p>按照以上思路，为Tomcat启动脚本设置JVM堆内存的最大值和初始值，再重启并运行一段时候后发现容器的内存使用情况趋于正常，静默下的内存消耗降至百兆，有数据查询时内存使用会上升到1GB左右，并在没有数据查询时出现回落：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-goto-normal-memory-usage-of-docker-apps.png" alt></p><p>内存使用也回归正常：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-normal-memory-usage-analysis-via-htop.png" alt></p><p>看来问题还真就是出在JVM的GC机制上，悬了长久的问题终于得到解决。</p><p>这里不禁要感叹：</p><p><span style="font-size: 2em; color: red">原来你是这样的Java！！</span></p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>对症下药，调整Docker镜像的<code>entrypoint</code>脚本为如下内容（PS：非全部内容，需根据实际情况调整）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在JDK8以前的版本中需将“-XX:MetaspaceSize=512m -XX:MaxMetaspaceSize=512m”改为“-XX:PermSize=512m -XX:MaxPermSize=512m”</span></span><br><span class="line">java -Dcatalina.base=<span class="variable">$&#123;TOMCAT_BASE&#125;</span> \</span><br><span class="line">     -Dcatalina.home=<span class="variable">$&#123;TOMCAT_HOME&#125;</span> \</span><br><span class="line">     -Dwtp.deploy=<span class="variable">$&#123;TOMCAT_BASE&#125;</span> \</span><br><span class="line">     -Djava.util.prefs.userRoot=<span class="variable">$&#123;JAVA_USER_PREFS&#125;</span> \</span><br><span class="line">     -Djava.endorsed.dirs=<span class="variable">$&#123;TOMCAT_HOME&#125;</span>/endorsed \</span><br><span class="line">     -Djava.util.logging.config.file=<span class="variable">$&#123;TOMCAT_BASE&#125;</span>/conf/logging.properties \</span><br><span class="line">     -Dfile.encoding=UTF-8 \</span><br><span class="line">     -server \</span><br><span class="line">     -Xms1G -Xmx1G \</span><br><span class="line">     -XX:MetaspaceSize=512m -XX:MaxMetaspaceSize=512m \</span><br><span class="line">     -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="variable">$&#123;TOMCAT_HOME&#125;</span>/memdump.hprof \</span><br><span class="line">     -XX:+PrintGCDetails -XX:+PrintGCCause -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps \</span><br><span class="line">     -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=10M -Xloggc:<span class="variable">$&#123;TOMCAT_HOME&#125;</span>/gc.log \</span><br><span class="line">     -classpath <span class="variable">$&#123;TOMCAT_HOME&#125;</span>/bin/bootstrap.jar:<span class="variable">$&#123;TOMCAT_HOME&#125;</span>/bin/tomcat-juli.jar:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib/tools.jar \</span><br><span class="line">     org.apache.catalina.startup.Bootstrap start</span><br></pre></td></tr></table></figure><blockquote><p>对Tomcat调整Java参数，需新增或编辑文件<code>${TOMCAT_HOME}/bin/setenv.sh</code>，并按<a href="#TOMCAT-HOME-bin-setenv-sh">这里</a>的内容调整环境变量<code>JAVA_OPTS</code>的值。</p></blockquote><p>在以上脚本中还指定了出现<strong>OOM</strong>时的堆转储文件以及<a href="https://confluence.atlassian.com/confkb/how-to-enable-garbage-collection-gc-logging-300813751.html" target="_blank" rel="noopener">GC日志</a>的存储位置。</p><p>获取到GC日志后可以通过在线工具<a href="http://gceasy.io/" target="_blank" rel="noopener">GCeasy</a>分析JVM的GC情况。注意：在生产环境中也应该设置<strong>OOM</strong>时的堆转储文件以便于分析内存溢出问题。</p><p>注意，以上内容并不一定是最佳设置，需根据实际情况进行调整，如果存在以下情况，可尝试适当增加<code>-Xms</code>（初始堆内存）和<code>-Xmx</code>（最大堆内存）的值：</p><ul><li>应用需要加载大量的Class；</li><li>应用运行期间需要创建大量对象或在数组中存放大量数据；</li><li>从GC日志中发现进行GC的频率较高、间隔较短；</li></ul><blockquote><p>通过<a href="http://gceasy.io/" target="_blank" rel="noopener">GCeasy</a>也可以得到很好的改进建议；<br>堆内存分配过大会导致一次GC的耗时增加，而GC操作会挂起应用，因此，不可盲目设置过大值；</p></blockquote><p>GC日志行的格式说明如下（<a href="https://plumbr.io/blog/garbage-collection/understanding-garbage-collection-logs" target="_blank" rel="noopener">Understanding Garbage Collection Logs</a>）：</p><p><img src="/assets/images/jvm-dump/where-is-the-memory/jvm-no-gc-for-gc-log-line-information.png" alt></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">Eclipse Memory Analyzer - MAT</a></li><li><a href="https://stackoverflow.com/questions/11772512/java-string-objects-not-getting-garbage-collected-on-time" target="_blank" rel="noopener">Java String objects not getting garbage collected on time</a></li><li><a href="https://stackoverflow.com/questions/14763079/what-are-the-xms-and-xmx-parameters-when-starting-jvms" target="_blank" rel="noopener">What are the Xms and Xmx parameters when starting JVMs?</a></li><li><a href="http://www.infoq.com/cn/articles/Troubleshooting-Java-Memory-Issues" target="_blank" rel="noopener">排查Java的内存问题</a></li><li><a href="https://www.cnblogs.com/whgw/archive/2011/09/29/2194997.html" target="_blank" rel="noopener">Java中堆内存和栈内存详解</a></li><li><a href="https://confluence.atlassian.com/confkb/how-to-enable-garbage-collection-gc-logging-300813751.html" target="_blank" rel="noopener">How to Enable Garbage Collection (GC) Logging</a></li><li><a href="https://plumbr.io/blog/garbage-collection/understanding-garbage-collection-logs" target="_blank" rel="noopener">Understanding Garbage Collection Logs</a>：解释<code>GC (Allocation Failure)</code>行的格式</li><li><a href="http://lousama.com/2016/03/11/jvm%E8%B0%83%E4%BC%98%E7%BB%8F%E9%AA%8C/" target="_blank" rel="noopener">JVM调优经验</a></li><li><a href="http://www.howardliu.cn/java/jvm-tuning-basic/" target="_blank" rel="noopener">JVM参数优化（基础篇）</a></li></ul><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="TOMCAT-HOME-bin-setenv-sh"><a href="#TOMCAT-HOME-bin-setenv-sh" class="headerlink" title="${TOMCAT_HOME}/bin/setenv.sh"></a>${TOMCAT_HOME}/bin/setenv.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -Dfile.encoding=UTF-8"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prevent to occur the error 'java.lang.NoClassDefFoundError: Could not initialize class javax.imageio.ImageIO'</span></span><br><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -Djava.awt.headless=true -Dawt.toolkit=sun.awt.HToolkit"</span></span><br><span class="line"></span><br><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -server"</span></span><br><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -Xms1G -Xmx1G"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PermGen for JDK7, JDK6</span></span><br><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -XX:PermSize=512m -XX:MaxPermSize=512m"</span></span><br><span class="line"><span class="comment"># PermGen for JDK8+</span></span><br><span class="line"><span class="comment">#JAVA_OPTS="$JAVA_OPTS -XX:MetaspaceSize=512m -XX:MaxMetaspaceSize=512m"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Print heap dump log</span></span><br><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="variable">$&#123;CATALINA_HOME&#125;</span>/memdump.hprof"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Print GC log</span></span><br><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -XX:+PrintGCDetails -XX:+PrintGCCause -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps"</span></span><br><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=10M"</span></span><br><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -Xloggc:<span class="variable">$&#123;CATALINA_HOME&#125;</span>/gc.log"</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JVM内存分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内存溢出 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据库连接池耗尽</title>
      <link href="/the-jvm-dump-analyse-for-connection-pool-exhausted/"/>
      <url>/the-jvm-dump-analyse-for-connection-pool-exhausted/</url>
      
        <content type="html"><![CDATA[<h2 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h2><p>由于数据库连接十分耗时，采取<strong>即需即连</strong>的方式会导致应用响应缓慢，因此，在Java应用中均采用<strong>数据库连接池</strong>统一维护一定数量的<code>Connection</code>对象，连接池中的<code>Connection</code>均保持与数据库的长连接，这样，该连接将随时可用，从而提高应用响应和处理速度。</p><p>但是，在普遍的使用不当的情形中，最多的问题便是没有及时<code>释放连接</code>，这里的释放是指将<code>Connection</code>对象归还连接池。若连接未被释放，则连接池将被很快耗尽（Exhausted），从而无法提供新的连接，最终导致应用不能进行数据库操作，并在尝试获取新的连接时出现以下异常：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Caused by: org.hibernate.exception.GenericJDBCException: Could not open connection</span><br><span class="line">    at org.hibernate.exception.internal.StandardSQLExceptionConverter.convert(StandardSQLExceptionConverter.java:<span class="number">54</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:<span class="number">125</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:<span class="number">110</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.internal.LogicalConnectionImpl.obtainConnection(LogicalConnectionImpl.java:<span class="number">221</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.internal.LogicalConnectionImpl.getConnection(LogicalConnectionImpl.java:<span class="number">157</span>)</span><br><span class="line">    at org.hibernate.internal.SessionImpl.connection(SessionImpl.java:<span class="number">550</span>)</span><br><span class="line">    at org.springframework.orm.hibernate4.HibernateTransactionManager.doBegin(HibernateTransactionManager.java:<span class="number">426</span>)</span><br><span class="line">    ... <span class="number">9</span> more</span><br><span class="line">Caused by: org.apache.commons.dbcp.SQLNestedException: Cannot get a connection, pool error Timeout waiting <span class="keyword">for</span> idle object</span><br><span class="line">    at org.apache.commons.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:<span class="number">114</span>)</span><br><span class="line">    at org.apache.commons.dbcp.BasicDataSource.getConnection(BasicDataSource.java:<span class="number">1044</span>)</span><br><span class="line">    at org.hibernate.service.jdbc.connections.internal.DatasourceConnectionProviderImpl.getConnection(DatasourceConnectionProviderImpl.java:<span class="number">141</span>)</span><br><span class="line">    at org.hibernate.internal.AbstractSessionImpl$NonContextualJdbcConnectionAccess.obtainConnection(AbstractSessionImpl.java:<span class="number">292</span>)</span><br><span class="line">    at org.hibernate.engine.jdbc.internal.LogicalConnectionImpl.obtainConnection(LogicalConnectionImpl.java:<span class="number">214</span>)</span><br><span class="line">    ... <span class="number">12</span> more</span><br><span class="line">Caused by: java.util.NoSuchElementException: Timeout waiting <span class="keyword">for</span> idle object</span><br><span class="line">    at org.apache.commons.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:<span class="number">1174</span>)</span><br><span class="line">    at org.apache.commons.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:<span class="number">106</span>)</span><br><span class="line">    ... <span class="number">16</span> more</span><br></pre></td></tr></table></figure></p><a id="more"></a><h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><blockquote><p>有关JVM内存转储方式的说明见<a href="/the-jvm-dump-analyse-for-tomcat-memory-leak/">JVM内存分析：Tomcat内存泄漏</a>。</p></blockquote><p>在本案例应用（约定称为「应用A」）的使用过程中偶尔会在前端弹出<code>Timeout waiting for idle object</code>的异常提示框。经过查看完整的异常堆栈（看上面）可发现，异常发生在从连接池获取<code>Connection</code>时，在对<a href="https://github.com/apache/commons-pool/blob/POOL_1_6/src/java/org/apache/commons/pool/impl/GenericObjectPool.java#L1174" target="_blank" rel="noopener">GenericObjectPool</a>源码分析后可初步确定是因为连接池已满而无法分配新的<code>Connection</code>造成的。</p><p>为进一步确认该问题，将应用A的内存转储（<code>sudo -u tomcat jmap -dump:format=b,file=heap-dump.bin &lt;java_pid&gt;</code>）并通过<a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">Eclipse Memory Analyzer - MAT</a>对其内存进行分析。</p><p>点击工具栏中的<code>OQL</code>图标，这里需要通过<a href="https://www.ibm.com/developerworks/library/j-memoryanalyzer/#N103C9" target="_blank" rel="noopener">OQL</a>进行一些复杂的过滤查询（OQL：<code>SELECT OBJECTS ds FROM org.apache.commons.dbcp.BasicDataSource ds</code>）：</p><p><img src="/assets/images/jvm-dump/connection-pool-exhausted/java-memory-leak-oql-instanceof-basicdatasource-in-heap-dump.png" alt></p><blockquote><ul><li>OQL的语法可从MAT的<code>Help -&gt; Help Contents</code>菜单中进入帮助手册查询到；</li><li><code>org.apache.commons.dbcp.BasicDataSource</code>为应用中使用的<code>DataSource</code>的实现类，其内部引用<code>org.apache.commons.dbcp.PoolingDataSource</code>，并在<code>PoolingDataSource</code>中负责从连接池申请新的连接；</li></ul></blockquote><p>从图中可以看到，连接池<code>org.apache.commons.pool.impl.GenericObjectPool</code>的<code>_numActive</code>为<span style="color: red;">749</span>，而在应用中为其分配的最大活跃连接数（<code>maxActive</code>）为<code>750</code>。因此，可以进一步确定连接池的确已达到分配上限，在并发情况下将不会再分配更多连接，从而导致等待超时并抛出异常。</p><p>再看看内存中是否存在未被释放的MySQL连接。</p><p>由于MAT默认不分析<code>unreachable</code>对象，所以，在开始前需通过其自带的工具<code>ParseHeapDump.sh</code>（或<code>ParseHeapDump.bat</code>）<a href="https://wiki.eclipse.org/MemoryAnalyzer/FAQ#How_to_analyse_unreachable_objects" target="_blank" rel="noopener">分析不可达对象</a>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行该命令前需删除dump文件所在目录中由MAT生成的分析文件</span></span><br><span class="line">$ ParseHeapDump.sh -keep_unreachable_objects heap-dump.bin</span><br></pre></td></tr></table></figure><p>点击MAT的菜单<code>File -&gt; Open Heap Dump</code>选择文件<code>heap-dump.bin</code>载入转储分析文件，然后，通过OQL（<code>SELECT cn, cn.isClosed, cn.io.mysqlConnection, cn.io.mysqlConnection.closed FROM INSTANCEOF com.mysql.jdbc.JDBC4Connection cn</code>）得到MySQL Connection对象如下：</p><p><img src="/assets/images/jvm-dump/connection-pool-exhausted/java-memory-leak-oql-instanceof-mysql-connection-in-heap-dump.png" alt></p><blockquote><p>点击工具栏中的分组图标可按照Class Loader对结果进行分组；<br>在MySQL驱动中的<code>Connection</code>所引用的相关对象为：</p><ul><li>com.mysql.jdbc.JDBC4Connection#io:com.mysql.jdbc.MysqlIO</li><li>com.mysql.jdbc.MysqlIO#mysqlConnection:java.net.Socket</li><li>java.net.Socket#closed:boolean</li></ul></blockquote><p>可以发现，在36个连接中仅有2个是正常关闭的，其余的<code>Connection</code>未被关闭，但对应的<code>Socket</code>连接却处于关闭状态。这里可以假设出以下两种可能的情形：</p><ul><li><code>Connection</code>在<strong>使用时</strong>出现网络中断，导致<code>Socket</code>非正常关闭；</li><li><code>Connection</code>在<strong>使用后</strong>未被正常关闭，并且在某个时刻发生了<code>Socket</code>连接中断；</li></ul><p>对于第一种情形，<code>Socket</code>的异常关闭势必会抛出异常，并最终在使用方拦截到该异常并关闭<code>Connection</code>，而这里的<code>Connection</code>为非关闭状态，说明使用方并未准确做资源的释放处理。第二种情形，自然也是因为资源未被及时释放了。</p><p>因此，<code>Connection</code>没有被及时、准确地释放是相当肯定的事情了。</p><p>但这里依然有个疑问，为啥连接池里记录分配的连接为<code>749</code>，而实际查到的<code>Connection</code>对象只有30多个，其余的哪儿去了？</p><p>针对上述问题，限于基本功的问题，目前还没有确切的定论，但大致可推断是MySQL驱动中的<code>com.mysql.jdbc.AbandonedConnectionCleanupThread</code>对弱引用的<code>com.mysql.jdbc.JDBC4Connection</code>对象做了资源<code>主动回收</code>处理：</p><p><img src="/assets/images/jvm-dump/connection-pool-exhausted/mysql-source-abandoned-connection-cleanup.png" alt></p><p><code>com.mysql.jdbc.NonRegisteringDriver.ConnectionPhantomReference</code>为虚引用类<code>java.lang.ref.PhantomReference</code>的扩展类，其将在<code>java.lang.ref.Reference.ReferenceHandler#run</code>中等待JVM启动GC时进行清理活动。</p><blockquote><p>Java引用相关的知识可阅读<a href="https://benjaminwhx.com/2018/05/19/%E5%A4%A7%E8%AF%9DJava%E4%B8%AD%E7%9A%844%E7%A7%8D%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/" target="_blank" rel="noopener">详解java.lang.ref包中的4种引用</a>。</p></blockquote><p>既然得到了看似很有道理的分析结论，那就应该有方法复现当前的问题。</p><p>首先，通过IDE工具查找应用中主动获取<code>Connection</code>对象而未释放的代码位置，最终找出以下几处：</p><ul><li>xx/xx/xx/XxQueryImpl.java @r74605: L357, L1607</li><li>…</li></ul><p>经过调用分析后，可找到以下几个相关的Web API以用于复现验证：</p><ul><li>/a/xx/queryXx.mvc</li><li>/a/xx/countXx.mvc</li><li>…</li></ul><p>需要注意的是，一般MySQL服务端会限定并发连接数，为了快速复现当前问题，可通过以下语句调整MySQL的默认最大连接数（重启后将失效）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看默认配置： show variables like '%connect%';</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> max_connections = <span class="number">850</span>;</span><br></pre></td></tr></table></figure><p>在登录应用A后，在浏览器控制台中执行以下代码便可复现最开始提到的异常问题：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ctx = <span class="string">'/a'</span>;</span><br><span class="line"><span class="keyword">var</span> urls = [</span><br><span class="line">    ctx + <span class="string">'/xx/queryXx.mvc'</span>,</span><br><span class="line">    ctx + <span class="string">'/xx/countXx.mvc'</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> waitTime = <span class="number">0.1</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doRequest</span>(<span class="params">urls, index</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!urls || urls.length === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> i = index || <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> url = urls[<span class="number">0</span>];</span><br><span class="line">    $.ajax(&#123;<span class="attr">url</span>: url, <span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(i, url, <span class="built_in">arguments</span>);</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            doRequest(urls.slice(<span class="number">1</span>), i + <span class="number">1</span>);</span><br><span class="line">        &#125;, waitTime);</span><br><span class="line">    &#125;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> requestCount = <span class="number">800</span>;</span><br><span class="line"><span class="keyword">var</span> requestURLs = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; requestCount / urls.length; i++) &#123;</span><br><span class="line">    requestURLs = requestURLs.concat(urls);</span><br><span class="line">&#125;</span><br><span class="line">doRequest(requestURLs);</span><br></pre></td></tr></table></figure><p><img src="/assets/images/jvm-dump/connection-pool-exhausted/app-a-reproduct-timeout-wait-for-idle-object.png" alt></p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>找到了根本原因，解决方案就很简单了：</p><ul><li>在<code>try {...} finally {...}</code>语句的<code>finally</code>块中关闭<strong>主动获取</strong>的<code>Connection</code>对象。</li></ul><p>而本案例中的业务需求似乎比较特殊，具体方案需根据实际业务需求确定，但必须坚持以下原则：</p><ul><li>在<code>finally</code>块中释放主动获取的<code>Connection</code>对象；</li><li>数据库类型无关：尽可能避免在代码中根据数据库类型做条件判断，首选<a href="http://docs.jboss.org/hibernate/core/3.5/reference/en-US/html_single/#queryhql" target="_blank" rel="noopener">HQL</a>所支持的<u>数据库无关</u>的查询语句和表达式</li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">Eclipse Memory Analyzer - MAT</a></li><li><a href="https://blogs.oracle.com/sundararajan/querying-java-heap-with-oql" target="_blank" rel="noopener">Querying Java heap with OQL</a></li><li><a href="https://www.ibm.com/developerworks/library/j-memoryanalyzer/#N103C9" target="_blank" rel="noopener">OQL</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> JVM内存分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 连接池耗尽 </tag>
            
            <tag> Connection pool exhausted </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM内存分析：Tomcat内存泄漏</title>
      <link href="/the-jvm-dump-analyse-for-tomcat-memory-leak/"/>
      <url>/the-jvm-dump-analyse-for-tomcat-memory-leak/</url>
      
        <content type="html"><![CDATA[<h2 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h2><p>通过内存转储可对Java应用内各对象的内存使用情况进行分析，从而找出过度消耗内存或无法及时释放的对象，进而为异常修复以及提升应用加载速度和运行性能提供帮助。</p><p>内存转储使用JDK自带的工具<code>jmap</code>（<code>sudo -u tomcat jmap -dump:format=b,file=heap-dump.bin &lt;java_pid&gt;</code>）将应用内存以二进制格式转储到<code>heap-dump.bin</code>中。</p><blockquote><p>需确保转储用户与线程用户相同，否则会出现<a href="https://stackoverflow.com/questions/26140182/running-jmap-getting-unable-to-open-socket-file#answer-35963059" target="_blank" rel="noopener">Unable to open socket file: target process not responding or HotSpot VM not loaded</a>的问题；</p><p>转储文件可能会被放到临时目录中，该目录会在Tomcat重启时被删除，所以，一定要在重启前将转储文件转移到安全位置；</p><p>转储的文件一般为GB级，可通过命令<code>xz -k heap-dump.bin</code>进行高强度压缩，得到压缩文件<code>heap-dump.bin.xz</code>。解压使用命令<code>unxz -k heap-dump.bin.xz</code>，其中，<code>-k</code>选项均表示保留原文件，否则原文件将会被删除；<br><a id="more"></a></p></blockquote><p>得到内存转储文件后，可通过<a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">Eclipse Memory Analyzer - MAT</a>对其进行分析。由于转储文件较大，所以，分析工具也需要分配较大内存方可正常运行，需编辑文件<code>MemoryAnalyzer.ini</code>，修改或添加<code>-Xmx4g</code>以增加MAT的堆内存。</p><p>在开始分析之前先了解一下下面几个相关术语：</p><ul><li><strong>Shallow Heap</strong>：对象自身占用的内存大小（包含基本数据类型），不包括它引用对象的大小；</li><li><strong>Retained Heap</strong>：<strong>Shallow Heap</strong> + 所有直接或者间接引用对象占用的内存（即该对象被GC回收后，可以被回收的内存）；</li><li><strong>GC Root</strong>：被堆外对象引用的对象；</li><li><strong>Dominator Tree</strong>：以支配树方式描述的对象引用关系；</li></ul><h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><p>应用运行环境：</p><ul><li>独立的Docker容器</li><li>JDK8 + Tomcat8</li><li>Tomcat内运行有A和B两个业务应用，其他为Tomcat自带的<code>docs</code>、<code>manager</code>、<code>examples</code>、<code>host-manager</code>、<code>ROOT</code>（五个）应用</li></ul><p>在开发环境中，应用经常出现内存泄漏（<code>OutOfMemoryError：Permgem space</code>）。其每次重启并运行一段时间后，也会消耗掉大量内存：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/app-a-hight-cpu-memory-usage.png" alt></p><blockquote><p><strong>内存泄露</strong>：指程序中动态分配内存给一些临时对象，但是对象不会被GC所回收，它始终占用内存。即被分配的对象可达但已无用。</p><p><strong>内存溢出</strong>：指程序运行过程中无法申请到足够的内存而导致的一种错误。内存溢出通常发生于Old段或Perm段垃圾回收后，仍然无内存空间容纳新的Java对象的情况。</p></blockquote><p>从图中可以看到，Tomcat进程占用了接近50%的内存（8G+），这对仅有少量访问的应用来说是很不正常的。</p><p>话不多说，直接使用<code>jmap</code>（<code>sudo -u tomcat jmap -dump:format=b,file=heap-dump.bin &lt;java_pid&gt;</code>）将Tomcat的内存转储并下载到本地。再通过MAT对其进行分析。</p><p>这里得到的分析结果如下：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/java-memory-leak-overview-of-heap-dump.png" alt></p><p>然后，打开<code>Dominator Tree</code>以检查当前占用内存最高的有哪些对象：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/java-memory-leak-dominator-tree-of-heap-dump.png" alt></p><p>从中可发现<code>SessionFactoryImpl</code>和<code>ParallelWebappClassLoader</code>的内存占用比例最高，并且，在对结果进行正则过滤后可以发现：</p><ul><li>这两个Class存在多个实例，其中，<code>SessionFactoryImpl</code>有10个实例，而<code>ParallelWebappClassLoader</code>有15个实例；</li><li>各个<code>SessionFactoryImpl</code>实例的Class以及Class Loader的地址均不相同；</li><li>而所有<code>ParallelWebappClassLoader</code>的Class和Class Loader的地址却是相同的；</li><li>另外，可以看到<code>SessionFactoryImpl</code>的Class Loader均为<code>ParallelWebappClassLoader</code>；</li></ul><blockquote><p>在Tomcat7和Tomcat8中默认的Class Loader为<code>ParallerWebappClassLoader</code>以支持Class并行加载，提高加载效率（并行加载机制需JDK7+环境）。</p></blockquote><p>根据Java Class的加载原理可知，每个Class均对应一个唯一的Class Loader，不同的Class Loader所加载的Class是不同的，即使是Class名称（含包名）完全一致，也是互不相等的。也就是说，在当前的Tomcat内不仅存在多个<code>SessionFactoryImpl</code>实例，还同时存在多个<code>SessionFactoryImpl</code>的Class。</p><p>打开<code>Histogram</code>看看在Tomcat中存在多少个Class，而每个Class又产生了多少实例：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/java-memory-leak-histogram-of-heap-dump.png" alt></p><p>对上述两个目标过滤后可以发现，在Tomcat中确实存在10个同名的<code>SessionFactoryImpl</code>类，每个类均产生了一个实例，而<code>ParallelWebappClassLoader</code>虽然只有一个类，但却创建了15个实例。这和我们所预期的共识产生了明显冲突：</p><ul><li>Tomcat应该为每个应用创建且仅创建一个Class Loader以隔离不同的应用，加上Tomcat自带的应用，总共应该只有7个Class Loader才对；</li><li>Hibernate SessionFactory在单个应用内应该是单例的，而在本案例中只有A和B两个应用才会创建SessionFactory实例，其实例数最多只能有两个；</li></ul><p>于是抛出以下问题：</p><ul><li>Tomcat因为什么原因创建了额外的8个Class Loader？</li><li>额外的8个Hibernate SessionFactory实例又是为何创建的？</li><li>Tomcat高内存占用是因为Class被重复加载以及存在相同的活跃对象所造成的？</li></ul><p>先来看看Class Loader的<code>GC Root</code>引用情况（在<code>Histogram</code>内选中目标，再右键选择<code>Merge Shortest Paths to GC Roots</code>）：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/java-memory-leak-classloader-gc-root-in-heap-dump.png" alt></p><p>从结果中可以看到，Class Loader实际被11条线程所引用，通过名称可以判断有5条是应用所创建的Deamon线程，以及一条Hibernate Search线程和一条Tomcat的线程。</p><p>如此看来，Class Loader是被不同的线程所引用的，那很有可能是因为这些线程遇到死锁或长时间的阻塞而造成了其无法被及时回收，从而导致<code>PermGen</code>（永生代，负责存放Class、静态变量、常量等）内存被耗尽。</p><p>还可以怀疑<code>ASM</code>的动态特性是否会创建新的Class Loader实例。可能性是有的，但仔细分析也可以发现，若其自行实例化加载器，即使不考虑性能问题，其又如何确定从何处加载所需的Class？很明显，利用当前的Class Loader才是明智的选择。看看Tomcat源码<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/loader/WebappLoader.java#L393" target="_blank" rel="noopener">WebappLoader.java</a>的第<code>394</code>行就知道自己去实例化Class Loader是多么不可靠：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/tomcat8-creating-classloader-in-webapploader.png" alt></p><p>既然提到了Tomcat的源码，那就干脆把代码check下来研究一下（<a href="https://github.com/apache/tomcat/" target="_blank" rel="noopener">https://github.com/apache/tomcat/</a> ，本例使用分支<code>tag/8.5.6</code>）。</p><p>先看看<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/loader/ParallelWebappClassLoader.java#L23" target="_blank" rel="noopener">ParallelWebappClassLoader</a>是怎么回事。</p><p>该类本身逻辑很少，但其继承的父类<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/loader/WebappClassLoaderBase.java#L1446" target="_blank" rel="noopener">WebappClassLoaderBase</a>却责任重大，需要做Class的加载和查询工作。该父类包含众多属性，而其中值得关注的是类型为<code>LifecycleState</code>的<code>state</code>属性，显然，这说明这个Class Loader是具有生命周期的，并且，很明显只能由Tomcat来控制其生命周期，因为其他Class无法知道其存在。</p><p>既然，<code>ParallelWebappClassLoader</code>包含这么多属性，那看看在前面发现的那些实例的<code>state</code>属性有何不同。</p><p>依然在<code>Histogram</code>中选中目标，在右键菜单中选择<code>List objects -&gt; with outgoing references</code>，跳转到：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/java-memory-leak-classloader-instances-in-heap-dump.png" alt></p><p>展开每个实例，检查各实例的<code>state</code>情况：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/java-memory-leak-classloader-state-in-heap-dump.png" alt></p><p>检查后发现，有8个实例的<code>state</code>为<code>DESTROYED</code>，7个为<code>STARTED</code>。这说明，有8个Class Loader实际已经被销毁，只有7个是活跃的。再对前面的<code>GC Root</code>列表里的线程所引用的Class Loader进行比对，可以发现有8条线程正好引用的是这8个被销毁的Class Loader，也就是说：</p><ul><li>Tomcat在销毁Class Loader后，因线程无法被终止而使得该线程所引用的Class Loader无法被回收，进而导致该Class Loader所加载的Class也不会被回收，而线程所引用的实例对象也就同样无法被回收，其中，就包含<code>SessionFactoryImpl</code>；</li></ul><p>这里的几个数字也很值得关注：<code>8</code>，<code>7</code>，<code>5</code>。正常情况下，Tomcat应该创建<code>5+2</code>（5个Tomcat自带应用，2个业务应用）个Class Loader，这正好是<code>7</code>个活跃态的Class Loader。那么，现在的这<code>15</code>个Class Loader都对应了哪些应用呢？</p><p>有过以编码方式内嵌<code>Jetty</code>等Servlet容器开发经验或者阅读过Tomcat源码的开发者应该知道，Servlet容器一般会有一个<code>Context</code>对象用以记录加载的webapp的名字、目录等信息，而Tomcat的该类的实现为<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/StandardContext.java#L159" target="_blank" rel="noopener">org.apache.catalina.core.StandardContext</a>。所以，找到<code>ParallelWebappClassLoader</code>关联的<code>Context</code>，就可以知道其负责加载的是哪个应用了。</p><p>在前面打开的<code>outgoing references</code>列表中查找Tomcat内的对象，最终发现<code>ParallelWebappClassLoader</code>的<code>resources#context</code>正是我们要找的：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/java-memory-leak-classloader-resources-context-in-heap-dump.png" alt></p><p>挨个检查后发现，7个活跃的Class Loader分别对应着Tomcat所加载的7个应用，但剩下的8个却没有<code>resources</code>属性。属性不存在，说明其应该是被置为了<code>null</code>，这也进一步验证Class Loader的确是被销毁了，且只能是被Tomcat销毁的。</p><p>到这里，事情还没有结束，因为还不知道其他8个Class Loader是哪个（或哪些）应用产生的呢！</p><p>试试从加载的jar等资源的路径来判断加载的是哪个应用？</p><p>在查遍可能的属性后，最终发现，在<code>ParallelWebappClassLoader#localRepositories</code>中便记录了所有加载的jar的URL地址：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/java-memory-leak-classloader-localrepositories-in-heap-dump.png" alt></p><p>这下才算是圆满了，被销毁的8个Class Loader均对应到应用A的部署位置，也就是说，Tomcat对应用A进行过至少8次<strong>销毁</strong>处理。</p><p>被销毁8次？！这两者为何如此「苦大仇深」呢？</p><p>前面已经讨论过，销毁必然只能由Tomcat来做，应用内部不应该也没法主动进行销毁，除非有针对性的代码，但应用A中并没有提供这样的机制。</p><p>那继续分析Tomcat的源码。</p><p>在前面有提到<code>ParallelWebappClassLoader#state</code>的值会发生变化，那就找找代码里在哪些地方修改了该状态：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/tomcat8-destroy-classloader-in-webappclassloader.png" alt></p><p>跟踪接口调用情况，可以发现在<code>WebappLoader</code>中实施了销毁动作：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/tomcat8-destroy-classloader-in-webapploader.png" alt></p><p>最后的最后，发现Tomcat会在Class Loader中检查classpath中<strong>已加载</strong>的资源的变更情况，若发生变化，则将直接<strong>reload</strong>当前应用：</p><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/tomcat8-check-modified-in-webappclassloader.png" alt></p><blockquote><p><strong>已加载</strong>指通过<code>ClassLoader#getResourceAsStream</code>或<code>ClassLoader#findResource</code>查找过的资源，在Tomcat中只有通过这两个接口查找到的资源才会被放到<code>org.apache.catalina.loader.WebappClassLoaderBase#resourceEntries</code>列表中。</p></blockquote><p>这里记录下接口调用的跟踪路径：</p><blockquote><p>查找引用：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/loader/WebappClassLoaderBase.java#L1493" target="_blank" rel="noopener">org.apache.catalina.loader.WebappClassLoaderBase#destroy</a></p><blockquote><p>定位到：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/loader/WebappLoader.java#L433" target="_blank" rel="noopener">org.apache.catalina.loader.WebappLoader#stopInternal</a><br>查找引用：<code>org.apache.catalina.loader.WebappLoader</code>（注：查找<code>stopInternal</code>的引用无法确定其真实调用位置）</p><blockquote><p>定位到：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/StandardContext.java#L4940" target="_blank" rel="noopener">org.apache.catalina.core.StandardContext#startInternal</a><br>转到：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/StandardContext.java#L4977" target="_blank" rel="noopener">org/apache/catalina/core/StandardContext.java:4977</a></p><blockquote><p>查找引用：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/StandardContext.java#L1762" target="_blank" rel="noopener">org.apache.catalina.core.StandardContext#getLoader</a></p><blockquote><p>定位到：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/ContainerBase.java#L1357" target="_blank" rel="noopener">org.apache.catalina.core.ContainerBase.ContainerBackgroundProcessor#processChildren</a><br>转到：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/ContainerBase.java#L1372" target="_blank" rel="noopener">org/apache/catalina/core/ContainerBase.java:1372</a></p><blockquote><p>查找实现：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/StandardContext.java#L5537" target="_blank" rel="noopener">org.apache.catalina.core.StandardContext#backgroundProcess</a></p><blockquote><p>转到：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/StandardContext.java#L5545" target="_blank" rel="noopener">org/apache/catalina/core/StandardContext.java:5545</a></p><blockquote><p>查找实现：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/loader/WebappLoader.java#L287" target="_blank" rel="noopener">org.apache.catalina.loader.WebappLoader#backgroundProcess</a></p><blockquote><p>转到：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/loader/WebappLoader.java#L292" target="_blank" rel="noopener">org/apache/catalina/loader/WebappLoader.java:292</a></p><blockquote><p>查找实现：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/StandardContext.java#L3760" target="_blank" rel="noopener">org.apache.catalina.core.StandardContext#reload</a><br>直接定位到：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/StandardContext.java#L5376" target="_blank" rel="noopener">org.apache.catalina.core.StandardContext#stopInternal</a><br>转到：<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/core/StandardContext.java#L5447" target="_blank" rel="noopener">org/apache/catalina/core/StandardContext.java:5447</a></p><blockquote><p>返回到：<code>org.apache.catalina.loader.WebappLoader#stopInternal</code></p></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote><p>分析<a href="https://github.com/apache/tomcat/blob/8.5.6/java/org/apache/catalina/loader/WebappLoader.java#L287" target="_blank" rel="noopener">org.apache.catalina.loader.WebappLoader#backgroundProcess</a>的逻辑可以确定webapp重载的两个条件：</p><ul><li>应用启用了<a href="https://tomcat.apache.org/tomcat-5.5-doc/config/context.html#Common_Attributes" target="_blank" rel="noopener">reloadable</a>；</li><li><code>WEB-INF/classes</code>或<code>WEB-INF/lib</code>内的资源发生了变化；</li></ul><p>经过前面的全面分析，现在终于可以还原真相了：</p><ul><li>应用A在部署时，启用了热加载机制（真实情况也的确如此）：<ul><li>在CI构建中为了控制应用A和应用B的加载顺序，采用了定义<code>&lt;Context/&gt;</code>的方式按顺序加载两个应用；</li><li>不幸的是，从网上拷贝了别人的配置，因而保留了<code>reloadable=&quot;true&quot;</code>的设定：<code>&lt;Context path=&quot;/app_a&quot; reloadable=&quot;true&quot; docBase=&quot;app_a.war&quot; /&gt;</code>；</li></ul></li><li>应用A在首次启动时会修改<code>WEB-INF/classes/config.properties</code>，而该文件会在<code>org.springframework.beans.factory.config.PropertyPlaceholderConfigurer</code>中通过<code>ClassLoader#getResourceAsStream</code>读取，从而被放入Tomcat的资源变更观察列表中，成为Tomcat的<strong>已加载资源</strong>；</li><li>首次启动会使Tomcat触发至少两次重载，从Tomcat的输出日志中可寻找到重载痕迹；</li><li>在应用A运行后，通过其配置中心也会造成对<code>WEB-INF/classes/config.properties</code>的修改，进而导致该应用再次被重载；</li><li>最后，加上应用A中存在无法结束的线程，使得其引用的对象以及关联的Class Loader无法被回收，从而导致内存消耗随着应用重载次数的增加而不断增加；</li></ul><p><img src="/assets/images/jvm-dump/tomcat-memory-leak/tomcat-webapp-reloading-log.png" alt></p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>对症下药，给出如下解决方案：</p><ul><li>对应用A禁用热加载，因为：<ul><li>应用自身加载就很缓慢，无法做到快速重载；</li><li>对配置的调整是确保应用重启后配置内容不丢失，而不是为了重新加载配置；</li><li>热加载机制应尽量少用，以避免内存泄漏，或其他无法预期的问题；</li></ul></li><li><strong>改进并完善线程逻辑</strong>，避免出现死锁，同时，确保应用在销毁前能够结束全部的线程；</li></ul><p>为了避免因线程无法终止而造成内存泄漏，使用线程需注意以下事项：</p><ul><li>非阻塞型异步任务线程，需确保整个逻辑执行过程中没有阻塞、竞争、死循环等阻碍线程结束的情况出现。除此之外，无须其他处理（<a href="#异步任务线程">#异步任务线程</a>）；</li><li>非I/O阻塞型守护线程，可按如下过程实现或改进代码（<a href="#非I-O阻塞型守护线程">#非I/O阻塞型守护线程</a>）：<ul><li>引入信号变量<code>interrupted</code>，并重写<code>java.lang.Thread#interrupt()</code>接口，在其中将信号量置为<code>true</code>；</li><li>在<code>interrupt()</code>内继续调用<code>super.interrupt();</code>以确保能够打破等待局面（<code>BlockingQueue</code>为空的等待，或者，sleep未超时的等待）；</li><li>循环条件改为<code>!this.interrupted</code>，并在循环内捕获<code>java.lang.InterruptedException</code>，以便在发生中断异常后<code>break</code>循环；</li><li>如果，在中断后仍需处理已有数据，则捕获异常后不<code>break</code>循环，而是在<code>while</code>条件中增加数据队列是否为空的判断（<a href="#非I-O阻塞型守护线程（数据清理）">#非I/O阻塞型守护线程（数据清理）</a>），当然，得<strong>确保生产者已不再工作</strong>；</li></ul></li><li>I/O阻塞型守护线程，同样需重写<code>java.lang.Thread#interrupt()</code>接口，并在其中关闭I/O连接，以迫使守护线程因<code>java.io.IOException</code>而结束等待，并最终终止循环（<a href="#I-O阻塞型守护线程">#I/O阻塞型守护线程</a>）；</li><li>对于在Spring Bean中维护的线程，需实现<code>org.springframework.beans.factory.InitializingBean</code>和<code>org.springframework.beans.factory.DisposableBean</code>两个接口：<ul><li>在<code>InitializingBean#afterPropertiesSet</code>中创建并启动线程；</li><li>在<code>DisposableBean#destroy</code>中结束线程以及其他清理工作；</li></ul></li><li>非Sping应用可考虑通过<code>Runtime.getRuntime().addShutdownHook()</code>注册一个终止其他线程的线程。也可以在应用退出的位置（比如，main结束前，或者在<code>javax.servlet.ServletContextListener#contextDestroyed</code>里）自行终止所有线程；</li><li>结束线程仅可调用接口<code>java.lang.Thread#interrupt()</code>，而<code>java.lang.Thread#stop()</code>已被官方明确不建议使用，原因是，强行终止线程不能确保资源被有效释放，只能自行做释放工作，也就是前面针对阻塞线程提到的几种结束方式；</li></ul><blockquote><p><strong>守护线程</strong>指一直循环运行的线程，一般内部含有<code>while</code>循环；</p><p><code>java.util.concurrent.BlockingQueue#take()</code>和<code>java.lang.Thread#sleep(long)</code>均会阻塞线程，并且只有在等待过程中才能被<code>interrupt</code>并抛出中断异常；</p><p>线程内部在接收到中断消息后，会<strong>重置</strong>线程状态，因此，<code>Thread.currentThread().isInterrupted()</code>仅在<u>中断刚好发生在没有等待（等待刚好被打破或者还在数据处理过程中）</u>的情况下才会返回<code>true</code>，而在发生了中断异常后则为<code>false</code>。所以，该接口十分不可靠，建议不要使用；</p></blockquote><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">Eclipse Memory Analyzer - MAT</a></li><li><a href="http://blog.csdn.net/wxwzy738/article/details/8516253" target="_blank" rel="noopener">停止Java线程，小心interrupt()方法</a></li><li><a href="https://10kloc.wordpress.com/2013/03/03/java-multithreading-steeplechase-stopping-threads/" target="_blank" rel="noopener">Java Multithreading Steeplechase: Stopping Threads</a></li><li><a href="https://wiki.apache.org/tomcat/MemoryLeakProtection" target="_blank" rel="noopener">MemoryLeakProtection</a></li><li><a href="https://cdivilly.wordpress.com/2012/04/23/permgen-memory-leak/" target="_blank" rel="noopener">Anatomy of a PermGen Memory Leak</a></li></ul><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="异步任务线程"><a href="#异步任务线程" class="headerlink" title="异步任务线程"></a>异步任务线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTaskThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// NOTE：内部逻辑不能存在死锁、死循环、阻塞等代码</span></span><br><span class="line">        doOnceTimeTask();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="非I-O阻塞型守护线程"><a href="#非I-O阻塞型守护线程" class="headerlink" title="非I/O阻塞型守护线程"></a>非I/O阻塞型守护线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingDaemonThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue queue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 标记线程已被中断</span></span><br><span class="line">        <span class="keyword">this</span>.interrupted = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 继续由父类传递中断消息，以确保处于等待中的队列能够结束等待。</span></span><br><span class="line">        <span class="comment">// 队列为空时将一直等待，从而阻塞线程，只能由父类打破该状态。</span></span><br><span class="line">        <span class="keyword">super</span>.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 重置状态，以便复用线程</span></span><br><span class="line">        <span class="keyword">this</span>.interrupted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 中断消息可能发生在队列刚好结束等待时，此时，线程无法捕获中断异常，因此，需通过信号量的状态判断是否终止循环。</span></span><br><span class="line">        <span class="comment">// 这里不使用Thread.currentThread().isInterrupted()，因为，这里希望在需要时能够重启该中断线程。</span></span><br><span class="line">        <span class="keyword">while</span> (!<span class="keyword">this</span>.interrupted) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object data = queue.take();</span><br><span class="line">                processData(data);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="comment">// 接收到中断消息，结束循环。</span></span><br><span class="line">                <span class="comment">// NOTE：此时，线程的中断状态已被重置！！</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="非I-O阻塞型守护线程（数据清理）"><a href="#非I-O阻塞型守护线程（数据清理）" class="headerlink" title="非I/O阻塞型守护线程（数据清理）"></a>非I/O阻塞型守护线程（数据清理）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CleanBlockingDaemonThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> interrupted;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue queue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 标记线程已被中断</span></span><br><span class="line">        <span class="keyword">this</span>.interrupted = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 继续由父类传递中断消息，以确保处于等待中的队列能够结束等待。</span></span><br><span class="line">        <span class="comment">// 队列为空时将一直等待，从而阻塞线程，只能由父类打破该状态。</span></span><br><span class="line">        <span class="keyword">super</span>.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 重置状态</span></span><br><span class="line">        <span class="keyword">this</span>.interrupted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在接收到中断后，一直处理，直到队列为空。</span></span><br><span class="line">        <span class="comment">// 如果没有中断，那就只能等待新的数据到来，或者，收到父类的中断消息</span></span><br><span class="line">        <span class="keyword">while</span> (!<span class="keyword">this</span>.interrupted || !queue.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object data = queue.take();</span><br><span class="line">                processData(data);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="comment">// NOTE：此时，线程的中断状态已被重置！！</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="I-O阻塞型守护线程"><a href="#I-O阻塞型守护线程" class="headerlink" title="I/O阻塞型守护线程"></a>I/O阻塞型守护线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IOBlockingDaemonThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> interrupted;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ServerSocket server;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.interrupted = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.server.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.server = <span class="keyword">new</span> ServerSocket(<span class="number">9680</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 由于该线程内没有能接收中断消息的对象，中断异常永远不会发生，只能通过IO关闭异常终止循环。</span></span><br><span class="line">        <span class="comment">// 这里为了确保万无一失，依然使用了中断消息变量。</span></span><br><span class="line">        <span class="keyword">while</span> (!<span class="keyword">this</span>.interrupted) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Socket socket = server.accept();</span><br><span class="line">                processSocket(socket);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// 终止循环，退出线程</span></span><br><span class="line">                <span class="comment">// NOTE：这里的线程状态不会变化！！</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JVM内存分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内存泄漏 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>算法分析：求解最长公共子序列</title>
      <link href="/algorithm-finding-the-longest-common-sequence/"/>
      <url>/algorithm-finding-the-longest-common-sequence/</url>
      
        <content type="html"><![CDATA[<blockquote><p>算法分析系列文章中的代码可被任何人无偿使用于任何场景且无需注明来源也不必在使用前征得本文作者同意。</p><p>算法分析系列文章旨在传播准确、完整、简洁、易懂、规范的代码实现，并传授基本的编程思想和良好的编码习惯与技巧。</p><p>若文章中的代码存在问题或逻辑错误，请通过邮件等形式（见文章结尾）告知于本文作者以便及时修正错误或改进代码。</p><p>算法系列文章不可避免地会参考和学习众多网友的成果，在行文风格、内容及求解思路上也会进行借鉴，如有侵权嫌疑，请联系本文作者。</p><p>PS：若为转载该文章，请务必注明来源，本站点欢迎大家转载。</p></blockquote><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>如果序列 <script type="math/tex">S_1</script> 中的所有元素按照其在 <script type="math/tex">S_1</script> 中的出现顺序依次出现在另一个序列 <script type="math/tex">S_2</script> 中，则称 <script type="math/tex">S_1</script> 为 <script type="math/tex">S_2</script> 的<a href="https://zh.wikipedia.org/wiki/%E5%AD%90%E5%BA%8F%E5%88%97" target="_blank" rel="noopener">子序列</a>。</p><blockquote><p>子序列不要求位置的连续性（即，元素相邻），只要相对顺序不变即可。</p></blockquote><p>若给定一个序列集合（数量大于或等于2，但通常为两个序列），则这些序列所共同拥有的子序列，称为<strong>公共子序列</strong>。而在这些公共子序列中长度最长的子序列则称为该序列集合的<a href="https://zh.wikipedia.org/wiki/%E6%9C%80%E9%95%BF%E5%85%AC%E5%85%B1%E5%AD%90%E5%BA%8F%E5%88%97" target="_blank" rel="noopener">最长公共子序列</a>（Longest Common Sequence, LCS）。</p><p>本例所要求的便是求解任意两个序列的最长公共子序列（可能存在多个不同的序列），并打印其长度及其其中的任意一个序列。<br><a id="more"></a></p><p>例如，序列 <script type="math/tex">\{ B, D, C, A, B, A \}</script> 和 <script type="math/tex">\{ A, B, C, B, D, A, B \}</script> 的最长公共子序列为 <script type="math/tex">\{ B, C, B, A \}</script> 和 <script type="math/tex">\{ B, D, A, B \}</script> ，且其最长公共子序列的长度为<code>4</code>。</p><h2 id="求解方案"><a href="#求解方案" class="headerlink" title="求解方案"></a>求解方案</h2><h3 id="动态规划法"><a href="#动态规划法" class="headerlink" title="动态规划法"></a>动态规划法</h3><p>首先，对最长公共子序列的求解过程做如下数学推导。</p><p>假设，存在序列集合 <script type="math/tex">X_i=\{ x_1, x_2, ..., x_i \}</script> 和 <script type="math/tex">Y_j=\{ y_1, y_2, ..., y_j \}</script> ，其最长公共子序列为 <script type="math/tex">Z_k=\{ z_1, z_2, ..., z_k \}</script> 。则存在以下情况：</p><ul><li>若 <script type="math/tex">x_i=y_j</script> ，则有 <script type="math/tex">z_k=x_i=y_j</script> ，且 <script type="math/tex">Z_{k-1}=\{ z_1, z_2, ..., z_{k-1} \}</script> 是 <script type="math/tex">X_{i-1}=\{ x_1, x_2, ..., x_{i-1} \}</script> 与 <script type="math/tex">Y_{j-1}=\{ y_1, y_2, ..., y_{j-1} \}</script> 的一个最长公共子序列</li><li>若 <script type="math/tex">x_i \neq y_j</script> ，则若 <script type="math/tex">z_k \neq x_i</script> ，那么， <script type="math/tex">Z_k</script> 是 <script type="math/tex">X_{i-1}</script> 与 <script type="math/tex">Y_j</script> 的一个最长公共子序列。注：此时 <script type="math/tex">z_k</script> 不一定等于 <script type="math/tex">y_j</script> ，但该推论是包含等于或不等于的情况的</li><li>若 <script type="math/tex">x_i \neq y_j</script> ，则若 <script type="math/tex">z_k \neq y_j</script> ，那么， <script type="math/tex">Z_k</script> 是 <script type="math/tex">X_i</script> 与 <script type="math/tex">Y_{j-1}</script> 的一个最长公共子序列。注：此时 <script type="math/tex">z_k</script> 不一定等于 <script type="math/tex">x_i</script> ，但该推论是包含等于或不等于的情况的</li></ul><p>根据以上推论可进一步推断以下求解过程是与其等效的：</p><ul><li>当 <script type="math/tex">x_i=y_j</script> 时，首先找出 <script type="math/tex">X_{i-1}</script> 与 <script type="math/tex">Y_{j-1}</script> 的最长公共子序列，再在该子序列后面加上 <script type="math/tex">x_i</script> 或 <script type="math/tex">y_j</script> ，而后所得的子序列即为 <script type="math/tex">X_i</script> 与 <script type="math/tex">Y_j</script> 的最长公共子序列</li><li>而当 <script type="math/tex">x_i \neq y_j</script> 时，就需要分别求解 <script type="math/tex">X_{i-1}</script> 与 <script type="math/tex">Y_j</script> 以及 <script type="math/tex">X_i</script> 与 <script type="math/tex">Y_{j-1}</script> 的最长公共子序列，最后，所得的这两个子序列中的较长者即为 <script type="math/tex">X_i</script> 与 <script type="math/tex">Y_j</script> 的最长公共子序列</li></ul><p>若用 <script type="math/tex">\prod(i,j)</script> 表示 <script type="math/tex">X_i</script> 与 <script type="math/tex">Y_j</script> 的最长公共子序列，那么，将有如下公式成立：</p><script type="math/tex; mode=display">\prod(i,j) = \begin{cases}\prod(i-1,j-1) + x_i,                             & x_i = y_j \\\max\big\{ \prod(i-1,j), \prod(i,j-1) \big\},     & x_i \neq y_j\end{cases}, i \geq 1, j \geq 1</script><blockquote><p>注意，公式中的加号表示序列与元素的连接，而不是数值的加减。<br>当 <script type="math/tex">i</script> 与 <script type="math/tex">j</script> 为 <script type="math/tex">1</script> 时，上面的公式将出现 <script type="math/tex">\prod(0,0)</script> ，而其正好表示的是 <script type="math/tex">X_{i-1}</script> 与 <script type="math/tex">Y_{j-1}</script> 的最长公共子序列为<strong>空序列</strong>，且其长度为 <script type="math/tex">0</script> 。</p></blockquote><p>从以上公式可以发现最长公共子序列问题具有<strong>子问题重叠</strong>的性质。因为，在求解 <script type="math/tex">X_i</script> 与 <script type="math/tex">Y_j</script> 的最长公共子序列时，需要分别求解 <script type="math/tex">X_{i-1}</script> 与 <script type="math/tex">Y_j</script> 以及 <script type="math/tex">X_i</script> 与 <script type="math/tex">Y_{j-1}</script> 的最长公共子序列，而这两个子问题都包含一个公共子问题，即，求解 <script type="math/tex">X_{i-1}</script> 与 <script type="math/tex">Y_{j-1}</script> 的最长公共子序列。</p><p>因此，可以采用<a href="https://zh.wikipedia.org/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92" target="_blank" rel="noopener">动态规划法</a>来求解最长公共子序列问题。</p><blockquote><p>动态规划在查找有很多<strong>重叠子问题</strong>的情况的最优解时有效。它将问题重新组合成子问题。为了避免多次解决这些子问题，它们的结果都逐渐被计算并被保存，从简单的问题直到整个问题都被解决。因此，动态规划保存递归时的结果，因而不会在解决同样的问题时花费时间。（引用自「维基百科」）</p></blockquote><p>但是，若要寻找最长公共子序列，需要首先计算公共子序列的长度，再根据长度及坐标位置回溯才能寻找出 <script type="math/tex">X_i</script> 和 <script type="math/tex">Y_j</script> 的最长公共子序列。</p><p>因此，如果用二位数组 <script type="math/tex">f[i][j]</script> 表示序列 <script type="math/tex">X_i</script> 和 <script type="math/tex">Y_j</script> 的最长公共子序列的长度，那么根据前面的最长公共子序列的求解公式，便可相应地推导出求解最长公共子序列的长度的公式，即：</p><script type="math/tex; mode=display">f[i][j] = \begin{cases}0,                                           & i = 0 或 j = 0 \\f[i-1][j-1] + 1,                             & i \geq 1, j \geq 1 且 x_i = y_j \\\max\big\{ f[i-1][j], f[i][j-1] \big\},      & i \geq 1, j \geq 1 且 x_i \neq y_j\end{cases}</script><p>这样， <script type="math/tex">f[i][j]</script> 中的最大值便是 <script type="math/tex">X_i</script> 和 <script type="math/tex">Y_j</script> 的最长公共子序列的长度，而根据该数组回溯，便可找到该最长公共子序列。</p><p>以序列 <script type="math/tex">X_i=\{ A, B, C, B, D, A, B \}</script> 和 <script type="math/tex">Y_j=\{ B, D, C, A, B, A \}</script> 为例，可以通过下图了解整个求解最长公共子序列长度的过程：</p><p><img src="/assets/images/algorithm/longest-common-sequence-dp-searching-case.png" alt></p><blockquote><p>上图取自于 <a href="https://blog.csdn.net/v_JULY_v/article/details/6110269" target="_blank" rel="noopener">https://blog.csdn.net/v_JULY_v/article/details/6110269</a></p></blockquote><p>这里直接给出实现代码，可以结合上图与代码进行分析（时间复杂度为 <script type="math/tex">O(mn)</script> ）：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_SEQ_LEN 50</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    LEN_DIR_LEFT,</span><br><span class="line">    LEN_DIR_TOP,</span><br><span class="line">    LEN_DIR_TOP_LEFT</span><br><span class="line">&#125; LCSLenDir;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LCSLen</span> &#123;</span></span><br><span class="line">    <span class="comment">// 最长公共子序列的长度</span></span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">    <span class="comment">// 长度求值基于哪个方向的结果，</span></span><br><span class="line">    <span class="comment">// 沿着该方向回溯便可反向找出对应的最长公共子序列</span></span><br><span class="line">    LCSLenDir dir;</span><br><span class="line">&#125; LCSLen;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Note：二维数组作为参数时，必须指定第二维的长度</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lcs_search_dynamic_programming</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    LCSLen lcs_len[][MAX_SEQ_LEN]</span></span></span><br><span class="line"><span class="function"><span class="params">    , <span class="keyword">int</span> seq_x[], <span class="keyword">int</span> seq_y[]</span></span></span><br><span class="line"><span class="function"><span class="params">    , <span class="keyword">int</span> seq_x_len, <span class="keyword">int</span> seq_y_len</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 将(i,0)的单元格全部置为0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= seq_x_len; i++) &#123;</span><br><span class="line">        lcs_len[i][<span class="number">0</span>].value = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将(0,j)的单元格全部置为0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= seq_y_len; j++) &#123;</span><br><span class="line">        lcs_len[<span class="number">0</span>][j].value = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 沿着二维数组的i轴从上到下依次沿着j轴从左到右计算公共子序列的长度</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= seq_x_len; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= seq_y_len; j++) &#123;</span><br><span class="line">            <span class="comment">// f[i][j] = f[i-1][j-1] + 1, x[i] = y[j]</span></span><br><span class="line">            <span class="comment">// Note：数组seq_x与seq_y的元素是从0开始的</span></span><br><span class="line">            <span class="keyword">if</span> (seq_x[i - <span class="number">1</span>] == seq_y[j - <span class="number">1</span>]) &#123;</span><br><span class="line">                lcs_len[i][j].value = lcs_len[i - <span class="number">1</span>][j - <span class="number">1</span>].value + <span class="number">1</span>;</span><br><span class="line">                lcs_len[i][j].dir = LEN_DIR_TOP_LEFT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// f[i][j] = max(f[i-1][j], f[i][j-1])</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (lcs_len[i - <span class="number">1</span>][j].value &gt;= lcs_len[i][j - <span class="number">1</span>].value) &#123;</span><br><span class="line">                lcs_len[i][j].value = lcs_len[i - <span class="number">1</span>][j].value;</span><br><span class="line">                lcs_len[i][j].dir = LEN_DIR_TOP;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                lcs_len[i][j].value = lcs_len[i][j - <span class="number">1</span>].value;</span><br><span class="line">                lcs_len[i][j].dir = LEN_DIR_LEFT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>这里通过结构体<code>LCSLen</code>同时记录最长公共子序列的长度和方向，避免传递多个数组，可提升可读性</li><li>对于多个意义相同的固定的常量值，为其定义枚举类型，是一种良好的编码习惯</li><li>这里没有将<code>i</code>和<code>j</code>定义为函数的局部变量是为了在阅读时不用担心二者的值会被前面的逻辑所影响，因为前后的变量具有不同的作用域且是相互独立的。从而确保阅读的流畅性，同时，代码本身逻辑的内聚性也更强</li><li>需在确保良好的阅读体验的情况下对初始数据、方法参数列表等进行合理换行，避免在网页中出现横向滚动条，保证一眼可以看到全部内容</li></ul><p>在得到最长公共子序列的长度的二维数组后，便可从最右下角位置开始回溯并打印最长公共子序列（时间复杂度为 <script type="math/tex">O(m+n)</script> ）：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_lcs</span><span class="params">(LCSLen lcs_len[][MAX_SEQ_LEN], <span class="keyword">int</span> seq_x[], <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span> || j == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lcs_len[i][j].dir == LEN_DIR_TOP_LEFT) &#123;</span><br><span class="line">        print_lcs(lcs_len, seq_x, i - <span class="number">1</span>, j - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// Note：i为序列X的下表，</span></span><br><span class="line">        <span class="comment">// 若要打印序列Y的元素，则应为 seq_y[j-1]</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%c "</span>, seq_x[i - <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(lcs_len[i][j].dir == LEN_DIR_TOP) &#123;</span><br><span class="line">        print_lcs(lcs_len, seq_x, i - <span class="number">1</span>, j);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        print_lcs(lcs_len, seq_x, i, j - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://blog.csdn.net/v_JULY_v/article/details/6110269" target="_blank" rel="noopener">动态规划算法解最长公共子序列LCS问题</a>：详细讲解了动态规划法的实现过程并给出了对空间复杂度进行优化后的实现代码</li><li><a href="https://blog.csdn.net/hrn1216/article/details/51534607" target="_blank" rel="noopener">动态规划最长公共子序列过程图解</a>：图例丰富有助于理解求解的动态过程</li><li><a href="https://blog.csdn.net/so_geili/article/details/53737001" target="_blank" rel="noopener">算法导论-最长公共子序列LCS（动态规划）</a>：介绍了蛮力搜索和动态规划两种方式，也同样给出了进行空间优化后的代码（实现较前面的文章更简单、清晰）。注：蛮力搜索的时间复杂度为 <script type="math/tex">O(n2^m)</script></li></ul><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>以下为完整的各方案代码，并包含性能测试：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_SEQ_LEN 50</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    LEN_DIR_LEFT,</span><br><span class="line">    LEN_DIR_TOP,</span><br><span class="line">    LEN_DIR_TOP_LEFT</span><br><span class="line">&#125; LCSLenDir;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LCSLen</span> &#123;</span></span><br><span class="line">    <span class="comment">// 最长公共子序列的长度</span></span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">    <span class="comment">// 长度求值基于哪个方向的结果，</span></span><br><span class="line">    <span class="comment">// 沿着该方向回溯便可反向找出对应的最长公共子序列</span></span><br><span class="line">    LCSLenDir dir;</span><br><span class="line">&#125; LCSLen;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_lcs</span><span class="params">(LCSLen lcs_len[][MAX_SEQ_LEN], <span class="keyword">int</span> seq_x[], <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lcs_search_dynamic_programming</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    LCSLen lcs_len[][MAX_SEQ_LEN]</span></span></span><br><span class="line"><span class="function"><span class="params">    , <span class="keyword">int</span> seq_x[], <span class="keyword">int</span> seq_y[]</span></span></span><br><span class="line"><span class="function"><span class="params">    , <span class="keyword">int</span> seq_x_len, <span class="keyword">int</span> seq_y_len</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> seq_x[] = &#123;<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'B'</span>, <span class="string">'D'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>&#125;;</span><br><span class="line">    <span class="comment">// int seq_x[] = &#123;'A', 'C', 'C', 'G', 'G', 'T', 'C'</span></span><br><span class="line">    <span class="comment">//                 , 'G', 'A', 'G', 'T', 'G', 'C', 'G'</span></span><br><span class="line">    <span class="comment">//                 , 'C', 'G', 'G', 'A', 'A', 'G', 'C'</span></span><br><span class="line">    <span class="comment">//                 , 'C', 'G', 'G', 'C', 'C', 'G', 'A'</span></span><br><span class="line">    <span class="comment">//                 , 'A'&#125;;</span></span><br><span class="line">    <span class="keyword">int</span> seq_x_len = <span class="keyword">sizeof</span>(seq_x) / <span class="keyword">sizeof</span>(seq_x[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> seq_y[] = &#123;<span class="string">'B'</span>, <span class="string">'D'</span>, <span class="string">'C'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'A'</span>&#125;;</span><br><span class="line">    <span class="comment">// int seq_y[] = &#123;'G', 'T', 'C', 'G', 'T', 'T', 'C'</span></span><br><span class="line">    <span class="comment">//                 , 'G', 'G', 'A', 'A', 'T', 'G', 'C'</span></span><br><span class="line">    <span class="comment">//                 , 'C', 'G', 'T', 'T', 'G', 'C', 'T'</span></span><br><span class="line">    <span class="comment">//                 , 'C', 'T', 'G', 'T', 'A', 'A', 'A'&#125;;</span></span><br><span class="line">    <span class="keyword">int</span> seq_y_len = <span class="keyword">sizeof</span>(seq_y) / <span class="keyword">sizeof</span>(seq_y[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    LCSLen lcs_len[MAX_SEQ_LEN][MAX_SEQ_LEN];</span><br><span class="line"></span><br><span class="line">    lcs_search_dynamic_programming(lcs_len, seq_x, seq_y, seq_x_len, seq_y_len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"最长公共子序列的长度为: %d\n"</span>, lcs_len[seq_x_len][seq_y_len].value);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"其中一个最长公共子序列为: "</span>);</span><br><span class="line">    print_lcs(lcs_len, seq_x, seq_x_len, seq_y_len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Note：二维数组作为参数时，必须指定第二维的长度</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lcs_search_dynamic_programming</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    LCSLen lcs_len[][MAX_SEQ_LEN]</span></span></span><br><span class="line"><span class="function"><span class="params">    , <span class="keyword">int</span> seq_x[], <span class="keyword">int</span> seq_y[]</span></span></span><br><span class="line"><span class="function"><span class="params">    , <span class="keyword">int</span> seq_x_len, <span class="keyword">int</span> seq_y_len</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 将(i,0)的单元格全部置为0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= seq_x_len; i++) &#123;</span><br><span class="line">        lcs_len[i][<span class="number">0</span>].value = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将(0,j)的单元格全部置为0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= seq_y_len; j++) &#123;</span><br><span class="line">        lcs_len[<span class="number">0</span>][j].value = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 沿着二维数组的i轴从上到下依次沿着j轴从左到右计算公共子序列的长度</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= seq_x_len; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= seq_y_len; j++) &#123;</span><br><span class="line">            <span class="comment">// f[i][j] = f[i-1][j-1] + 1, x[i] = y[j]</span></span><br><span class="line">            <span class="comment">// Note：数组seq_x与seq_y的元素是从0开始的</span></span><br><span class="line">            <span class="keyword">if</span> (seq_x[i - <span class="number">1</span>] == seq_y[j - <span class="number">1</span>]) &#123;</span><br><span class="line">                lcs_len[i][j].value = lcs_len[i - <span class="number">1</span>][j - <span class="number">1</span>].value + <span class="number">1</span>;</span><br><span class="line">                lcs_len[i][j].dir = LEN_DIR_TOP_LEFT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// f[i][j] = max(f[i-1][j], f[i][j-1])</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (lcs_len[i - <span class="number">1</span>][j].value &gt;= lcs_len[i][j - <span class="number">1</span>].value) &#123;</span><br><span class="line">                lcs_len[i][j].value = lcs_len[i - <span class="number">1</span>][j].value;</span><br><span class="line">                lcs_len[i][j].dir = LEN_DIR_TOP;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                lcs_len[i][j].value = lcs_len[i][j - <span class="number">1</span>].value;</span><br><span class="line">                lcs_len[i][j].dir = LEN_DIR_LEFT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_lcs</span><span class="params">(LCSLen lcs_len[][MAX_SEQ_LEN], <span class="keyword">int</span> seq_x[], <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span> || j == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lcs_len[i][j].dir == LEN_DIR_TOP_LEFT) &#123;</span><br><span class="line">        print_lcs(lcs_len, seq_x, i - <span class="number">1</span>, j - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// Note：i为序列X的下表，</span></span><br><span class="line">        <span class="comment">// 若要打印序列Y的元素，则应为 seq_y[j-1]</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%c "</span>, seq_x[i - <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(lcs_len[i][j].dir == LEN_DIR_TOP) &#123;</span><br><span class="line">        print_lcs(lcs_len, seq_x, i - <span class="number">1</span>, j);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        print_lcs(lcs_len, seq_x, i, j - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 算法分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 动态规划 </tag>
            
            <tag> 最长公共子序列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>算法分析：求解最大子段和</title>
      <link href="/algorithm-calculating-maximum-interval-sum/"/>
      <url>/algorithm-calculating-maximum-interval-sum/</url>
      
        <content type="html"><![CDATA[<blockquote><p>算法分析系列文章中的代码可被任何人无偿使用于任何场景且无需注明来源也不必在使用前征得本文作者同意。</p><p>算法分析系列文章旨在传播准确、完整、简洁、易懂、规范的代码实现，并传授基本的编程思想和良好的编码习惯与技巧。</p><p>若文章中的代码存在问题或逻辑错误，请通过邮件等形式（见文章结尾）告知于本文作者以便及时修正错误或改进代码。</p><p>算法系列文章不可避免地会参考和学习众多网友的成果，在行文风格、内容及求解思路上也会进行借鉴，如有侵权嫌疑，请联系本文作者。</p><p>PS：若为转载该文章，请务必注明来源，本站点欢迎大家转载。</p></blockquote><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>给定一个<strong>整数</strong>（正负数不限）序列 $a_1, a_2, a_3, …, a_n$ ，从该序列中选取任意<strong>相邻</strong>的一段求和（简称为「子段和」），求解该序列的<strong>最大子段和</strong>。注：若整个序列的所有元素均为负数，则其最大子段和固定为0。</p><p>例如，序列<code>[64, -24, 88, -39, -54, 16]</code>的最大子段和为<code>128</code>（= <code>64 + (-24) + 88</code>）。<br><a id="more"></a></p><h2 id="求解方案"><a href="#求解方案" class="headerlink" title="求解方案"></a>求解方案</h2><h3 id="穷举法"><a href="#穷举法" class="headerlink" title="穷举法"></a>穷举法</h3><p>穷举法就是从 $a_0$ 开始依次计算 <script type="math/tex">a_0, a_0 + a_1, a_0 + a_1 + a_2, a_0 + a_1 + ... + a_n</script> 并取其中的最大值，再从 $a_1$ 开始依次计算 <script type="math/tex">a_1, a_1 + a_2, a_1 + a_2 + ... + a_n</script> 并取其中的最大值，以此往复，直到 $a_n$ 为止，并取每次计算过程中的最大值，得到的最终结果即为所求。</p><p>该穷举过程用代码实现即为：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SubseqSum</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> value; <span class="comment">// 序列区间求和后的值</span></span><br><span class="line">    <span class="keyword">int</span> start; <span class="comment">// 求和区间的开始位置</span></span><br><span class="line">    <span class="keyword">int</span> end; <span class="comment">// 求和区间的结束位置</span></span><br><span class="line">&#125; SubseqSum;</span><br><span class="line"></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_force</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> seq_len)</span> </span>&#123;</span><br><span class="line">    SubseqSum max_sum = &#123; .value = <span class="number">0</span>, .start = <span class="number">0</span>, .end = <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; seq_len; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; seq_len; j++) &#123;</span><br><span class="line">            <span class="comment">// 计算从i到j这个区间的和</span></span><br><span class="line">            <span class="keyword">int</span> sum_value = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = i; k &lt;= j; k++) &#123;</span><br><span class="line">                sum_value += seq[k];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 当i到j的区间的和大于当前已记录的最大子段和时，更新该最大子段和为该区间的和</span></span><br><span class="line">            <span class="keyword">if</span> (sum_value &gt; max_sum_value) &#123;</span><br><span class="line">                max_sum_value = sum_value;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新最大子段和的结果及其求和区间</span></span><br><span class="line">                max_sum.value = max_sum_value;</span><br><span class="line">                max_sum.start = i;</span><br><span class="line">                max_sum.end = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>这里定义了结构体<code>SubseqSum</code>用于同时记录子段和及其求和区间，可便于对最终结果进行人工复查以验证代码的正确性</li><li>在<code>for</code>、<code>if ... else ...</code>等分支中即使仅有一行代码，甚至没有代码（如，<code>while (true) {}</code>），也不要省略花括号（<code>{}</code>），这是避免代码混乱、提升代码可读性和准确性的前提</li><li>通过指针类型的参数来获取函数内部的过程数据（如，<code>int max_subseq_sum(int seq[], int seq_len, int &amp;begin, int &amp;end) {...}</code>）的方式不是一种良好的编码习惯。虽然，许多编程语言的函数不支持返回多值，但通过结构体等方式可以更好地达到目的（甚至好于返回多值），最终的代码也会更易阅读和理解</li></ul><p>本例用到了三层循环，其时间复杂度为 $O(n^3)$ 。但仔细分析后可以发现，在第三层循环中，从 $i$ 到 $j$ 区间的和会被重复计算多次，即，存在计算序列 <script type="math/tex">a_i, a_i + a_{i+1}, a_i + a_{i+1} + a_{i+2}, a_i + a_{i+1} + ... + a_{j-1} + a_j</script> ，而实际上， <script type="math/tex">a_i + ... + a_{j-1}</script> 已经被计算过了，没有必要再重复计算，若将其存放在变量 $tmp$ 中（即， <script type="math/tex">tmp = a_i + a_{i+1} + ... + a_{j-1}</script> ），则计算 <script type="math/tex">a_i + a_{i+1} + ... + a_{j-1} + a_j</script> 的值，等效于计算 <script type="math/tex">tmp + a_j</script> 的值。</p><p>按照以上思路，可将上面的穷举实现改进为如下代码（时间复杂度为 $O(n^2)$ ）：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SubseqSum</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> value; <span class="comment">// 序列区间求和后的值</span></span><br><span class="line">    <span class="keyword">int</span> start; <span class="comment">// 求和区间的开始位置</span></span><br><span class="line">    <span class="keyword">int</span> end; <span class="comment">// 求和区间的结束位置</span></span><br><span class="line">&#125; SubseqSum;</span><br><span class="line"></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_force_adv</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> seq_len)</span> </span>&#123;</span><br><span class="line">    SubseqSum max_sum = &#123; .value = <span class="number">0</span>, .start = <span class="number">0</span>, .end = <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; seq_len; i++) &#123;</span><br><span class="line">        <span class="comment">// 通过sum_value记录从i到j-1这个区间的和，</span></span><br><span class="line">        <span class="comment">// 当求解i到j区间的和时，其便等效于sum_value+seq[j]</span></span><br><span class="line">        <span class="keyword">int</span> sum_value = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; seq_len; j++) &#123;</span><br><span class="line">            sum_value += seq[j];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sum_value &gt; max_sum_value) &#123;</span><br><span class="line">                max_sum_value = sum_value;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新最大子段和的结果及其求和区间</span></span><br><span class="line">                max_sum.value = max_sum_value;</span><br><span class="line">                max_sum.start = i;</span><br><span class="line">                max_sum.end = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="分治法"><a href="#分治法" class="headerlink" title="分治法"></a>分治法</h3><blockquote><p>分治法，即，把一个复杂的问题分成两个或更多的相同或相似的子问题，直到最后子问题可以简单的直接求解，原问题的解即子问题的解的合并。（引用自「维基百科」）</p></blockquote><p>通过分治法的思想，可以将序列 <script type="math/tex">a_1, a_2, ..., a_n</script> <strong>等分</strong>为两部分，即， <script type="math/tex">a_1, a_2, ..., a_{\frac{n}{2}}</script> （称为<strong>左子序列</strong>） 与 <script type="math/tex">a_{\frac{n}{2}+1}, a_{\frac{n}{2}+2}, ..., a_n</script> （称为<strong>右子序列</strong>） 两个子序列，再分别求解这两个子序列的最大子段和。最终原序列的最大子段和的求解便存在以下情况：</p><ul><li>原序列的最大子段和等于左子序列的最大子段和</li><li>原序列的最大子段和等于右子序列的最大子段和</li><li>原序列的最大子段和为 <script type="math/tex">\sum_{k=i}^{j} a_k</script> ，其中， <script type="math/tex">1 \leq i \leq \frac{n}{2}, \frac{n}{2}+1 \leq j \leq n</script></li></ul><p>前两种情况通过递归可以得到结果，而对于第三种情况，可以从 $\frac{n}{2}$ 和 $\frac{n}{2}+1$ 开始分别向左右两边求和，即，定义如下表达式：</p><script type="math/tex; mode=display">\begin{align}s1 &= \max_{1 \leq i \leq \frac{n}{2}} \bigg\{ \sum_{k=\frac{n}{2}}^{i} a_k \bigg\} & \Leftrightarrow s1 &= \max\bigg\{ a_{\frac{n}{2}}, a_{\frac{n}{2}} + a_{\frac{n}{2}-1}, ..., a_{\frac{n}{2}} + a_{\frac{n}{2}-1} + ... + a_2 + a_1 \bigg\}, i=i-1 \rightarrow 1 \\s2 &= \max_{\frac{n}{2}+1 \leq j \leq n} \bigg\{ \sum_{k=\frac{n}{2}+1}^{j} a_k \bigg\} & \Leftrightarrow s2 &= \max\bigg\{ a_{\frac{n}{2}+1}, a_{\frac{n}{2}+1} + a_{\frac{n}{2}+2}, ..., a_{\frac{n}{2}+1} + a_{\frac{n}{2}+2} + ... + a_{n-1} + a_n \bigg\}, j=j+1 \rightarrow n\end{align}</script><p>则 <script type="math/tex">s1+s2</script> 即为第三种情况的最优解。注意，为了准确传达出向左右两边<strong>推进</strong>求和的过程，这里对求和公式做了变换，让 $k$ 始终从中间位置（即 <script type="math/tex">\frac{n}{2}</script> 和 <script type="math/tex">\frac{n}{2}+1</script> 处）开始向 <script type="math/tex">i</script> 递减或向 <script type="math/tex">j</script> 递增。</p><p>根据以上分析可编写其实现代码为（时间复杂度为 $O(n\log n)$ ）：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SubseqSum</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> value; <span class="comment">// 序列区间求和后的值</span></span><br><span class="line">    <span class="keyword">int</span> start; <span class="comment">// 求和区间的开始位置</span></span><br><span class="line">    <span class="keyword">int</span> end; <span class="comment">// 求和区间的结束位置</span></span><br><span class="line">&#125; SubseqSum;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">max</span><span class="params">(<span class="keyword">int</span> num0, <span class="keyword">int</span> num1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> num0 &gt; num1 ? num0 : num1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_divide</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">        <span class="keyword">return</span> (SubseqSum) &#123;</span><br><span class="line">            .value = max(<span class="number">0</span>, seq[left]),</span><br><span class="line">            .start = left,</span><br><span class="line">            .end = left</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> center = (left + right) / <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 计算左边区间的最大子段和</span></span><br><span class="line">    SubseqSum left_max_sum = max_subseq_sum_divide(seq, left, center);</span><br><span class="line">    <span class="comment">// 计算右边区间的最大子段和</span></span><br><span class="line">    SubseqSum right_max_sum = max_subseq_sum_divide(seq, center + <span class="number">1</span>, right);</span><br><span class="line">    <span class="comment">// 计算从中间位置向左右区间的最大子段和</span></span><br><span class="line">    SubseqSum center_max_sum = max_subseq_sum_divide_for_center(seq, center, left, right);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 三个部分的最大结果即为所求的最大子段和</span></span><br><span class="line">    SubseqSum max_sum = center_max_sum;</span><br><span class="line">    <span class="keyword">if</span>(max_sum.value &lt; left_max_sum.value) &#123;</span><br><span class="line">        max_sum = left_max_sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(max_sum.value &lt; right_max_sum.value) &#123;</span><br><span class="line">        max_sum = right_max_sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从中间位置开始对该位置左右两边子段进行求和</span></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_divide_for_center</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> center, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">    SubseqSum max_sum = &#123; .value = <span class="number">0</span>, .start = center, .end = center &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [left, ..., center, center + 1, ..., right]</span></span><br><span class="line">    <span class="comment">//           &lt;-- i       j --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先从center开始向左推进以计算左边子段求和的最大值：</span></span><br><span class="line">    <span class="comment">// - i记录的是左边求和区间的左边界（右边界为center）</span></span><br><span class="line">    <span class="comment">// - 只有求和结果（left_sum_value）大于0才会推进</span></span><br><span class="line">    <span class="keyword">int</span> left_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> left_max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = center; i &gt;= left; i--) &#123;</span><br><span class="line">        left_sum_value += seq[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (left_sum_value &gt; left_max_sum_value) &#123;</span><br><span class="line">            left_max_sum_value = left_sum_value;</span><br><span class="line">            max_sum.start = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 再从center+1开始向右推进以计算右边子段求和的最大值：</span></span><br><span class="line">    <span class="comment">// - j记录的是右边求和区间的右边界（左边界为center+1）</span></span><br><span class="line">    <span class="comment">// - 只有求和结果（right_sum_value）大于0才会推进</span></span><br><span class="line">    <span class="keyword">int</span> right_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> right_max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = center + <span class="number">1</span>; j &lt;= right; j++) &#123;</span><br><span class="line">        right_sum_value += seq[j];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(right_sum_value &gt; right_max_sum_value) &#123;</span><br><span class="line">            right_max_sum_value = right_sum_value;</span><br><span class="line">            max_sum.end = j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后所求的子段和为左右两个子段的 最大求和值 之和</span></span><br><span class="line">    <span class="keyword">int</span> max_sum_value = left_max_sum_value + right_max_sum_value;</span><br><span class="line"></span><br><span class="line">    max_sum.value = max_sum_value;</span><br><span class="line">    <span class="comment">// 子段求和未向左推进（向左求和的结果依然为0）但向右推进（向右求和的结果大于0）了，</span></span><br><span class="line">    <span class="comment">// 则表示求和区间应该从右边开始</span></span><br><span class="line">    <span class="keyword">if</span> (left_max_sum_value == <span class="number">0</span> &amp;&amp; right_max_sum_value &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        max_sum.start = center + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 子段求和未向右推进（向右求和的结果依然为0）但向左推进（向左求和的结果大于0）了，</span></span><br><span class="line">    <span class="comment">// 则表示求和区间应该从左边开始</span></span><br><span class="line">    <span class="keyword">if</span> (right_max_sum_value == <span class="number">0</span> &amp;&amp; left_max_sum_value &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        max_sum.end = center;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 而若向左/向右均没有推进，则保持原地不动</span></span><br><span class="line">    <span class="keyword">if</span> (left_max_sum_value == <span class="number">0</span> &amp;&amp; right_max_sum_value == <span class="number">0</span>) &#123;</span><br><span class="line">        max_sum.start = max_sum.end = center;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>在实现代码中将上面提到的第三种情况提取出来以便对该特例进行独立分析，也避免了对前面的主过程的阅读和分析造成的干扰</li><li>在<code>max_subseq_sum_divide_for_center</code>的最后需要对求和区间的起止位置进行修正，具体内容见代码注释</li></ul><h3 id="动态规划法"><a href="#动态规划法" class="headerlink" title="动态规划法"></a>动态规划法</h3><p>在应用该方法之前，先来看看其数学的推导过程。</p><p>假设存在序列 $a_1, a_2, a_3, …, a_n$ ，记 $b_j$ 表示该序列从 $1$ 到 $j$ 的区间内的最大子段和，则其可用如下公式表示：</p><script type="math/tex; mode=display">b_j = \max_{1 \leq i \leq j} \bigg\{ \sum_{k=i}^{j} a_k \bigg\}, 1 \leq j \leq n</script><p>也就是以下等式成立：</p><script type="math/tex; mode=display">\begin{align}b_1 &= a_1 \\b_2 &= \max\{ a_1 + a_2, a_2 \} \\b_3 &= \max\{ a_1 + a_2 + a_3, a_2 + a_3, a_3 \}\end{align}</script><p>因此，求解整个序列的最大子段和 $F(n)$ 的数学公式即为：</p><script type="math/tex; mode=display">F(n) = \max_{1 \leq i \leq j \leq n} \bigg\{ \sum_{k=i}^{j} a_k \bigg\} = \max_{1 \leq j \leq n} \Bigg\{ \max_{1 \leq i \leq j} \bigg\{ \sum_{k=i}^{j} a_k \bigg\} \Bigg\} = \max_{1 \leq j \leq n}\{ b_j \}</script><p>也就是说，要求解整个序列的最大子段和，可以转化为计算从 $1$ 到 $n$ 的区间内的 $b_j$ （ $1 \leq j \leq n$ ） 的最大值。</p><p>而 $b_j$ 可以用递归表达式表示为：</p><script type="math/tex; mode=display">b_j = \max\{ b_{j - 1} + a_j, a_j \}, 1 \leq j \leq n</script><p>但是，当 <script type="math/tex">b_{j-1}</script> 小于等于0时，无论 <script type="math/tex">a_j</script> 为正还是负，最终 <script type="math/tex">b_{j-1}+a_j</script> 都将小于 <script type="math/tex">a_j</script> ，这时将有 <script type="math/tex">b_j=a_j</script> 成立，因此，最终 <script type="math/tex">b_j</script> 可表示为：</p><script type="math/tex; mode=display">b_j = \begin{cases}b_{j - 1} + a_j,    & b_{j - 1} > 0 \\a_j,                & b_{j - 1} \leq 0\end{cases}, 1 \leq j \leq n</script><p>以上推导过程需要仔细阅读和分析，在完全掌握该推导过程后，便可很容易编写出对应的求解代码（时间复杂度为 $O(n)$ ），即：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_SEQ_LEN 1000</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SubseqSum</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> value; <span class="comment">// 序列区间求和后的值</span></span><br><span class="line">    <span class="keyword">int</span> start; <span class="comment">// 求和区间的开始位置</span></span><br><span class="line">    <span class="keyword">int</span> end; <span class="comment">// 求和区间的结束位置</span></span><br><span class="line">&#125; SubseqSum;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">max</span><span class="params">(<span class="keyword">int</span> num0, <span class="keyword">int</span> num1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> num0 &gt; num1 ? num0 : num1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_dynamic_programming</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> seq_len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 求和序列：存放子段求和的中间结果，开始元素为传入序列的第0项</span></span><br><span class="line">    <span class="keyword">int</span> seq_sum[MAX_SEQ_LEN] = &#123; seq[<span class="number">0</span>] &#125;;</span><br><span class="line">    SubseqSum max_sum = &#123; .value = max(<span class="number">0</span>, seq_sum[<span class="number">0</span>]), .start = <span class="number">0</span>, .end = <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> expected_sum_start = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; seq_len; j++) &#123;</span><br><span class="line">        <span class="comment">// 向左看，若前面已计算的子段和大于0，则加上当前项后，可能会得到更大的子段和，</span></span><br><span class="line">        <span class="comment">// 即对应公式中的“b[j] = b[j-1] + a[j]”分支</span></span><br><span class="line">        <span class="keyword">if</span> (seq_sum[j - <span class="number">1</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            seq_sum[j] = seq_sum[j - <span class="number">1</span>] + seq[j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 而若前面已计算的子段和小于0，则丢弃该结果，从当前位置开始重新计算子段和，</span></span><br><span class="line">        <span class="comment">// 即对应公式中的“b[j] = a[j]”分支</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            seq_sum[j] = seq[j];</span><br><span class="line">            <span class="comment">// 但新的子段和不一定大于当前已得到的最大子段和，</span></span><br><span class="line">            <span class="comment">// 故，需临时存放该新子段的开始位置，待最大子段和被更新后再更新其所在的子段区间</span></span><br><span class="line">            expected_sum_start = j;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里取公式中的“b[j]”的最大值</span></span><br><span class="line">        <span class="keyword">if</span> (seq_sum[j] &gt; max_sum_value) &#123;</span><br><span class="line">            max_sum_value = seq_sum[j];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 应用新的子段和，并更新该子段的开始和结束位置</span></span><br><span class="line">            max_sum.value = max_sum_value;</span><br><span class="line">            max_sum.start = expected_sum_start;</span><br><span class="line">            max_sum.end = j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.cnblogs.com/youxin/p/3405268.html" target="_blank" rel="noopener">最大子段和问题总结</a>：涉及穷举法、分治法、动态规划法及改进</li><li><a href="https://blog.csdn.net/Netown_Ethereal/article/details/23865151" target="_blank" rel="noopener">动态规划之最大子段和</a>：对动态规划法的公式讲解较为详细</li><li><a href="https://blog.csdn.net/ccDLlyy/article/details/52244504" target="_blank" rel="noopener">最大子段和(分治与动态规划典例)</a>：对分治法讲解较为详细</li></ul><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>以下为完整的各方案代码，并包含性能测试：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt; // for gettimeofday()</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt; // for time()</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_SEQ_LEN 1000</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SubseqSum</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> value; <span class="comment">// 序列区间求和后的值</span></span><br><span class="line">    <span class="keyword">int</span> start; <span class="comment">// 求和区间的开始位置</span></span><br><span class="line">    <span class="keyword">int</span> end; <span class="comment">// 求和区间的结束位置</span></span><br><span class="line">&#125; SubseqSum;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">current_timestamp</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">max</span><span class="params">(<span class="keyword">int</span> num0, <span class="keyword">int</span> num1)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_random_sequence</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_sequence</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum_subseq</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_force</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> seq_len)</span></span>;</span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_force_adv</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> seq_len)</span></span>;</span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_divide</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span></span>;</span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_divide_for_center</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> center, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span></span>;</span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_dynamic_programming</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> seq_len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> seq_len = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">int</span> seq[MAX_SEQ_LEN];</span><br><span class="line">    init_random_sequence(seq, seq_len);</span><br><span class="line">    <span class="comment">// int seq[] = &#123;-31, 95, 62, -45, 13, 31, -77</span></span><br><span class="line">    <span class="comment">//                 , 22, 94, -65, -67, 50, -66, 28</span></span><br><span class="line">    <span class="comment">//                 , -98, -34, -97, -66, -84, 87, 32</span></span><br><span class="line">    <span class="comment">//                 , -28, 43, -75, -64, 24, 88, 39</span></span><br><span class="line">    <span class="comment">//                 , -54, -16, 89, 82, -81, 45, 61</span></span><br><span class="line">    <span class="comment">//                 , -62, -51, -4, -41, -32, -21, -37</span></span><br><span class="line">    <span class="comment">//                 , 32, 63, -44, -39, -30, -19, 71</span></span><br><span class="line">    <span class="comment">//                 , 77&#125;;</span></span><br><span class="line">    <span class="comment">// int seq[] = &#123;-5, 11, -4, 13, -4, -2&#125;;</span></span><br><span class="line">    <span class="comment">// int seq[] = &#123;0, 0, 0, 0, 0, 0&#125;; // 不同方法得到的求和区间会不同</span></span><br><span class="line">    <span class="comment">// int seq_len = sizeof(seq) / sizeof(seq[0]);</span></span><br><span class="line">    SubseqSum max_sum;</span><br><span class="line">    <span class="keyword">double</span> start_time, end_time;</span><br><span class="line"></span><br><span class="line">    print_sequence(seq, seq_len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n以上序列的最大子段和为:\n"</span>);</span><br><span class="line"></span><br><span class="line">    start_time = current_timestamp();</span><br><span class="line">    max_sum = max_subseq_sum_force(seq, seq_len);</span><br><span class="line">    end_time = current_timestamp();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- 穷举算法        : %d (求和区间: [%d, %d] +=&gt;&gt; %d), 耗时: %f毫秒\n"</span></span><br><span class="line">                , max_sum.value</span><br><span class="line">                , max_sum.start, max_sum.end</span><br><span class="line">                , sum_subseq(seq, max_sum.start, max_sum.end)</span><br><span class="line">                , end_time - start_time);</span><br><span class="line"></span><br><span class="line">    start_time = current_timestamp();</span><br><span class="line">    max_sum = max_subseq_sum_force_adv(seq, seq_len);</span><br><span class="line">    end_time = current_timestamp();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- 穷举算法(改进版): %d (求和区间: [%d, %d] +=&gt;&gt; %d), 耗时: %f毫秒\n"</span></span><br><span class="line">                , max_sum.value</span><br><span class="line">                , max_sum.start, max_sum.end</span><br><span class="line">                , sum_subseq(seq, max_sum.start, max_sum.end)</span><br><span class="line">                , end_time - start_time);</span><br><span class="line"></span><br><span class="line">    start_time = current_timestamp();</span><br><span class="line">    max_sum = max_subseq_sum_divide(seq, <span class="number">0</span>, seq_len - <span class="number">1</span>);</span><br><span class="line">    end_time = current_timestamp();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- 分治算法        : %d (求和区间: [%d, %d] +=&gt;&gt; %d), 耗时: %f毫秒\n"</span></span><br><span class="line">                , max_sum.value</span><br><span class="line">                , max_sum.start, max_sum.end</span><br><span class="line">                , sum_subseq(seq, max_sum.start, max_sum.end)</span><br><span class="line">                , end_time - start_time);</span><br><span class="line"></span><br><span class="line">    start_time = current_timestamp();</span><br><span class="line">    max_sum = max_subseq_sum_dynamic_programming(seq, seq_len);</span><br><span class="line">    end_time = current_timestamp();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- 动态规划算法    : %d (求和区间: [%d, %d] +=&gt;&gt; %d), 耗时: %f毫秒\n"</span></span><br><span class="line">                , max_sum.value</span><br><span class="line">                , max_sum.start, max_sum.end</span><br><span class="line">                , sum_subseq(seq, max_sum.start, max_sum.end)</span><br><span class="line">                , end_time - start_time);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 穷举（蛮力）法求解</span></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_force</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> seq_len)</span> </span>&#123;</span><br><span class="line">    SubseqSum max_sum = &#123; .value = <span class="number">0</span>, .start = <span class="number">0</span>, .end = <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; seq_len; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; seq_len; j++) &#123;</span><br><span class="line">            <span class="comment">// 计算从i到j这个区间的和</span></span><br><span class="line">            <span class="keyword">int</span> sum_value = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = i; k &lt;= j; k++) &#123;</span><br><span class="line">                sum_value += seq[k];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 当i到j的区间的和大于当前已记录的最大子段和时，更新该最大子段和为该区间的和</span></span><br><span class="line">            <span class="keyword">if</span> (sum_value &gt; max_sum_value) &#123;</span><br><span class="line">                max_sum_value = sum_value;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新最大子段和的结果及其求和区间</span></span><br><span class="line">                max_sum.value = max_sum_value;</span><br><span class="line">                max_sum.start = i;</span><br><span class="line">                max_sum.end = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 穷举法（改进版）求解</span></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_force_adv</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> seq_len)</span> </span>&#123;</span><br><span class="line">    SubseqSum max_sum = &#123; .value = <span class="number">0</span>, .start = <span class="number">0</span>, .end = <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; seq_len; i++) &#123;</span><br><span class="line">        <span class="comment">// 通过sum_value记录从i到j-1这个区间的和，</span></span><br><span class="line">        <span class="comment">// 当求解i到j区间的和时，其便等效于sum_value+seq[j]</span></span><br><span class="line">        <span class="keyword">int</span> sum_value = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; seq_len; j++) &#123;</span><br><span class="line">            sum_value += seq[j];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sum_value &gt; max_sum_value) &#123;</span><br><span class="line">                max_sum_value = sum_value;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新最大子段和的结果及其求和区间</span></span><br><span class="line">                max_sum.value = max_sum_value;</span><br><span class="line">                max_sum.start = i;</span><br><span class="line">                max_sum.end = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分治法求解</span></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_divide</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">        <span class="keyword">return</span> (SubseqSum) &#123;</span><br><span class="line">            .value = max(<span class="number">0</span>, seq[left]),</span><br><span class="line">            .start = left,</span><br><span class="line">            .end = left</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> center = (left + right) / <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 计算左边区间的最大子段和</span></span><br><span class="line">    SubseqSum left_max_sum = max_subseq_sum_divide(seq, left, center);</span><br><span class="line">    <span class="comment">// 计算右边区间的最大子段和</span></span><br><span class="line">    SubseqSum right_max_sum = max_subseq_sum_divide(seq, center + <span class="number">1</span>, right);</span><br><span class="line">    <span class="comment">// 计算从中间位置向左右区间的最大子段和</span></span><br><span class="line">    SubseqSum center_max_sum = max_subseq_sum_divide_for_center(seq, center, left, right);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 三个部分的最大结果即为所求的最大子段和</span></span><br><span class="line">    SubseqSum max_sum = center_max_sum;</span><br><span class="line">    <span class="keyword">if</span>(max_sum.value &lt; left_max_sum.value) &#123;</span><br><span class="line">        max_sum = left_max_sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(max_sum.value &lt; right_max_sum.value) &#123;</span><br><span class="line">        max_sum = right_max_sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分治法求解：从中间位置开始对该位置左右两边子段进行求和</span></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_divide_for_center</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> center, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">    SubseqSum max_sum = &#123; .value = <span class="number">0</span>, .start = center, .end = center &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [left, ..., center, center + 1, ..., right]</span></span><br><span class="line">    <span class="comment">//           &lt;-- i       j --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先从center开始向左推进以计算左边子段求和的最大值：</span></span><br><span class="line">    <span class="comment">// - i记录的是左边求和区间的左边界（右边界为center）</span></span><br><span class="line">    <span class="comment">// - 只有求和结果（left_sum_value）大于0才会推进</span></span><br><span class="line">    <span class="keyword">int</span> left_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> left_max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = center; i &gt;= left; i--) &#123;</span><br><span class="line">        left_sum_value += seq[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (left_sum_value &gt; left_max_sum_value) &#123;</span><br><span class="line">            left_max_sum_value = left_sum_value;</span><br><span class="line">            max_sum.start = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 再从center+1开始向右推进以计算右边子段求和的最大值：</span></span><br><span class="line">    <span class="comment">// - j记录的是右边求和区间的右边界（左边界为center+1）</span></span><br><span class="line">    <span class="comment">// - 只有求和结果（right_sum_value）大于0才会推进</span></span><br><span class="line">    <span class="keyword">int</span> right_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> right_max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = center + <span class="number">1</span>; j &lt;= right; j++) &#123;</span><br><span class="line">        right_sum_value += seq[j];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(right_sum_value &gt; right_max_sum_value) &#123;</span><br><span class="line">            right_max_sum_value = right_sum_value;</span><br><span class="line">            max_sum.end = j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后所求的子段和为左右两个子段的 最大求和值 之和</span></span><br><span class="line">    <span class="keyword">int</span> max_sum_value = left_max_sum_value + right_max_sum_value;</span><br><span class="line"></span><br><span class="line">    max_sum.value = max_sum_value;</span><br><span class="line">    <span class="comment">// 子段求和未向左推进（向左求和的结果依然为0）但向右推进（向右求和的结果大于0）了，</span></span><br><span class="line">    <span class="comment">// 则表示求和区间应该从右边开始</span></span><br><span class="line">    <span class="keyword">if</span> (left_max_sum_value == <span class="number">0</span> &amp;&amp; right_max_sum_value &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        max_sum.start = center + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 子段求和未向右推进（向右求和的结果依然为0）但向左推进（向左求和的结果大于0）了，</span></span><br><span class="line">    <span class="comment">// 则表示求和区间应该从左边开始</span></span><br><span class="line">    <span class="keyword">if</span> (right_max_sum_value == <span class="number">0</span> &amp;&amp; left_max_sum_value &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        max_sum.end = center;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 而若向左/向右均没有推进，则保持原地不动</span></span><br><span class="line">    <span class="keyword">if</span> (left_max_sum_value == <span class="number">0</span> &amp;&amp; right_max_sum_value == <span class="number">0</span>) &#123;</span><br><span class="line">        max_sum.start = max_sum.end = center;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态规划法求解</span></span><br><span class="line"><span class="function">SubseqSum <span class="title">max_subseq_sum_dynamic_programming</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> seq_len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 求和序列：存放子段求和的中间结果，开始元素为传入序列的第0项</span></span><br><span class="line">    <span class="keyword">int</span> seq_sum[MAX_SEQ_LEN] = &#123; seq[<span class="number">0</span>] &#125;;</span><br><span class="line">    SubseqSum max_sum = &#123; .value = max(<span class="number">0</span>, seq_sum[<span class="number">0</span>]), .start = <span class="number">0</span>, .end = <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> max_sum_value = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> expected_sum_start = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; seq_len; j++) &#123;</span><br><span class="line">        <span class="comment">// 向左看，若前面已计算的子段和大于0，则加上当前项后，可能会得到更大的子段和，</span></span><br><span class="line">        <span class="comment">// 即对应公式中的“b[j] = b[j-1] + a[j]”分支</span></span><br><span class="line">        <span class="keyword">if</span> (seq_sum[j - <span class="number">1</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            seq_sum[j] = seq_sum[j - <span class="number">1</span>] + seq[j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 而若前面已计算的子段和小于0，则丢弃该结果，从当前位置开始重新计算子段和，</span></span><br><span class="line">        <span class="comment">// 即对应公式中的“b[j] = a[j]”分支</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            seq_sum[j] = seq[j];</span><br><span class="line">            <span class="comment">// 但新的子段和不一定大于当前已得到的最大子段和，</span></span><br><span class="line">            <span class="comment">// 故，需临时存放该新子段的开始位置，待最大子段和被更新后再更新其所在的子段区间</span></span><br><span class="line">            expected_sum_start = j;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里取公式中的“b[j]”的最大值</span></span><br><span class="line">        <span class="keyword">if</span> (seq_sum[j] &gt; max_sum_value) &#123;</span><br><span class="line">            max_sum_value = seq_sum[j];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 应用新的子段和，并更新该子段的开始和结束位置</span></span><br><span class="line">            max_sum.value = max_sum_value;</span><br><span class="line">            max_sum.start = expected_sum_start;</span><br><span class="line">            max_sum.end = j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">max</span><span class="params">(<span class="keyword">int</span> num0, <span class="keyword">int</span> num1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> num0 &gt; num1 ? num0 : num1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前系统时间的毫秒值</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">current_timestamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">te</span>;</span></span><br><span class="line">    gettimeofday(&amp;te, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> msec = te.tv_sec * <span class="number">1000.0</span> + (te.tv_usec / <span class="number">1000.0</span>);</span><br><span class="line">    <span class="keyword">return</span> msec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_random_sequence</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// https://www.geeksforgeeks.org/rand-and-srand-in-ccpp/</span></span><br><span class="line">    srand(time(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="comment">// 取0-100之间的数并随机产生正负</span></span><br><span class="line">        seq[i] = (<span class="keyword">int</span>) (rand() * <span class="number">1.0</span> / RAND_MAX * <span class="number">100</span>) * (rand() % <span class="number">2</span> == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_sequence</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> columns = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%3d: %3d, "</span>, i, seq[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((i + <span class="number">1</span>) % columns == <span class="number">0</span> &amp;&amp; i &lt; len - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum_subseq</span><span class="params">(<span class="keyword">int</span> seq[], <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = (start &lt; end ? start : end); i &lt;= (end &gt; start ? end : start); i++) &#123;</span><br><span class="line">        sum += seq[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 算法分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 动态规划 </tag>
            
            <tag> 最大子段和 </tag>
            
            <tag> 分治法 </tag>
            
            <tag> 穷举法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>算法分析：求解斐波那契数列</title>
      <link href="/algorithm-calculating-fibonacci-numbers/"/>
      <url>/algorithm-calculating-fibonacci-numbers/</url>
      
        <content type="html"><![CDATA[<blockquote><p>算法分析系列文章中的代码可被任何人无偿使用于任何场景且无需注明来源也不必在使用前征得本文作者同意。</p><p>算法分析系列文章旨在传播准确、完整、简洁、易懂、规范的代码实现，并传授基本的编程思想和良好的编码习惯与技巧。</p><p>若文章中的代码存在问题或逻辑错误，请通过邮件等形式（见文章结尾）告知于本文作者以便及时修正错误或改进代码。</p><p>算法系列文章不可避免地会参考和学习众多网友的成果，在行文风格、内容及求解思路上也会进行借鉴，如有侵权嫌疑，请联系本文作者。</p><p>PS：若为转载该文章，请务必注明来源，本站点欢迎大家转载。</p></blockquote><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>从0和1开始，之后的每一个数均为前两个数的和，这样性质的数依次排列，便称为<a href="https://zh.wikipedia.org/wiki/%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97" target="_blank" rel="noopener">斐波那契数列</a>。即形成如下数列形式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, ...</span><br></pre></td></tr></table></figure><p>用数学公式表示该数列即为：</p><script type="math/tex; mode=display">F(n) = \begin{cases}0,                      & n = 0 \\1,                      & n = 1 \\F(n - 1) + F(n - 2),    & n >= 2\end{cases}</script><p>本案例所要解决的就是：给定一个整数<code>n</code>，求解斐波那契数列中第<code>n</code>项的数值。注意，<code>0</code>表示第零项，而不是第一项。<br><a id="more"></a></p><h2 id="求解方案"><a href="#求解方案" class="headerlink" title="求解方案"></a>求解方案</h2><h3 id="递归法"><a href="#递归法" class="headerlink" title="递归法"></a>递归法</h3><p>从斐波那契数列的数学公式可以很直观地想到通过<a href="https://zh.wikipedia.org/wiki/%E9%80%92%E5%BD%92" target="_blank" rel="noopener">递归</a>方法来求解（这里仅为代码片断，详细的见<a href="#附录">附录</a>）：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> fibonacci_recursion(<span class="keyword">uint32_t</span> n) &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fibonacci_recursion(n - <span class="number">1</span>) + fibonacci_recursion(n - <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>这里定义数列的数值为<code>uint64_t</code>类型，其所能表示的最大值大于<code>int</code>类型的数据，从而便于计算更大长度的数列</li></ul><p>以上递归过程可以用下图展示（以<code>n=9</code>为例）：</p><p><img src="/assets/images/algorithm/fibonacci-recursion-calling-binary-tree.png" alt="递归法求解斐波那契数列"></p><details><summary>Show graph description</summary><pre>@startdotdigraph G {    f9 [label="F(9)"]    f9_f8 [label="F(8)"]    f9_f7 [label="F(7)"]    f9_f8_f7 [label="F(7)"]    f9_f8_f6 [label="F(6)"]    f9_f7_f6 [label="F(6)"]    f9_f7_f5 [label="F(5)"]    f9_f8_f7_f6 [label="F(6)"]    f9_f8_f7_f5 [label="F(5)"]    f9_f8_f7_f6_f5 [label="F(5)"]    f9_f8_f7_f6_f4 [label="F(4)"]    f9 -> f9_f8    f9 -> f9_f7    f9_f8 -> f9_f8_f7    f9_f8 -> f9_f8_f6    f9_f7 -> f9_f7_f6    f9_f7 -> f9_f7_f5    f9_f8_f7 -> f9_f8_f7_f6    f9_f8_f7 -> f9_f8_f7_f5    f9_f8_f7_f6 -> f9_f8_f7_f6_f5    f9_f8_f7_f6 -> f9_f8_f7_f6_f4}@enddot</pre></details><p>从上图可以看出来，整个过程就是在计算<a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%8F%89%E6%A0%91" target="_blank" rel="noopener">二叉树</a>的根节点的数值（=左节点数值+右节点数值）。遍历所有节点的时间复杂度为 $O(2^n)$ ，该时间复杂度也就是递归的时间复杂度。</p><h3 id="动态规划法"><a href="#动态规划法" class="headerlink" title="动态规划法"></a>动态规划法</h3><p>从以上递归方案可以发现，在计算过程中出现了大量的重复计算，比如，在计算<code>F(9)</code>时需要计算<code>F(8)</code>与<code>F(7)</code>，而计算<code>F(8)</code>时，又要重新计算<code>F(7)</code>。而如果我们将<code>F(7)</code>的计算结果保留下来，则当<code>F(8)</code>计算完毕后，便可直接通过记录下来的<code>F(7)</code>与<code>F(8)</code>求和得到<code>F(9)</code>的结果。也就免去了对二叉树右子树的遍历过程，只需要自顶向下一直沿着左子树做遍历即可，所需时间为二叉树的高度<code>n</code>，时间复杂度也就变为 $O(n)$ 。</p><p>而对于包含重复求解的过程，采用<a href="https://zh.wikipedia.org/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92" target="_blank" rel="noopener">动态规划法</a>可以很好地避免该问题。</p><blockquote><p>动态规划在查找有很多<strong>重叠子问题</strong>的情况的最优解时有效。它将问题重新组合成子问题。为了避免多次解决这些子问题，它们的结果都逐渐被计算并被保存，从简单的问题直到整个问题都被解决。因此，动态规划保存递归时的结果，因而不会在解决同样的问题时花费时间。（引用自「维基百科」）</p></blockquote><p>以下为采用动态规划法的求解代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// uint64_t所能表示的最大整数为18446744073709551615,</span></span><br><span class="line"><span class="comment">// 而数列的第94项将大于该数，故，这里限定最大只能求解第93项的数值，</span></span><br><span class="line"><span class="comment">// 不过，由于数组索引为0的位置表示的为数列的第0项，故，数组的实际长度应为n+1，</span></span><br><span class="line"><span class="comment">// 而索引位置为n的元素即为数列的第n项数值</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_FIBONACCI_SIZE 94</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> fibonacci_dynamic_programming(<span class="keyword">uint32_t</span> n) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">uint64_t</span> fibonacci[MAX_FIBONACCI_SIZE] = &#123;<span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 数列的第n项不为0时，便可认定为已经计算过该项的值，直接返回，无需继续计算</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fibonacci[n] != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fibonacci[n];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 按照数列的数据公式递归求解第n项的值，并将其记录在数组中，这样，在左递归完成后，便不会再继续右递归了</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        fibonacci[n] = fibonacci_dynamic_programming(n - <span class="number">1</span>) + fibonacci_dynamic_programming(n - <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> fibonacci[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>这里采用C语言中的<strong>静态局部变量</strong>（<code>fibonacci</code>）来记录过程数据，可避免从外部传递数组，以提高接口的<strong>内聚性</strong>。若需要打印数列的所有项的数值，则可从外部传入数组，再将各项结果存储在该数组中，最后按序打印即可</li></ul><h3 id="迭代法"><a href="#迭代法" class="headerlink" title="迭代法"></a>迭代法</h3><blockquote><p>可能有同学会将该方法视为动态规划法的迭代版本，但是，本文却不是很赞同。</p><p>虽然，在该迭代过程中有存储数列前一项的计算结果，但其与动态规划存在的一个不同是，动态规划中所存储的计算结果不是立即被使用的，其是在遇到对相同项求值时才被调用的，且对其也可能存在多次调用的情况，而迭代过程中的计算结果只会被使用一次而且是立即使用。</p><p>所以，本文将这两种视为不同且独立的方法。</p></blockquote><p>其实，如果不考虑数学公式所造成的误导性以及对相关算法的学习的角度，而仅从对数列的描述来看，最直接的求解方法应该是迭代（即，循环）方式。因为，<strong>从第2项开始，数列的每项数值均为前两项的和</strong>。用代码表示即为：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> fibonacci_loop(<span class="keyword">uint32_t</span> n) &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 数列的第n项</span></span><br><span class="line">        <span class="keyword">uint64_t</span> fib_n = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 数列的第n-1项，初始为第1项，值为1</span></span><br><span class="line">        <span class="keyword">uint64_t</span> fib_n_1 = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 数列的第n-2项，初始为第0项，值为0</span></span><br><span class="line">        <span class="keyword">uint64_t</span> fib_n_2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始状态：</span></span><br><span class="line">        <span class="comment">// [...................n_2....n_1...n.....]</span></span><br><span class="line">        <span class="comment">//                      |      |    |</span></span><br><span class="line">        <span class="comment">// [0, 1, 1, 2, 3, 5, n - 2, n - 1, n, ...]</span></span><br><span class="line">        <span class="comment">// 向右平移后：</span></span><br><span class="line">        <span class="comment">// [.........................n_2...n_1..n.]</span></span><br><span class="line">        <span class="comment">//                            |     |</span></span><br><span class="line">        <span class="comment">// [0, 1, 1, 2, 3, 5, n - 2, n - 1, n, ...]</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="comment">// 数列的第n项 = 数列的第n-1项 + 数列的第n-2项</span></span><br><span class="line">            fib_n = fib_n_1 + fib_n_2;</span><br><span class="line">            <span class="comment">// 向右平移1项，即，</span></span><br><span class="line">            <span class="comment">// 上一次计算的第n-1项作为下一次计算的第n-2项，</span></span><br><span class="line">            <span class="comment">// 上一次计算的第n项作为下一次计算的第n-1项</span></span><br><span class="line">            fib_n_2 = fib_n_1;</span><br><span class="line">            fib_n_1 = fib_n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fib_n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从时间复杂度来看，该方法与动态规划法是一样的，二者的时间复杂度均为 $O(n)$ ，只是，从代码性能来看，迭代方式的空间复杂度为 $O(1)$ ，而且，由于递归需要消耗内存的<strong>栈空间</strong>并且调用过程中存在变量入栈出栈操作，因此，递归的性能会稍低于迭代的方式。</p><p>但是，在实际应用中，递归方式的代码会比迭代方式的代码更加直观和易读，并且其性能损耗一般可以忽略，故通常，以递归方式编写代码会更好。除非，递归的层次太深（数千上万级别的），造成线程栈空间不足时（线程的栈空间一般为固定大小，且多为几KB），这时，应该采用迭代（循环）方案去做代码实现。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.numberempire.com/fibonaccinumbers.php" target="_blank" rel="noopener">Fibonacci Numbers Generator</a>：计算斐波那契数列的站点，最大可计算数列第10000项的数值（有2090位数字）</li><li><a href="http://www.maths.surrey.ac.uk/hosted-sites/R.Knott/Fibonacci/fibtable.html" target="_blank" rel="noopener">The Fibonacci series</a>：列出了从0到300的斐波那契数列，可参照该数列检查以上代码计算结果的准确性</li><li><a href="https://en.wikibooks.org/wiki/C_Programming/stdint.h#Exact-width_integer_types" target="_blank" rel="noopener">C Programming/stdint.h</a>：C语言的整形类型及所表示的数值范围</li><li><a href="https://stackoverflow.com/questions/9225567/how-to-print-a-int64-t-type-in-c/9225648#answer-16221208" target="_blank" rel="noopener">How to print a int64_t type in C</a>：如何通过<code>printf</code>打印<code>uint64_t</code>类型的值 - <code>printf(&quot;a=%jd\n&quot;, a);</code></li><li><a href="https://www.cnblogs.com/python27/archive/2011/11/25/2261980.html" target="_blank" rel="noopener">【算法02】3种方法求解斐波那契数列</a>：可以了解和掌握矩阵乘法求解斐波那契数列</li><li><a href="http://web.ift.uib.no/Teori/KURS/WRK/TeX/symALL.html" target="_blank" rel="noopener">LaTeX Math Symbols</a></li></ul><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>以下为完整的各方案代码，并包含性能测试：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// uint64_t所能表示的最大整数为18446744073709551615,</span></span><br><span class="line"><span class="comment">// 而数列的第94项将大于该数，故，这里限定最大只能求解第93项的数值，</span></span><br><span class="line"><span class="comment">// 不过，由于数组索引为0的位置表示的为数列的第0项，故，数组的实际长度应为n+1，</span></span><br><span class="line"><span class="comment">// 而索引位置为n的元素即为数列的第n项数值</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_FIBONACCI_SIZE 94</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">current_timestamp</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">uint64_t</span> fibonacci_recursion(<span class="keyword">uint32_t</span> n);</span><br><span class="line"><span class="keyword">uint64_t</span> fibonacci_dynamic_programming(<span class="keyword">uint32_t</span> n);</span><br><span class="line"><span class="keyword">uint64_t</span> fibonacci_loop(<span class="keyword">uint32_t</span> n);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> fib = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">double</span> start_time, end_time;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//printf("Max uint64_t: %ju\n", UINT64_MAX);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"请输入斐波那契数列长度: "</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n);</span><br><span class="line">    <span class="keyword">if</span> (n &gt;= MAX_FIBONACCI_SIZE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"得到所求数列长度为%d, 但本系统支持的最大长度为%d\n"</span>, n, MAX_FIBONACCI_SIZE - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"斐波那契数列的第%d个数为:\n"</span>, n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">40</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"- 递归算法    : 无解（求值过于耗时！）\n"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        start_time = current_timestamp();</span><br><span class="line">        fib = fibonacci_recursion(n);</span><br><span class="line">        end_time = current_timestamp();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"- 递归算法    : %ju, 耗时: %f毫秒\n"</span>, fib, end_time - start_time);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note：需要通过格式控制符 %ju 来打印uint64_t类型的数据，</span></span><br><span class="line">    <span class="comment">// 否则，会出现因精度丢失而造成输出不准确的问题</span></span><br><span class="line">    start_time = current_timestamp();</span><br><span class="line">    fib = fibonacci_dynamic_programming(n);</span><br><span class="line">    end_time = current_timestamp();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- 动态规划算法: %ju, 耗时: %f毫秒\n"</span>, fib, end_time - start_time);</span><br><span class="line"></span><br><span class="line">    start_time = current_timestamp();</span><br><span class="line">    fib = fibonacci_loop(n);</span><br><span class="line">    end_time = current_timestamp();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- 迭代算法    : %ju, 耗时: %f毫秒\n"</span>, fib, end_time - start_time);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 递归法求解</span></span><br><span class="line"><span class="keyword">uint64_t</span> fibonacci_recursion(<span class="keyword">uint32_t</span> n) &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fibonacci_recursion(n - <span class="number">1</span>) + fibonacci_recursion(n - <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态规划法（Dynamic programming）求解</span></span><br><span class="line"><span class="keyword">uint64_t</span> fibonacci_dynamic_programming(<span class="keyword">uint32_t</span> n) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">uint64_t</span> fibonacci[MAX_FIBONACCI_SIZE] = &#123;<span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 数列的第n项不为0时，便可认定为已经计算过该项的值，直接返回，无需继续计算</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fibonacci[n] != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fibonacci[n];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 按照数列的数据公式递归求解第n项的值，并将其记录在数组中，这样，在左递归完成后，便不会再继续右递归了</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        fibonacci[n] = fibonacci_dynamic_programming(n - <span class="number">1</span>) + fibonacci_dynamic_programming(n - <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> fibonacci[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 迭代法求解</span></span><br><span class="line"><span class="keyword">uint64_t</span> fibonacci_loop(<span class="keyword">uint32_t</span> n) &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 数列的第n项</span></span><br><span class="line">        <span class="keyword">uint64_t</span> fib_n = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 数列的第n-1项，初始为第1项，值为1</span></span><br><span class="line">        <span class="keyword">uint64_t</span> fib_n_1 = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 数列的第n-2项，初始为第0项，值为0</span></span><br><span class="line">        <span class="keyword">uint64_t</span> fib_n_2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始状态：</span></span><br><span class="line">        <span class="comment">// [...................n_2....n_1...n.....]</span></span><br><span class="line">        <span class="comment">//                      |      |    |</span></span><br><span class="line">        <span class="comment">// [0, 1, 1, 2, 3, 5, n - 2, n - 1, n, ...]</span></span><br><span class="line">        <span class="comment">// 向右平移后：</span></span><br><span class="line">        <span class="comment">// [.........................n_2...n_1..n.]</span></span><br><span class="line">        <span class="comment">//                            |     |</span></span><br><span class="line">        <span class="comment">// [0, 1, 1, 2, 3, 5, n - 2, n - 1, n, ...]</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="comment">// 数列的第n项 = 数列的第n-1项 + 数列的第n-2项</span></span><br><span class="line">            fib_n = fib_n_1 + fib_n_2;</span><br><span class="line">            <span class="comment">// 向右平移1项，即，</span></span><br><span class="line">            <span class="comment">// 上一次计算的第n-1项作为下一次计算的第n-2项，</span></span><br><span class="line">            <span class="comment">// 上一次计算的第n项作为下一次计算的第n-1项</span></span><br><span class="line">            fib_n_2 = fib_n_1;</span><br><span class="line">            fib_n_1 = fib_n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fib_n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前系统时间的毫秒值</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">current_timestamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">te</span>;</span></span><br><span class="line">    gettimeofday(&amp;te, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> msec = te.tv_sec * <span class="number">1000.0</span> + (te.tv_usec / <span class="number">1000.0</span>);</span><br><span class="line">    <span class="keyword">return</span> msec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 算法分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 动态规划 </tag>
            
            <tag> 斐波那契 </tag>
            
            <tag> Fibonacci </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>算法分析：分治法求解给定集合中的众数及其重数</title>
      <link href="/algorithm-using-divide-and-conquer-method-to-find-the-mode-in-a-set/"/>
      <url>/algorithm-using-divide-and-conquer-method-to-find-the-mode-in-a-set/</url>
      
        <content type="html"><![CDATA[<blockquote><p>算法分析系列文章中的代码可被任何人无偿使用于任何场景且无需注明来源也不必在使用前征得本文作者同意。</p><p>算法分析系列文章旨在传播准确、完整、简洁、易懂、规范的代码实现，并传授基本的编程思想和良好的编码习惯与技巧。</p><p>若文章中的代码存在问题或逻辑错误，请通过邮件等形式（见文章结尾）告知于本文作者以便及时修正错误或改进代码。</p><p>算法系列文章不可避免地会参考和学习众多网友的成果，在行文风格、内容及求解思路上也会进行借鉴，如有侵权嫌疑，请联系本文作者。</p><p>PS：若为转载该文章，请务必注明来源，本站点欢迎大家转载。</p></blockquote><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>给定含有n个元素的多重集合<code>S</code>，每个元素在<code>S</code>中<u>出现的次数</u>称为该元素的<strong>重数</strong>。多重集<code>S</code>中<u>重数最大的元素</u>称为<a href="https://zh.wikipedia.org/wiki/%E4%BC%97%E6%95%B0_(%E6%95%B0%E5%AD%A6)" target="_blank" rel="noopener">众数</a>（<strong>mode</strong>）。</p><p>例如，<code>S={1，2，2，2，3，5}</code>，则，多重集<code>S</code>的众数是<code>2</code>，其重数为<code>3</code>。</p><blockquote><p>注：众数可能存在多个。</p></blockquote><p>本案例要求采用<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E6%B2%BB%E6%B3%95" target="_blank" rel="noopener">分治法</a>求解给定集合中的众数及其重数，存在多个众数时选择第一个即可。</p><blockquote><p>分治法，即，把一个复杂的问题分成两个或更多的相同或相似的子问题，直到最后子问题可以简单的直接求解，原问题的解即子问题的解的合并。（引用自「维基百科」）<br><a id="more"></a></p></blockquote><h2 id="求解思路"><a href="#求解思路" class="headerlink" title="求解思路"></a>求解思路</h2><p>分治法求解的基本思路就是将集合分成几个小部分，依次查找每个部分中的众数，再从每个部分中取出重数最大的数，该数即为所求解的众数。</p><p>在分治求解过程中，当枢轴元素（<strong>pivot</strong>）所在位置的左右两侧剩余的数据量均小于<code>pivot</code>的重数时，则求解结束且所求的众数即为<code>pivot</code>的值。</p><h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_mode; <span class="comment">// 众数值</span></span><br><span class="line"><span class="keyword">int</span> g_cnt = <span class="number">0</span>; <span class="comment">// 众数的重数值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 优先声明相关函数定义以便于按照阅读先后顺序排列函数实现</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">divide_find_mode</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> start_index, <span class="keyword">int</span> end_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sort_and_find_pivot</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> start_index, <span class="keyword">int</span> end_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_element</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> index_0, <span class="keyword">int</span> index_1)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//int data[] = &#123;'a', 'a', 'b', 'b', 'b', '1', '2', '1'&#125;;</span></span><br><span class="line">    <span class="keyword">int</span> data[] = &#123;<span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="comment">//int data[] = &#123;10&#125;;</span></span><br><span class="line">    <span class="comment">//int data[] = &#123;1, 2, 3&#125;;</span></span><br><span class="line">    <span class="comment">//int data[] = &#123;1, 2, 2, 2, 3, 3, 5, 6, 6, 6, 6&#125;;</span></span><br><span class="line">    <span class="comment">//int data[] = &#123;1, 2, 7, 7, 3, 5&#125;;</span></span><br><span class="line">    <span class="comment">//int data[] = &#123;3, 6, 7, 6, 4, 5&#125;;</span></span><br><span class="line">    <span class="keyword">int</span> len = <span class="keyword">sizeof</span>(data) / <span class="keyword">sizeof</span>(data[<span class="number">0</span>]);</span><br><span class="line">    divide_find_mode(data, <span class="number">0</span>, len - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"众数为: %d, 且其重数为: %d\n"</span>, g_mode, g_cnt);</span><br><span class="line">    <span class="comment">// 当集合元素为char类型时，使用以下方式输出结果</span></span><br><span class="line">    <span class="comment">//printf("众数为: %c, 且其重数为: %d\n", g_mode, g_cnt);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采用分治法查找集合data在指定范围（[start_index, end_index]区间）内的众数及其重数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">divide_find_mode</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> start_index, <span class="keyword">int</span> end_index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pivot_index = sort_and_find_pivot(data, start_index, end_index);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从右边开始统计与pivot相等的元素个数（包括pivot本身）</span></span><br><span class="line">    <span class="keyword">int</span> pivot_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = start_index; i &lt;= pivot_index; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (data[i] == data[pivot_index]) &#123;</span><br><span class="line">            pivot_cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录重数最大的元素及其重数值</span></span><br><span class="line">    <span class="keyword">if</span> (pivot_cnt &gt; g_cnt) &#123;</span><br><span class="line">        g_mode = data[pivot_index];</span><br><span class="line">        g_cnt = pivot_cnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若左边剩余元素数量大于当前的重数值，则继续寻找左边剩余元素（范围为[start_index, pivot_index - 1]）中的众数</span></span><br><span class="line">    <span class="comment">// 左边剩余元素数量 = 当前众数位置左移一位（pivot_index - 1） - 查询的开始位置序号 + 1</span></span><br><span class="line">    <span class="comment">// 如，数组&#123;1, 2, 3, 4， 5&#125;中3（其序号为2）左边剩余元素数量为2（即，2 - 1 - 0 + 1）</span></span><br><span class="line">    <span class="keyword">if</span> ((pivot_index - <span class="number">1</span>) - start_index + <span class="number">1</span> &gt; pivot_cnt) &#123;</span><br><span class="line">        divide_find_mode(data, start_index, pivot_index - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 若右边剩余元素数量大于当前的重数值，则继续寻找右边剩余元素（范围为[pivot_index + 1, end_index]）中的众数</span></span><br><span class="line">    <span class="comment">// 右边剩余元素数量 = 查询的结束位置序号 - 当前众数位置右移一位（pivot_index + 1） + 1</span></span><br><span class="line">    <span class="comment">// 如，数组&#123;1, 2, 3, 4， 5&#125;中3（其序号为2）右边剩余元素数量为2（即，4 - (2 + 1) + 1）</span></span><br><span class="line">    <span class="keyword">if</span> (end_index - (pivot_index + <span class="number">1</span>) + <span class="number">1</span> &gt; pivot_cnt) &#123;</span><br><span class="line">        divide_find_mode(data, pivot_index + <span class="number">1</span>, end_index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在集合data的指定范围（[start_index, end_index]区间）内选择一个枢轴元素（pivot）并进行排序，</span></span><br><span class="line"><span class="comment">// 以确保在该范围内pivot左边的元素均小于或等于pivot，而右边的则均大于pivot</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sort_and_find_pivot</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> start_index, <span class="keyword">int</span> end_index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 取开始位置的元素作为枢轴元素</span></span><br><span class="line">    <span class="keyword">int</span> pivot = data[start_index];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> left_index = start_index;</span><br><span class="line">    <span class="keyword">int</span> right_index = end_index;</span><br><span class="line">    <span class="comment">// 从两边向中间推进以调整元素位置，最终确保左边的元素小于或等于pivot，而右边的元素大于pivot</span></span><br><span class="line">    <span class="keyword">while</span> (left_index &lt; right_index) &#123;</span><br><span class="line">        <span class="comment">// 从右边向中间推进直到遇到小于或等于pivot的元素</span></span><br><span class="line">        <span class="keyword">while</span> (left_index &lt; right_index &amp;&amp; data[right_index] &gt; pivot) &#123;</span><br><span class="line">            right_index--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从左边向中间推进直到遇到大于pivot的元素</span></span><br><span class="line">        <span class="keyword">while</span> (left_index &lt; right_index &amp;&amp; data[left_index] &lt;= pivot) &#123;</span><br><span class="line">            left_index++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将 左边大于pivot的元素 与 右边小于或等于pivot的元素 交换位置</span></span><br><span class="line">        swap_element(data, left_index, right_index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Note：在排序过程中start_index位置的元素是不会变动位置的（其必然等于pivot），</span></span><br><span class="line">    <span class="comment">// 而left_index位置的元素为最后一个小于或等于pivot的元素，</span></span><br><span class="line">    <span class="comment">// 这时交换二者位置后，便可确保pivot左边的元素均小于或等于pivot了</span></span><br><span class="line">    swap_element(data, start_index, left_index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> left_index;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 交换集合data中两个指定元素位置（index_0与index_1）的数据</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_element</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> index_0, <span class="keyword">int</span> index_1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp = data[index_0];</span><br><span class="line"></span><br><span class="line">    data[index_0] = data[index_1];</span><br><span class="line">    data[index_1] = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上代码应该能够很容易看懂。这里主要强调以下几点：</p><ul><li>对外传播的代码应该尽量降低阅读者的理解难度以及<strong>时间成本</strong></li><li>变量名、函数名一定要能够清晰、准确地传达出其所代表的东西以及其职能，不要简单使用<code>i</code>、<code>j</code>等无意义的名称，更不要使用语义不清甚至是错误的单词</li><li>函数实现代码一般按照调用先后顺序和重要性进行排列以便于阅读并突出关键实现等</li><li>注释主要用于阐明流程、算法机制和原理、特殊代码技巧以及在调整或改进时需特别注意的事项等内容，切记不要对代码本身进行说明，说明也不要<strong>又臭又长</strong>。PS：本文为了能让刚入门的开发者看懂并阐述算法机制和过程，所以，注释写得比较详细，在实际开发中可以默认视为阅读者具备相关的算法基础，从而无需再对算法进行注释说明</li><li>一般通过<code>sizeof(data) / sizeof(data[0])</code>方式动态计算数组长度</li></ul><h2 id="实现改进"><a href="#实现改进" class="headerlink" title="实现改进"></a>实现改进</h2><p>上面的代码在调用<code>sort_and_find_pivot()</code>后存在一次遍历以获得<code>pivot</code>的重数（<code>pivot_cnt</code>），但实际上在<code>sort_and_find_pivot()</code>排序过程中已经存在等值比较，在这个时候是可以顺便得到<code>pivot</code>的重数的，只是限于C语言的函数只能返回一个值的约束而无法同时返回其重数。不过，C语言提供结构体类型，故而，可以通过在<code>sort_and_find_pivot()</code>后返回结构体的方式以避免不必要的遍历。</p><p>以下为改进后的代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Mode</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> value; <span class="comment">// 众数值</span></span><br><span class="line">    <span class="keyword">int</span> count; <span class="comment">// 众数重复次数，即重数</span></span><br><span class="line">    <span class="keyword">int</span> index; <span class="comment">// 主要用于在查找pivot时记录其最终位置</span></span><br><span class="line">&#125; Mode;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优先声明相关函数定义以便于按照阅读先后顺序排列函数实现</span></span><br><span class="line"><span class="function">Mode <span class="title">divide_find_mode</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> start_index, <span class="keyword">int</span> end_index)</span></span>;</span><br><span class="line"><span class="function">Mode <span class="title">sort_and_find_pivot</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> start_index, <span class="keyword">int</span> end_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_element</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> index_0, <span class="keyword">int</span> index_1)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">compare_mode</span><span class="params">(Mode mode_0, Mode mode_1)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//int data[] = &#123;'a', 'a', 'b', 'b', 'b', '1', '2', '1'&#125;;</span></span><br><span class="line">    <span class="keyword">int</span> data[] = &#123;<span class="number">2</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="comment">//int data[] = &#123;10&#125;;</span></span><br><span class="line">    <span class="comment">//int data[] = &#123;1, 2, 3&#125;;</span></span><br><span class="line">    <span class="comment">//int data[] = &#123;1, 2, 2, 2, 3, 3, 5, 6, 6, 6, 6&#125;;</span></span><br><span class="line">    <span class="comment">//int data[] = &#123;1, 2, 7, 7, 3, 5&#125;;</span></span><br><span class="line">    <span class="comment">//int data[] = &#123;3, 6, 7, 6, 4, 5&#125;;</span></span><br><span class="line">    <span class="keyword">int</span> len = <span class="keyword">sizeof</span>(data) / <span class="keyword">sizeof</span>(data[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    Mode mode = divide_find_mode(data, <span class="number">0</span>, len - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"众数为: %d, 且其重数为: %d\n"</span>, mode.value, mode.count);</span><br><span class="line">    <span class="comment">// 当集合元素为char类型时，使用以下方式输出结果</span></span><br><span class="line">    <span class="comment">//printf("众数为: %c, 且其重数为: %d\n", mode.value, mode.count);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采用分治法查找集合data在指定范围（[start_index, end_index]区间）内的众数及其重数</span></span><br><span class="line"><span class="function">Mode <span class="title">divide_find_mode</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> start_index, <span class="keyword">int</span> end_index)</span> </span>&#123;</span><br><span class="line">    Mode pivot = sort_and_find_pivot(data, start_index, end_index);</span><br><span class="line"></span><br><span class="line">    Mode mode = pivot;</span><br><span class="line">    <span class="comment">// 若左边剩余元素数量大于当前的重数值，则继续寻找左边剩余元素（范围为[start_index, pivot.index - 1]）中的众数</span></span><br><span class="line">    <span class="comment">// 左边剩余元素数量 = 当前众数位置左移一位（pivot.index - 1） - 查询的开始位置序号 + 1</span></span><br><span class="line">    <span class="comment">// 如，数组&#123;1, 2, 3, 4， 5&#125;中3（其序号为2）左边剩余元素数量为2（即，2 - 1 - 0 + 1）</span></span><br><span class="line">    <span class="keyword">if</span> ((pivot.index - <span class="number">1</span>) - start_index + <span class="number">1</span> &gt; pivot.count) &#123;</span><br><span class="line">        Mode m = divide_find_mode(data, start_index, pivot.index - <span class="number">1</span>);</span><br><span class="line">        mode = compare_mode(m, mode) &gt; <span class="number">0</span> ? m : mode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 若右边剩余元素数量大于当前的重数值，则继续寻找右边剩余元素（范围为[pivot.index + 1, end_index]）中的众数</span></span><br><span class="line">    <span class="comment">// 右边剩余元素数量 = 查询的结束位置序号 - 当前众数位置右移一位（pivot.index + 1） + 1</span></span><br><span class="line">    <span class="comment">// 如，数组&#123;1, 2, 3, 4， 5&#125;中3（其序号为2）右边剩余元素数量为2（即，4 - (2 + 1) + 1）</span></span><br><span class="line">    <span class="keyword">if</span> (end_index - (pivot.index + <span class="number">1</span>) + <span class="number">1</span> &gt; pivot.count) &#123;</span><br><span class="line">        Mode m = divide_find_mode(data, pivot.index + <span class="number">1</span>, end_index);</span><br><span class="line">        mode = compare_mode(m, mode) &gt; <span class="number">0</span> ? m : mode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在集合data的指定范围（[start_index, end_index]区间）内选择一个枢轴元素（pivot）并进行排序，</span></span><br><span class="line"><span class="comment">// 以确保在该范围内pivot左边的元素均小于或等于pivot，而右边的则均大于pivot</span></span><br><span class="line"><span class="function">Mode <span class="title">sort_and_find_pivot</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> start_index, <span class="keyword">int</span> end_index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> left_index = start_index;</span><br><span class="line">    <span class="keyword">int</span> right_index = end_index;</span><br><span class="line"></span><br><span class="line">    Mode pivot = &#123;</span><br><span class="line">        <span class="comment">// 取开始位置的元素作为枢轴元素</span></span><br><span class="line">        .value = data[start_index],</span><br><span class="line">        <span class="comment">// 当只有一个元素时，则不会进行排序，也就不会有等值判断，故，count将始终为1</span></span><br><span class="line">        .count = left_index == right_index ? <span class="number">1</span> : <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从两边向中间推进以调整元素位置，最终确保左边的元素小于或等于pivot，而右边的元素大于pivot</span></span><br><span class="line">    <span class="keyword">while</span> (left_index &lt; right_index) &#123;</span><br><span class="line">        <span class="comment">// 从右边向中间推进直到遇到小于或等于pivot的元素</span></span><br><span class="line">        <span class="keyword">while</span> (left_index &lt; right_index &amp;&amp; data[right_index] &gt; pivot.value) &#123;</span><br><span class="line">            right_index--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (left_index &lt; right_index &amp;&amp; data[right_index] == pivot.value) &#123;</span><br><span class="line">            pivot.count++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从左边向中间推进直到遇到大于pivot的元素</span></span><br><span class="line">        <span class="keyword">while</span> (left_index &lt; right_index &amp;&amp; data[left_index] &lt;= pivot.value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data[left_index] == pivot.value) &#123;</span><br><span class="line">                pivot.count++;</span><br><span class="line">            &#125;</span><br><span class="line">            left_index++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将 左边大于pivot的元素 与 右边小于或等于pivot的元素 交换位置</span></span><br><span class="line">        swap_element(data, left_index, right_index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Note：在排序过程中start_index位置的元素是不会变动位置的（其必然等于pivot），</span></span><br><span class="line">    <span class="comment">// 而left_index位置的元素为最后一个小于或等于pivot的元素，</span></span><br><span class="line">    <span class="comment">// 这时交换二者位置后，便可确保pivot左边的元素均小于或等于pivot了</span></span><br><span class="line">    swap_element(data, start_index, left_index);</span><br><span class="line"></span><br><span class="line">    pivot.index = left_index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pivot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 交换集合data中两个指定元素位置（index_0与index_1）的数据</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_element</span><span class="params">(<span class="keyword">int</span> data[], <span class="keyword">int</span> index_0, <span class="keyword">int</span> index_1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index_0 == index_1) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> temp = data[index_0];</span><br><span class="line"></span><br><span class="line">    data[index_0] = data[index_1];</span><br><span class="line">    data[index_1] = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">compare_mode</span><span class="params">(Mode mode_0, Mode mode_1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mode_0.count - mode_1.count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里主要强调以下几点：</p><ul><li>在离调用最近的位置处声明变量，避免变量声明位置与第一次使用位置相隔太远</li><li>结构体数据的初始化采用<a href="https://gcc.gnu.org/onlinedocs/gcc/Designated-Inits.html" target="_blank" rel="noopener">(ANSI) C99</a>方式以便于阅读，如，<code>struct point p = { .y = yvalue, .x = xvalue };</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分治法 </tag>
            
            <tag> 众数 </tag>
            
            <tag> 重数 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一次惊心动魄的CentOS系统升级经历</title>
      <link href="/a-horrible-os-upgrading-for-centos/"/>
      <url>/a-horrible-os-upgrading-for-centos/</url>
      
        <content type="html"><![CDATA[<h2 id="How-to-use-yum-history-to-roll-back-an-update"><a href="#How-to-use-yum-history-to-roll-back-an-update" class="headerlink" title="How to use yum history to roll back an update"></a><a href="https://access.redhat.com/solutions/64069" target="_blank" rel="noopener">How to use yum history to roll back an update</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># List all update histories</span></span><br><span class="line">yum <span class="built_in">history</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Undo the specified transaction</span></span><br><span class="line">yum <span class="built_in">history</span> undo &lt;transaction ID&gt;</span><br></pre></td></tr></table></figure><h2 id="Fix-‘has-missing-requires-of’"><a href="#Fix-‘has-missing-requires-of’" class="headerlink" title="Fix ‘has missing requires of’"></a><a href="https://www.linuxquestions.org/questions/linux-server-73/yum-update-errors-4175534903/#post5323670" target="_blank" rel="noopener">Fix ‘has missing requires of’</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cp -a /var/lib/rpm /var/lib/rpm.bak</span><br><span class="line">cp -a /var/lib/yum /var/lib/yum.bak</span><br><span class="line"></span><br><span class="line">yum check \</span><br><span class="line">    | grep <span class="string">"has missing requires of"</span> \</span><br><span class="line">    | awk <span class="string">'&#123;print $1&#125;'</span> \</span><br><span class="line">    | sed -E <span class="string">"s/^[0-9]+://g"</span> \</span><br><span class="line">    | <span class="keyword">while</span> <span class="built_in">read</span> p; <span class="keyword">do</span> rpm -e --nodeps <span class="variable">$p</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="Fix-‘is-a-duplicate-with’"><a href="#Fix-‘is-a-duplicate-with’" class="headerlink" title="Fix ‘is a duplicate with’"></a><a href="https://community.centminmod.com/threads/yum-duplicates-problem.13129/#post-55753" target="_blank" rel="noopener">Fix ‘is a duplicate with’</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cp -a /var/lib/rpm /var/lib/rpm.bak</span><br><span class="line">cp -a /var/lib/yum /var/lib/yum.bak</span><br><span class="line"></span><br><span class="line">yum check \</span><br><span class="line">    | grep <span class="string">"is a duplicate with"</span> \</span><br><span class="line">    | awk <span class="string">'&#123;print $1&#125;'</span> \</span><br><span class="line">    | sed -E <span class="string">"s/^[0-9]+://g"</span> \</span><br><span class="line">    | <span class="keyword">while</span> <span class="built_in">read</span> p; <span class="keyword">do</span> rpm -e --justdb --nodeps <span class="variable">$p</span>; <span class="keyword">done</span></span><br><span class="line">yum update</span><br><span class="line"></span><br><span class="line"><span class="comment"># If 'yum update' still get some duplicated packages, just running the following commands</span></span><br><span class="line"><span class="comment">## yum update | grep "is a duplicate with" | awk '&#123;print $1&#125;' | sed -E "s/^[0-9]+://g" | while read p; do rpm -e --justdb --nodeps $p; done</span></span><br><span class="line"><span class="comment">## yum update</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 运维管理 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CentOS </tag>
            
            <tag> 系统升级 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx特例场景配置</title>
      <link href="/the-special-case-configuration-of-nginx/"/>
      <url>/the-special-case-configuration-of-nginx/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文所使用的相关代码片段可从 <a href="https://github.com/flytreeleft/docker-nginx-gateway" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway</a> 得到完整内容。</p></blockquote><h2 id="Nginx随机展示自定义错误页面"><a href="#Nginx随机展示自定义错误页面" class="headerlink" title="Nginx随机展示自定义错误页面"></a>Nginx随机展示自定义错误页面</h2><blockquote><p>Source code: <a href="https://github.com/flytreeleft/docker-nginx-gateway/tree/master/config/error-pages" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway/tree/master/config/error-pages</a><br>Custom error pages: <a href="https://github.com/flytreeleft/docker-nginx-gateway/tree/master/examples/epage.d/all" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway/tree/master/examples/epage.d/all</a></p></blockquote><p><strong>关键字</strong>：</p><ul><li>随机展示多个错误页面</li><li>Nginx自定义错误页面</li></ul><p>在访问HTTP站点时最容易出现的错误就是404，于是就有许多非常有个性的404错误页面。而为我们自己的站点放置一些简洁、清爽的错误页面，在资源再利用的前提下，也将为我们自身增加不少好感和亲和力。</p><p>这里将要介绍的便是如何为我们的站点配置自定义错误页面，并同时支持为相同错误随机展示不同的错误页面。</p><a id="more"></a><h3 id="分类展示"><a href="#分类展示" class="headerlink" title="分类展示"></a>分类展示</h3><p>分类展示就是相同类型的错误使用同种风格的错误页面，这里简单分为<code>404</code>、<code>40x</code>（主要为400，401，403）、<code>50x</code>（主要为500，502，503，504），其配置内容如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Obmit the `[=[response]]` syntax to keep the error response code for clients.</span></span><br><span class="line"><span class="comment">## http://nginx.org/en/docs/http/ngx_http_core_module.html#error_page</span></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span>              /<span class="number">404</span>/;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">400</span> <span class="number">401</span> <span class="number">403</span>      /40x/;</span><br><span class="line"><span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x/;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> /<span class="number">404</span>/ &#123;</span><br><span class="line">    internal;</span><br><span class="line">    <span class="attribute">random_index</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span> /etc/nginx/epage.d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> /40x/ &#123;</span><br><span class="line">    internal;</span><br><span class="line">    <span class="attribute">random_index</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span> /etc/nginx/epage.d;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Replace the placeholders in response content</span></span><br><span class="line">    <span class="comment"># for showing the corresponding status and message.</span></span><br><span class="line">    <span class="attribute">sub_filter</span> <span class="string">'&#123;&#123;status&#125;&#125;'</span> <span class="string">'<span class="variable">$status</span>'</span>;</span><br><span class="line">    <span class="attribute">sub_filter</span> <span class="string">'&#123;&#123;status_msg&#125;&#125;'</span> <span class="string">'<span class="variable">$status_msg</span>'</span>;</span><br><span class="line">    <span class="attribute">sub_filter_once</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> /50x/ &#123;</span><br><span class="line">    internal;</span><br><span class="line">    <span class="attribute">random_index</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span> /etc/nginx/epage.d;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Replace the placeholders in response content</span></span><br><span class="line">    <span class="comment"># for showing the corresponding status and message.</span></span><br><span class="line">    <span class="attribute">sub_filter</span> <span class="string">'&#123;&#123;status&#125;&#125;'</span> <span class="string">'<span class="variable">$status</span>'</span>;</span><br><span class="line">    <span class="attribute">sub_filter</span> <span class="string">'&#123;&#123;status_msg&#125;&#125;'</span> <span class="string">'<span class="variable">$status_msg</span>'</span>;</span><br><span class="line">    <span class="attribute">sub_filter_once</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里将错误页面分别放置于<code>/etc/nginx/epage.d/404/</code>、<code>/etc/nginx/epage.d/40x/</code>、<code>/etc/nginx/epage.d/50x/</code>三个目录中，通过<code>random_index</code>指令可随机从这些目录中选择后缀为<code>html</code>的文件并返回给客户端，也就达到了错误页面随机展示的效果。<strong>注</strong>：1. <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#internal" target="_blank" rel="noopener">internal</a>指令限制了只能在Nginx内部请求该地址，外部访问将返回404错误；2. 若不需要随机展示的特性，在目录中始终放置一个HTML文件即可。</p><p>指令<a href="http://nginx.org/en/docs/http/ngx_http_sub_module.html#sub_filter" target="_blank" rel="noopener">sub_filter</a>用于过滤响应体中的特定字符串并替换为目标字符串。这里主要是替换<code>{{status}}</code>和<code>{{status_msg}}</code>（此为精确匹配，不能含其他字符）两个占位符以显示具体的错误码和错误信息，在错误页面中的合适位置引入这两个占位符即可。另外，<code>$status_msg</code>为与变量<code>$status</code>对应的状态信息，完整的映射关系见<a href="https://gist.github.com/tmthrgd/3504859568e1dba9ee80e260f974a708" target="_blank" rel="noopener">tmthrgd/nginx-status-text.conf</a>。<strong>注</strong>：<code>sub_filter_once off;</code>为启用多次替换，确保页面中所有的占位符均被替换。</p><p>在引入该配置时需注意，该配置内容需添加到每个站点（即<code>server {}</code>）配置中，暂时不知道如何进行全局配置。为了方便可将以上内容放到单独的文件中（如，<code>epage.conf</code>）再通过<code>include</code>指令引入该配置。</p><h3 id="统一展示"><a href="#统一展示" class="headerlink" title="统一展示"></a>统一展示</h3><p>统一展示就是所有错误都由相同页面展示，不同的只是显示的错误码和错误信息。以下为该方式的配置内容：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Obmit the `[=[response]]` syntax to keep the error response code for clients.</span></span><br><span class="line"><span class="comment">## http://nginx.org/en/docs/http/ngx_http_core_module.html#error_page</span></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> <span class="number">400</span> <span class="number">401</span> <span class="number">403</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>    /_/;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> /_/ &#123;</span><br><span class="line">    internal;</span><br><span class="line">    <span class="attribute">random_index</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># http://nginx.org/en/docs/http/ngx_http_core_module.html#alias</span></span><br><span class="line">    <span class="comment"># https://stackoverflow.com/questions/10631933/nginx-static-file-serving-confusion-with-root-alias#answer-10647080</span></span><br><span class="line">    <span class="attribute">alias</span> /etc/nginx/epage.d/all/;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Replace the placeholders in response content</span></span><br><span class="line">    <span class="comment"># for showing the corresponding status and message.</span></span><br><span class="line">    <span class="attribute">sub_filter</span> <span class="string">'&#123;&#123;status&#125;&#125;'</span> <span class="string">'<span class="variable">$status</span>'</span>;</span><br><span class="line">    <span class="attribute">sub_filter</span> <span class="string">'&#123;&#123;status_msg&#125;&#125;'</span> <span class="string">'<span class="variable">$status_msg</span>'</span>;</span><br><span class="line">    <span class="attribute">sub_filter_once</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的配置内容和注意事项与<code>分类展示</code>的基本相同，所不同的是，错误页面被放置在<code>/etc/nginx/epage.d/all/</code>目录中，与分类展示的目录独立，从而可按需自由转换展示模式。</p><h2 id="Nginx代理第三方http站点静态资源文件"><a href="#Nginx代理第三方http站点静态资源文件" class="headerlink" title="Nginx代理第三方http站点静态资源文件"></a>Nginx代理第三方http站点静态资源文件</h2><p><strong>关键字</strong>：</p><ul><li>HTTPS反向代理HTTP静态资源</li><li>单页面Markdown编写与渲染方案</li><li>Nginx反向代理重定向拦截处理</li></ul><p>这几天为部门搭建好了Maven仓库，为了便于指导部门同事能够准确配置并启用私有仓库，然后就打算写一份使用说明文档。</p><p>我不太喜欢写Word，也好几年几乎没用过了，一般都是直接写在部门的<a href="https://www.mediawiki.org/" target="_blank" rel="noopener">Wiki</a>系统上。不过，一份简单的文档写到Wiki上又不太方便查阅，于是找了找可以在单个HTML里写<a href="https://en.wikipedia.org/wiki/Markdown" target="_blank" rel="noopener">Markdown</a>并直接渲染展示的方案。</p><p>很快我就找到了<a href="https://github.com/chaitin/strapdown-zeta" target="_blank" rel="noopener">Strapdown Zeta</a>，其对Mardown的支持较为全面，并且使用很简单，还提供多套主题可自由切换。需要提到的是该库为<a href="https://github.com/arturadib/strapdown" target="_blank" rel="noopener">Strapdown</a>的衍生与改进版本，而<code>Strapdown</code>已经很长时间未更新了，选择<code>Strapdown Zeta</code>也是看重其活跃度。</p><p>在<code>Strapdown Zeta</code>的支持下仅需在<code>&lt;xmp&gt;&lt;/xmp&gt;</code>标签中编写Markdown并在最后引入 <a href="http://cdn.ztx.io/strapdown/strapdown.min.js" target="_blank" rel="noopener">http://cdn.ztx.io/strapdown/strapdown.min.js</a> 脚本即可。可惜的是，作者提供的该站点并未启用HTTPS，而我们在<a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a>的帮助下已经对部门的所有站点启用了HTTPS。这样，若在页面中引用非HTTPS资源，浏览器默认将阻止该资源的下载。</p><p>显然，这里不能直接在页面中引入该脚本，但是我也不愿再在站点上部署除使用文档之外的其他文件，就仅仅一个HTML文件即可，css什么的都不要有。</p><p>百般思索后，突然想到<a href="https://archive.org/" target="_blank" rel="noopener">Internet Archive</a>可以代理访问其他站点的页面，那我也可以专门为第三方静态资源搭建一个代理服务，该站点自身是HTTPS的，其在服务端获取到目标资源再返回给浏览器，这样该资源也就走的是HTTPS，既不用在服务器上存储这些资源，也可以自由代理其他第三方资源，而且不用管目标是不是HTTPS，甚至还可以代理一些无法访问到的资源。简单、经济、又实惠！:)</p><p>于是动手！这里假设代理站点为<code>https://static.example.com</code>，并构造代理链接为<code>https://static.example.com/*/&lt;target url&gt;</code>形式，这种结构可以方便Nginx做Location匹配，同时在使用和修改上均十分简单，我们不用改变目标资源的URL地址。</p><p>这里直接放出完整的配置：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> static.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/vhost.d/static.example.com/01_ssl.conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://static.example.com/*/http://others.com/asset.js -&gt; http://others.com/asset.js</span></span><br><span class="line">    <span class="comment">## https://www.mediasuite.co.nz/blog/proxying-s3-downloads-nginx/</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~* ^/\*/(http[s]?):?/(.*?)/(.*)$</span> &#123;</span><br><span class="line">        <span class="comment"># Note: Remove the directive 'internal;' to accept the external requests,</span></span><br><span class="line">        <span class="comment">#       otherwise it will return 404 for the external requests.</span></span><br><span class="line">        <span class="comment">#       See http://nginx.org/en/docs/http/ngx_http_core_module.html#internal</span></span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_protocol</span>   <span class="variable">$1</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_host</span>       <span class="variable">$2</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_path</span>       <span class="variable">$3</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_uri</span>        <span class="variable">$backend_host</span>/<span class="variable">$backend_path</span><span class="variable">$is_args</span><span class="variable">$args</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_url</span>        <span class="variable">$backend_protocol</span>://<span class="variable">$backend_uri</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Headers for the remote server, unset Authorization and Cookie for security reasons.</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$backend_host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Authorization <span class="string">''</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Cookie <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Stops the local disk from being written to (just forwards data through)</span></span><br><span class="line">        <span class="attribute">proxy_max_temp_file_size</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass</span> <span class="variable">$backend_url</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_intercept_errors</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">301</span> <span class="number">302</span> <span class="number">307</span> = <span class="variable">@handle_backend_redirect</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Nginx Embedded Variables: http://nginx.org/en/docs/varindex.html</span></span><br><span class="line">    <span class="attribute">location</span> <span class="variable">@handle_backend_redirect</span> &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">302</span> <span class="variable">$scheme</span>://<span class="variable">$host</span>/*/<span class="variable">$upstream_http_location</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>该配置参考的是<a href="https://www.mediasuite.co.nz/blog/proxying-s3-downloads-nginx/" target="_blank" rel="noopener">Using NGINX’s X-Accel with Remote URLs</a>。这里没有做特别的改动，主要是针对我们的实际需求做了些调整：</p><ul><li>去掉了<code>internal;</code>指令，该指令是限制仅能在Nginx内部做该代理请求，而我们是需要外部直接获取到目标资源的，因此，需要去掉该指令，否则，外部访问时将始终为<code>404</code>；</li><li>针对目标URL地址存在重定向问题，在<code>@handle_backend_redirect</code>中，我又将重定向地址（其对应变量<code>$upstream_http_location</code>）再次进行代理，这样无论目标跳转多少次，代理站点均能获取到最终的返回内容，而不是在浏览器中又突然跳到另一个HTTP链接了；</li></ul><p>最后提醒大家一点是，在网络中对安全要时刻保持警惕，尽可能降低敏感数据泄漏的风险，因此，这里切忌不要将客户端的<code>Authorization</code>和<code>Cookie</code>转发到目标站点了。</p><h2 id="Nginx通过Squid穿透防火墙"><a href="#Nginx通过Squid穿透防火墙" class="headerlink" title="Nginx通过Squid穿透防火墙"></a>Nginx通过Squid穿透防火墙</h2><blockquote><p>Source code: <a href="https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/static.example.com.conf" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/static.example.com.conf</a></p></blockquote><p><strong>关键字</strong>：</p><ul><li>Nginx http_proxy：<code>http_proxy</code>为Linux中配置启用正向代理的环境变量，很多命令可识别该变量并通过所设定的代理地址请求目标资源</li><li>Nginx防火墙穿透</li><li>Nginx over Squid</li><li>Squid behind Nginx</li><li>Nginx bypass firewall via Squid</li></ul><p>在前面提到，为了将HTTP请求转换为HTTPS请求，我专门搭建了个静态文件代理站点。刚开始访问还很正常，可后来便发现公司网关阻止了服务器对外部网站的访问，导致编写的文档无法渲染。</p><p>因此，我便考虑在Nginx服务端通过Squid（其他代理服务也可）再做一次代理以穿透公司的防火墙，确保静态资源的代理不再出现问题。</p><p>在多次尝试以及搜索网络资料后终于发现<a href="https://serverfault.com/questions/583743/how-to-make-an-existing-caching-nginx-proxy-use-another-proxy-to-bypass-a-firewa#683955" target="_blank" rel="noopener">How to make an existing caching Nginx proxy use another proxy to bypass a firewall?</a>所提到的实现方法。</p><p>在原配置的基础上综合改进后，得到新的配置内容如下：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> static.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/vhost.d/static.example.com/01_ssl.conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://static.example.com/*/http://others.com/asset.js -&gt; http://others.com/asset.js</span></span><br><span class="line">    <span class="comment">## https://www.mediasuite.co.nz/blog/proxying-s3-downloads-nginx/</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~* ^/\*/(http[s]?):?/(.*?)/(.*)$</span> &#123;</span><br><span class="line">        <span class="comment"># Note: Remove the directive 'internal;' to accept the external requests,</span></span><br><span class="line">        <span class="comment">#       otherwise it will return 404 for the external requests.</span></span><br><span class="line">        <span class="comment">#       See http://nginx.org/en/docs/http/ngx_http_core_module.html#internal</span></span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_protocol</span>   <span class="variable">$1</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_host</span>       <span class="variable">$2</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_path</span>       <span class="variable">$3</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_uri</span>        <span class="variable">$backend_host</span>/<span class="variable">$backend_path</span><span class="variable">$is_args</span><span class="variable">$args</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend_url</span>        <span class="variable">$backend_protocol</span>://<span class="variable">$backend_uri</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Headers for the remote server, unset Authorization and Cookie for security reasons.</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$backend_host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Authorization <span class="string">''</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Cookie <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Stops the local disk from being written to (just forwards data through)</span></span><br><span class="line">        <span class="attribute">proxy_max_temp_file_size</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Forward the target to the squid proxy</span></span><br><span class="line">        <span class="comment">## https://serverfault.com/questions/583743/how-to-make-an-existing-caching-nginx-proxy-use-another-proxy-to-bypass-a-firewa#683955</span></span><br><span class="line">        <span class="comment">## Hide the reponse header to protect the backend proxy</span></span><br><span class="line">        <span class="comment">### http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header</span></span><br><span class="line">        <span class="attribute">proxy_hide_header</span> Via;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> X-Cache;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> X-Cache-Hits;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> X-Cache-Lookup;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> X-Fastly-Request-ID;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> X-Served-By;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> X-Timer;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(.*)$</span>      <span class="string">"://<span class="variable">$backend_uri</span>"</span>           <span class="literal">break</span>;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(.*)$</span>      <span class="string">"<span class="variable">$backend_protocol</span><span class="variable">$1</span>"</span>       <span class="literal">break</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://&lt;squid ip&gt;:<span class="number">3128</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Proxy to the target directly</span></span><br><span class="line">        <span class="comment">#proxy_pass $backend_url;</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_intercept_errors</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">301</span> <span class="number">302</span> <span class="number">307</span> = <span class="variable">@handle_backend_redirect</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Nginx Embedded Variables: http://nginx.org/en/docs/varindex.html</span></span><br><span class="line">    <span class="attribute">location</span> <span class="variable">@handle_backend_redirect</span> &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">302</span> <span class="variable">$scheme</span>://<span class="variable">$host</span>/*/<span class="variable">$upstream_http_location</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里需要特别注意的是：</p><ul><li>这里做了两次<code>rewrite</code>是为了确保能够准确将目标URL地址附加到Squid的代理地址中以构成<code>http://&lt;squid ip&gt;:3128/&lt;target url&gt;</code>形式，同时，规避了因在<a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite" target="_blank" rel="noopener">rewrite</a>的替换字符串中包含<code>http://</code>、<code>https://</code>或<code>$scheme</code>而导致重定向的问题；</li><li>同样为了安全考虑，这里隐藏了Squid的几个响应头，避免客户端得到Squid的真实IP地址而产生潜在的攻击风险；</li></ul><h2 id="Nginx反向代理Nexus3的不同类型仓库"><a href="#Nginx反向代理Nexus3的不同类型仓库" class="headerlink" title="Nginx反向代理Nexus3的不同类型仓库"></a>Nginx反向代理Nexus3的不同类型仓库</h2><p><strong>关键字</strong>：</p><ul><li>Nginx反向代理</li><li>Nexus3不同类型仓库映射独立域名</li></ul><p><a href="https://help.sonatype.com/display/NXRM3" target="_blank" rel="noopener">Nexus3</a>同时支持多种类型的资源存储，比如，Docker镜像、Maven依赖包、NPM等，<br>不过，不同类型的资源访问方式和使用惯例是不一致的，因此，为每类资源提供符合惯例的仓库地址，再将请求转发到Nexus3仓库，对使用者而言将更加有好。</p><p>为此，本例针对Docker、Maven和NPM仓库分别给出Nginx的反向代理配置。</p><p>首先确定几个子站点的域名为如下形式：</p><ul><li><code>https://repo.example.com</code>：Nexus3服务访问地址</li><li><code>https://mvn.example.com</code>：Maven仓库访问地址</li><li><code>https://npm.example.com</code>：NPM仓库地址</li><li><code>https://dcr.example.com</code>：Docker镜像访问地址</li></ul><h3 id="https-repo-example-com的反向代理配置"><a href="#https-repo-example-com的反向代理配置" class="headerlink" title="https://repo.example.com的反向代理配置"></a><code>https://repo.example.com</code>的反向代理配置</h3><blockquote><p>Source code: <a href="https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/repo.example.com.conf#L15" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/repo.example.com.conf#L15</a></p></blockquote><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> repo.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/vhost.d/repo.example.com/01_ssl.conf;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_cache</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="comment"># Avoid to get address resolve error when starting</span></span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$nexus3</span> http://&lt;nexus3 ip&gt;:&lt;nexus3 web port&gt;;</span><br><span class="line">        <span class="attribute">proxy_pass</span> <span class="variable">$nexus3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对<code>https://repo.example.com</code>的配置很简单，直接将请求反向代理到Nexus3的Web接口即可。这里仅需要注意以下几点：</p><ul><li>为了避免Nginx缓存导致资源的元数据（<code>metadata</code>）不能及时更新，所以，这里启用了<code>proxy_cache off;</code>以关闭代理缓存。当然，也可以根据实际情况仅对某些类的文件关闭缓存</li><li>Nginx在解析配置时会对<code>proxy_pass</code>的目标域名地址进行解析，若是解析失败则会导致Nginx启动异常，因此，这里采用变量方式将解析延迟到需要时，从而避免启动失败</li></ul><h3 id="https-mvn-example-com的反向代理配置"><a href="#https-mvn-example-com的反向代理配置" class="headerlink" title="https://mvn.example.com的反向代理配置"></a><code>https://mvn.example.com</code>的反向代理配置</h3><blockquote><p>Source code: <a href="https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/repo.example.com.conf#L110" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/repo.example.com.conf#L110</a></p></blockquote><p>需要科普一下的是，在Nexus3中访问某个仓库内的资源的URL结构为<code>http://&lt;nexus3&gt;/#browse/browse/components:&lt;repo&gt;/</code>，访问某个资源的URL结构为<code>http://&lt;nexus3&gt;/repository/&lt;repo&gt;/&lt;asset path&gt;</code>。其中，<code>&lt;repo&gt;</code>为仓库名称，所有类型的仓库均会有<code>hosted</code>（私有存储）、<code>proxy</code>（代理外部仓库）和<code>group</code>（组合同类仓库）三种模式。</p><p>为了规范内部和外部访问并便于进行权限控制（如，外部帐号不允许访问<code>hosted</code>中的源码等），这里创建了以下几个仓库：</p><ul><li><code>maven-hosted-releases</code>：存储内部产品发布包。部署发布包时，向该仓库发送更新请求</li><li><code>maven-hosted-snapshots</code>：存储内部产品开发快照包。部署快照包时，向该仓库发送更新请求</li><li><code>maven-hosted</code>：<code>maven-hosted-*</code>的组合仓库。在Maven客户端更新依赖时，从该仓库下载内部产品的发布包或快照包</li><li><code>maven-&lt;3rd repo url&gt;</code>：对第三方仓库的代理仓库，<code>&lt;3rd repo url&gt;</code>为站点域名，比如，<code>maven-apache.org</code>。也可以按其他规范命名，只要能友好区分不同仓库即可</li><li><code>maven-public</code>：所有<code>maven-&lt;3rd repo url&gt;</code>的组合仓库。用于统一下载第三方的依赖包</li></ul><p>然后，我们期望在访问以下URL链接时，能够将请求转发到对应的资源上：</p><ul><li><code>GET https://mvn.example.com/public/&lt;asset&gt;</code> -&gt; <code>https://repo.example.com/repository/maven-public/&lt;asset&gt;</code></li><li><code>GET https://mvn.example.com/hosted/&lt;asset&gt;</code> -&gt; <code>https://repo.example.com/repository/maven-hosted/&lt;asset&gt;</code></li><li><code>GET https://mvn.example.com/releases/&lt;asset&gt;</code> -&gt; <code>https://repo.example.com/repository/maven-hosted/&lt;asset&gt;</code></li><li><code>GET https://mvn.example.com/snapshots/&lt;asset&gt;</code> -&gt; <code>https://repo.example.com/repository/maven-hosted/&lt;asset&gt;</code></li><li><code>POST https://mvn.example.com/releases/&lt;asset&gt;</code> -&gt; <code>https://repo.example.com/repository/maven-hosted-releases/&lt;asset&gt;</code></li><li><code>POST https://mvn.example.com/snapshots/&lt;asset&gt;</code> -&gt; <code>https://repo.example.com/repository/maven-hosted-snapshots/&lt;asset&gt;</code></li></ul><p>根据以上规范和需求，<code>https://mvn.example.com</code>的最终配置如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> mvn.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/vhost.d/mvn.example.com/01_ssl.conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Redirect to the maven repository (named as 'maven-public') of Nexus3</span></span><br><span class="line">    <span class="attribute">location</span> = / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">302</span> <span class="variable">$scheme</span>://repo.example.com/<span class="comment">#browse/browse/components:maven-public/;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># Redirect to the target asset of Nexus3</span></span><br><span class="line">    location <span class="regexp">~* ^/repository/maven-.+$</span> &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> <span class="variable">$scheme</span>://repo.example.com<span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Disable cache of assets</span></span><br><span class="line">    <span class="attribute">proxy_cache</span>            <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span>     <span class="number">300</span>;</span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span>  <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$nexus3</span> http://&lt;nexus3 ip&gt;:&lt;nexus3 web port&gt;;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> rewrite and proxy_pass should be put in the same block</span></span><br><span class="line">        <span class="comment">## http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite</span></span><br><span class="line">        <span class="comment"># web browse or `mvn compile`</span></span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$request_method</span> <span class="regexp">~* "^GET|HEAD$")</span> &#123;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^/public/(.*)</span>           /repository/maven-public/<span class="variable">$1</span>    <span class="literal">break</span>;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^/hosted/(.*)</span>           /repository/maven-hosted/<span class="variable">$1</span>    <span class="literal">break</span>;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^/releases/(.*)</span>         /repository/maven-hosted/<span class="variable">$1</span>    <span class="literal">break</span>;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^/snapshots/(.*)</span>        /repository/maven-hosted/<span class="variable">$1</span>    <span class="literal">break</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span>      <span class="variable">$nexus3</span>;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># `mvn deploy`</span></span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$request_method</span> <span class="regexp">~* "^POST|PUT$")</span> &#123;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^/(releases|snapshots)/(.*)</span>              /repository/maven-hosted-<span class="variable">$1</span>/<span class="variable">$2</span>   <span class="literal">break</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span>      <span class="variable">$nexus3</span>;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里需要注意以下几点：</p><ul><li>在前两个<code>location</code>匹配后均跳转到<code>https://repo.example.com</code>，因为，这两个地址的请求可认为只能是从浏览器发出的，直接跳转到Nexus3可让访问者了解我们使用的是Nexus3系统，从而尽快熟悉该系统，完全没有必要将Nexus3代理到<code>https://mvn.example.com</code>域名下</li><li><code>return 301</code>代表固定跳转，浏览器后续访问相同URL时将直接跳转到指定的目标，而不会再向服务器发送请求；而<code>return 302</code>为临时跳转，浏览器的后续访问依然会向服务器发送请求。对<code>= /</code>做临时跳转是因为我们可能会在该URL下放些说明文档之类的页面，如果做固定跳转，那么若后续支持该需求则只能在客户端清空浏览器<code>Cookie</code>后方能生效，对使用者会造成一定困扰</li><li>看过<a href="https://github.com/apache/maven" target="_blank" rel="noopener">Maven代码</a>可以发现其使用的<a href="https://hc.apache.org/httpcomponents-client-ga/" target="_blank" rel="noopener">HttpClient</a>库向仓库发送HTTP请求，所以，只需要对<code>$request_method</code>做匹配，将读请求转发到<code>maven-pulic</code>和<code>maven-hosted</code>两个组合仓库中，而将写请求转发到<code>maven-hosted-*</code>仓库即可</li></ul><p>剩下的就是调整Maven <code>settings.xml</code>。对普通的仅做依赖下载更新的配置为（<strong>仅列出主要内容，请按实际需求修改</strong>）：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://maven.apache.org/settings.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- Associated with &lt;repository/&gt; and &lt;pluginRepository/&gt; --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>your-repo-public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>your-repo-hosted<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>your-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>your-repo-public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mvn.example.com/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>your-repo-hosted<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mvn.example.com/hosted/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>your-repo-public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mvn.example.com/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>your-repo<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>而对需要向仓库部署包的配置则为（<strong>仅列出主要内容，请按实际需求修改</strong>）：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://maven.apache.org/settings.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- Associated with &lt;repository/&gt; and &lt;pluginRepository/&gt; --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>thirdparty<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>your-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mvn.example.com/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mvn.example.com/releases/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mvn.example.com/snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>thirdparty<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mvn.example.com/thirdparty/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mvn.example.com/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>your-repo<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意，Maven在更新时是按照<code>settings.xml</code>中定义的仓库顺序依次查找依赖直到内置的<a href="https://repo.maven.apache.org/maven2" target="_blank" rel="noopener">central</a>仓库，若在某个仓库中找到依赖则停止查找。因此，需要注意调整仓库的位置以避免因依赖同名而导致下载的内容与预期的不同。</p><h3 id="https-npm-example-com的反向代理配置"><a href="#https-npm-example-com的反向代理配置" class="headerlink" title="https://npm.example.com的反向代理配置"></a><code>https://npm.example.com</code>的反向代理配置</h3><blockquote><p>Source code: <a href="https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/repo.example.com.conf#L182" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/repo.example.com.conf#L182</a></p></blockquote><p><code>https://npm.example.com</code>与<code>https://mvn.example.com</code>的规划和注意事项基本一致，只是<code>npm-hosted</code>仓库直接使用<code>hosted</code>模式，因为NPM依赖包没有快照版本，而<code>npm-public</code>仓库依然为<code>group</code>模式，用于组合多个第三方仓库。</p><p>以下为对<code>https://npm.example.com</code>的完整配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> npm.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/vhost.d/npm.example.com/01_ssl.conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Redirect to the npm repository (named as 'npm-public') of Nexus3</span></span><br><span class="line">    <span class="attribute">location</span> = / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">302</span> <span class="variable">$scheme</span>://repo.example.com/<span class="comment">#browse/browse/components:npm-public/;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># Redirect to the target asset of Nexus3</span></span><br><span class="line">    location <span class="regexp">~* ^/repository/npm-.+$</span> &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> <span class="variable">$scheme</span>://repo.example.com<span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Disable cache of assets</span></span><br><span class="line">    <span class="attribute">proxy_cache</span>            <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span>     <span class="number">60</span>;</span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span>  <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$nexus3</span> http://&lt;nexus3 ip&gt;:&lt;nexus3 web port&gt;;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> rewrite and proxy_pass should be put in the same block</span></span><br><span class="line">        <span class="comment">## http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite</span></span><br><span class="line">        <span class="comment"># web browse or `npm install`</span></span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$request_method</span> <span class="regexp">~* "^GET$")</span> &#123;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^/(.+)</span>                      /repository/npm-public/<span class="variable">$1</span>      <span class="literal">break</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span>      <span class="variable">$nexus3</span>;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># `npm publish`</span></span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$request_method</span> <span class="regexp">~* "^PUT|DELETE$")</span> &#123;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^/(.+)</span>          /repository/npm-hosted/<span class="variable">$1</span>   <span class="literal">break</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span>      <span class="variable">$nexus3</span>;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在安装或发布模块时可通过选项<code>--registry</code>临时指定目标仓库地址：</p><ul><li>安装模块：<code>npm --registry=https://npm.example.com install &lt;module&gt;</code></li><li>发布模块：<code>npm --registry=https://npm.example.com publish &lt;folder&gt;</code></li></ul><p>也可以替换默认仓库，直接使用私有仓库：<code>npm config set registry https://npm.example.com</code>。</p><p>若需要还原为默认仓库，则运行命令<code>npm config set registry https://registry.npmjs.org</code>。</p><p><a href="https://docs.npmjs.com/cli/adduser" target="_blank" rel="noopener">登录</a>仓库则执行命令<code>npm login --registry=https://npm.example.com</code>。</p><h3 id="https-dcr-example-com的反向代理配置"><a href="#https-dcr-example-com的反向代理配置" class="headerlink" title="https://dcr.example.com的反向代理配置"></a><code>https://dcr.example.com</code>的反向代理配置</h3><blockquote><p>Source code: <a href="https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/repo.example.com.conf#L50" target="_blank" rel="noopener">https://github.com/flytreeleft/docker-nginx-gateway/blob/master/examples/vhost.d/repo.example.com.conf#L50</a></p></blockquote><p>在Nexus3中，Docker类型的仓库需要使用不同的端口进行访问，创建仓库时需要为仓库<a href="http://www.sonatype.org/nexus/2016/06/29/using-nexus-3-as-a-private-docker-registry/" target="_blank" rel="noopener">自行设定</a>一个HTTP端口号，然后再通过Nginx将读写请求转发到不同的端口上。</p><p>这里创建一个<code>hosted</code>模式的仓库<code>docker-hosted</code>用于<code>docker push</code>镜像，创建一个<code>group</code>模式的仓库<code>docker-public</code>用于组合多个第三方镜像仓库。</p><p>最终，针对<code>https://dcr.example.com</code>的Nginx配置如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> dcr.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/vhost.d/dcr.example.com/01_ssl.conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Disable cache of assets</span></span><br><span class="line">    <span class="attribute">proxy_cache</span>            <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span>     <span class="number">600</span>;</span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span>  <span class="number">600</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$http_user_agent</span> !<span class="regexp">~* "^docker/.+$")</span> &#123;</span><br><span class="line">            <span class="attribute">return</span> <span class="number">301</span> <span class="variable">$scheme</span>://repo.example.com/<span class="comment">#browse/browse/components:docker-public$request_uri;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set <span class="variable">$nexus3</span> http://&lt;nexus3 ip&gt;;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># docker pull dcr.example.com/xx-xx</span></span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$repo_url</span> <span class="variable">$nexus3</span>:&lt;docker-public port&gt;;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># https://github.com/moby/moby/blob/7061b0f748c29ffd1e6852cdc5dd11f90840eb1c/daemon/logger/awslogs/cloudwatchlogs_test.go#L71</span></span><br><span class="line">        <span class="comment"># https://github.com/moby/moby/blob/master/client/image_pull.go</span></span><br><span class="line">        <span class="comment"># https://github.com/moby/moby/blob/master/client/image_push.go</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> rewrite and proxy_pass should be put in the same block</span></span><br><span class="line">        <span class="comment">## http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite</span></span><br><span class="line">        <span class="comment"># docker push dcr.example.com/xx-xx</span></span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$request_method</span> <span class="regexp">~* "^HEAD|POST|PUT|DELETE|PATCH$")</span> &#123;</span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$repo_url</span> <span class="variable">$nexus3</span>:&lt;docker-hosted port&gt;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass</span> <span class="variable">$repo_url</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里同样需注意以下几个问题：</p><ul><li>Docker发送的HTTP请求中<code>User Agent</code>包含<code>docker</code>字符串，因此，如果<code>$http_user_agent</code>中没有这个字符串，则视为浏览器访问，直接跳转到<code>https://repo.example.com</code></li><li>从Docker的源码中可以发现<code>HTTP Method</code>为<code>HEAD</code>、<code>POST</code>、<code>PUT</code>、<code>DELETE</code>、<code>PATCH</code>均与镜像变更（新增、删除、打标签、更新等）有关，因此，需要将这些请求均转发到<code>docker-hosted</code>仓库</li></ul><p>在使用时可分别通过以下命令登录仓库以及拉取或推送镜像：</p><ul><li>登录仓库：<code>docker login dcr.example.com</code></li><li>拉取镜像：<code>docker pull dcr.example.com/&lt;image name&gt;:&lt;image version&gt;</code></li><li>推送镜像：<code>docker push dcr.example.com/&lt;image name&gt;:&lt;image version&gt;</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> 运维管理 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx配置 </tag>
            
            <tag> Nginx over Squid </tag>
            
            <tag> Nginx防火墙穿透 </tag>
            
            <tag> HTTPS代理HTTP资源 </tag>
            
            <tag> Nginx自定义错误页面 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>未来社会形态畅想</title>
      <link href="/the-future-social-formation/"/>
      <url>/the-future-social-formation/</url>
      
        <content type="html"><![CDATA[<blockquote><p>The post isn’t finished yet, it will be updated anytime!</p></blockquote><h2 id="无现金社会"><a href="#无现金社会" class="headerlink" title="无现金社会"></a>无现金社会</h2><p>提要：</p><ul><li>比特币、比特交易网络</li><li><a href="https://www.ethereum.org/" target="_blank" rel="noopener">以太坊</a></li><li><a href="http://www.iotachina.com/what-is-iota" target="_blank" rel="noopener">IOTA</a><ul><li><a href="http://www.iotachina.com/ruhezhaohuiiotayue.html" target="_blank" rel="noopener">如何找回IOTA余额</a>：可以从中了解转账机制与流程</li></ul></li></ul><a id="more"></a><h2 id="自由工作"><a href="#自由工作" class="headerlink" title="自由工作"></a>自由工作</h2><p>提要：</p><ul><li>为个人价值体现、兴趣、探索未知而工作，而不是为了生活和生存</li><li>社会基础能够保障个人衣食无忧，确保个人在任何时刻都无需担心温饱和居住问题，从而有精力专注于思考和探索上<ul><li>种植、生产、制造、输送流程实现全自动化、机械化</li></ul></li><li>自由选择工作时间、工作地点，不为特定的个人、团体、组织、企业工作，仅为达到某个目标而做事并获得对等回报</li></ul><h2 id="万物互联"><a href="#万物互联" class="headerlink" title="万物互联"></a>万物互联</h2><p>提要：</p><ul><li>联网的每个设备既为内容消费端，也是内容存储端，同时也是网络热点，附近的设备可随时且自由地连接在一起</li><li>基于内容进行网络访问，而不再基于IP或域名，任何端点都可能含有所需内容，就近选择并从该端点下载内容即可，内容原始发布端将无关紧要</li><li>分布式、无中心化的基础网络，不再需要路由器、交换机、服务器等中心设备</li><li>初始阶段需要通过ISP打通各个闭环网络（闭环的连接设备群组），当多个闭环网络连接形成足够大的闭环后，设备之间的通信将无需ISP的支持<ul><li>家用路由器等可自由共享网络，助推「万物网」的形成</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 社会形态 </category>
          
          <category> 未来世界 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 无现金社会 </tag>
            
            <tag> 无中心化 </tag>
            
            <tag> 万物互联 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>作恶行为清单</title>
      <link href="/the-evil-behaviors/"/>
      <url>/the-evil-behaviors/</url>
      
        <content type="html"><![CDATA[<blockquote><p>列举日常和网络中所发现的软件、应用、服务等的「作恶」行为，将其永久钉在「耻辱柱」上。有条件的或有候选方案的，应主动弃用之！<br>坚持开放、坚持自由。点击下载<a href="http://mirror.lihnidos.org/GNU/savannah/blug/fsfs-zh/fsfs-zh.pdf" target="_blank" rel="noopener">自由软件自由社会.pdf</a><br>就事论事，不针对个人、企业、平台，挖掘现象本质，努力尝试寻找更优方案</p></blockquote><h2 id="为逼迫用户使用客户端而阉割Web端的基本功能"><a href="#为逼迫用户使用客户端而阉割Web端的基本功能" class="headerlink" title="为逼迫用户使用客户端而阉割Web端的基本功能"></a>为逼迫用户使用客户端而阉割Web端的基本功能</h2><ul><li>案例： <a href="https://2.taobao.com/" target="_blank" rel="noopener">闲鱼</a>Web端隐藏搜索框</li><li>来源： <a href="https://www.appinn.com/xianyu-search-box/" target="_blank" rel="noopener">https://www.appinn.com/xianyu-search-box/</a></li><li>评语： 若欲达KPI，必先「中二自宫」<a id="more"></a></li></ul><p><img src="/assets/images/the-evil-behaviors/xianyu-hide-itself-search-form-of-web-client.png" alt="闲鱼Web端隐藏搜索框截图@2017-12-05"></p><h2 id="封闭平台之间因为利益互怼，以用户为筹码逼迫对方作出让步"><a href="#封闭平台之间因为利益互怼，以用户为筹码逼迫对方作出让步" class="headerlink" title="封闭平台之间因为利益互怼，以用户为筹码逼迫对方作出让步"></a>封闭平台之间因为利益互怼，以用户为筹码逼迫对方作出让步</h2><ul><li>案例： 谷歌<a href="https://youtube.com" target="_blank" rel="noopener">Youtube</a>禁止亚马逊<a href="https://developer.amazon.com/echo" target="_blank" rel="noopener">Echo</a>访问</li><li>来源： <a href="http://www.ifanr.com/951314" target="_blank" rel="noopener">http://www.ifanr.com/951314</a></li><li>相关： <a href="https://zh.wikipedia.org/wiki/%E5%A5%87%E8%99%8E360%E4%B8%8E%E8%85%BE%E8%AE%AFQQ%E4%BA%89%E6%96%97%E4%BA%8B%E4%BB%B6" target="_blank" rel="noopener">360与QQ大战</a>、<a href="http://wiki.mbalib.com/wiki/%E9%A1%BA%E4%B8%B0%E8%8F%9C%E9%B8%9F%E4%B9%8B%E4%BA%89" target="_blank" rel="noopener">菜鸟与顺丰互怼</a></li><li>评语： 用户在我手，天下跟我走。看不惯？你咬我呀！</li><li>观点： 在「封闭平台」中，用户从一开始便是平台的筹码，当平台「自认为」利益受到其他平台威胁时，便会不惜以损害用户体验的方式进行反击，其平日讨好用户的伪善面目便暴露无疑。平台越大，心眼越小，不安全感越严重，思路越单一，解决问题的方式越是直接粗暴。</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>软件开发最佳实践</title>
      <link href="/the-better-software-development-practice/"/>
      <url>/the-better-software-development-practice/</url>
      
        <content type="html"><![CDATA[<ul><li>任何<strong>局部优化</strong>都是在浪费生命</li></ul><blockquote><p>不要仅凭感觉去做性能和代码优化或者是重构代码，一定要<u>以性能测试和监控分析结果为依据</u>，重点优化和改进关键代码和影响常用功能的代码。</p><p>需要认识到和牢记的是，局部的小改进对业务整体而言是毫无意义的，只有从全局角度所做的改进才是可感知且有价值的。</p></blockquote><ul><li><p>不要原地打转：开发工作不要阻塞在单一技术点上，以完成业务功能为首要目标，不影响整体架构的技术难点可利用空闲时间解决</p></li><li><p>出现任何问题都始终保持<strong>就事论事</strong>的态度，不要带有个人情绪，不要在未查明根本原因的情况下将问题归咎于个人能力、品行或态度，应优先考虑提升项目管理、工作分配、人员激励、运维管理等制度和服务</p></li></ul><a id="more"></a><ul><li><strong>快速出错，快速修复</strong>：<a href="https://www.zhihu.com/question/21325941" target="_blank" rel="noopener">Let it Crash</a>（<a href="https://www.zhihu.com/question/22295393/answer/20912297）" target="_blank" rel="noopener">https://www.zhihu.com/question/22295393/answer/20912297）</a></li></ul><blockquote><p>如果不知道或不确定如何处理异常，那就让它抛出，甚至是让程序崩溃，从而让问题尽早出现并提前修复掉。</p><p>将异常“吃掉”是不负责任的，至少也应该打印到异常日志中（日志级别为<code>ERROR</code>），这样才有利于及时定位根源。</p><p>为避免单例程序崩溃导致服务不可用，可同时部署多个实例，提供冗余服务机制，这样就可以不用想各种方法来避免程序崩溃了，有了服务冗余，就<strong>让它崩溃</strong>吧。<br>PS：确保崩溃的服务能够快速重启也是很重要的。</p></blockquote><ul><li><p>无论是开发最终应用，还是基础框架，切忌，不要向使用者（普通用户或开发人员）暴露底层细节，更不要向使用者强制灌输细节内容。确保使用者可安心地、无干扰地关注业务功能的开发和使用</p></li><li><p>尽可能避免<u>让他人在解决与其业务不相关的问题上</u>耗费不必要的时间，进而减少社会总体时间成本</p><ul><li>命名清晰且与业务意义相关，太过随意的名称或简写对阅读和理解代码将造成极大阻碍，会提高他人以及未来的自己的时间成本</li><li>通过博客等向外界阐述、解释、提供案例/代码等，务必做到简洁、清晰、流畅、准确，不要让他人再耗费比自己更长的时间来理解文章内容、判断准确性等，应力求将读者的时间成本降至最低</li></ul></li><li><p>确保IDE具有自动版本控制功能，保证误删除代码可准确恢复</p></li><li><p>不要纠结于文档或代码格式等细节问题，首先关注其内容，格式问题需逐步引导并规范</p></li><li><p>提供完整、详细、准确的注释，并说明接口的使用方式、适用场景、注意事项等开发者需注意和其真正所关注的内容</p></li><li><p>尽可能优先编写测试用例，并在业务逻辑修改后先跑测试用例，再检查业务功能</p></li><li><p>数据库字段名、字段别名、表别名以“_”结尾，以避免和数据库关键字冲突</p></li><li><p>时间、日期以长整形进行前后端交互，避免格式化方式不同而造成的性能消耗和解析复杂</p></li><li><p>在后端统一拦截异常，并在前端针对<code>500</code>错误做统一显示</p></li><li><p>尽可能避免多应用、多线程共享数据或变量，应用之间操作数据需调用提供方的接口，严禁直接操作对方的数据</p></li><li><p>服务端API应支持模型的局部更新，即客户端仅向服务端发送需变更的字段及数据，未发送的字段不做变更</p></li><li><p>若SQL查询中需要限定<u>包含二进制或文本列</u>的数据行唯一性时，先通过子查询限定id的唯一性，再查出id在该子查询结果内的数据行</p><ul><li>Oracle中不支持<code>Clob/Blob</code>等字段的<code>distinct</code>约束</li></ul></li><li><p>避免在<code>if/else</code>中包含过长代码，可将其提取为独立接口，或者，通过<code>return</code>提前返回，以使分支逻辑更加清晰</p></li><li><p>在操作大量数据（以万及以上为单位）时，需尽可能避免使用递归，循环的效率比递归更高</p></li><li><p>避免使用Hibernate的级联更新，而应使用单独接口处理级联数据</p></li><li><p>尽可能为过程数据、临时数据、文件解析等创建对应的模型对象（Class），避免以Map等记录中间数据，从而保证代码的可读性，同时也有利于代码的自动化检查和处理</p></li><li><p>避免使用字符串字面量（Literal），应积极使用枚举类型来代表各类常量</p></li><li><p>将业务数据、消息数据、分析数据、日志数据等独立存储，并使用更合适的数据库或技术堆栈存储和查询</p></li><li><p>不要排斥<code>switch/case</code>，在很多情况下，其比<code>if/else</code>更优雅</p></li></ul><!--- 将日志等信息进行结构化存储，从而降低在日志分析时对文本内容解析所产生的性能开销- 尽可能分析所有已知的应用场景，再设计实现方案。且确保底层基础结构尽可能稳定和尽可能广泛的适应性- 每个页面跳转或加载都对应一个URL链接，并在跳转时修改地址，为避免整体页面的重新请求，可使用PAJX加载局部页面，同时，加上后端页面装饰的支持，以及BigPipe技术-->]]></content>
      
      
      <categories>
          
          <category> 开发规范 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>软件开发行为准则</title>
      <link href="/the-software-development-criterion/"/>
      <url>/the-software-development-criterion/</url>
      
        <content type="html"><![CDATA[<blockquote><p>The post isn’t finished yet, it will be updated anytime!</p></blockquote><h2 id="谨慎对待用户隐私"><a href="#谨慎对待用户隐私" class="headerlink" title="谨慎对待用户隐私"></a>谨慎对待用户隐私</h2><p>提要：</p><ul><li>不是仅用户确认后的数据才算是「用户隐私」，任何与用户相关的数据都应该「默认」视为用户隐私，<u>不需要任何形式的确认</u>，<br>而只有经过用户确认和同意的数据方可用作其他用途，且前提必须是明确告知数据为何要做此用途，以及将被如何利用、涉及哪些风险等</li></ul><a id="more"></a><h2 id="努力降低总体开发和使用成本"><a href="#努力降低总体开发和使用成本" class="headerlink" title="努力降低总体开发和使用成本"></a>努力降低总体开发和使用成本</h2><p>提要：</p><ul><li>总体成本等于所有个人的时间成本与财力物力之总和</li><li>提供到达/完成目标的最短操作路径<ul><li>提供详细的文档（开发、设计、使用），备注相关知识来源链接，从最终使用者角度考虑使用流程、会遇到的困难和疑问、期望的快捷方式</li><li>将当前关注点在一页（一屏）中展示；直接到达操作按钮；</li><li>从开发者与最终用户的角度思考各个关注点，直接提供所需信息、接口、说明以及软件功能</li><li>不是一眼就明了其意义的图标需提供文字提示或说明，或者直接使用文字</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 开发规范 </category>
          
          <category> 职业道德 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 隐私 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何突破自己的瓶颈？</title>
      <link href="/how-to-break-out-of-your-limit/"/>
      <url>/how-to-break-out-of-your-limit/</url>
      
        <content type="html"><![CDATA[<blockquote><p>The post isn’t finished yet, it will be updated anytime!</p></blockquote><h2 id="以旁观者角度审视自己"><a href="#以旁观者角度审视自己" class="headerlink" title="以旁观者角度审视自己"></a>以旁观者角度审视自己</h2><p>提要：</p><ul><li>勇敢面对自己，正视自己的缺点</li><li>客观分析自己的好的、坏的甚至是邪恶的想法，不好的想法切不可影响到他人，需要自我消化</li><li>人无完人，对于非理性情绪不要过分压抑，在不影响他人的情况下采取各种积极或消极的方式去释放这些情绪<ul><li>消极的释放方式所要达到的目的是推翻重建，进入全新的境界，从而从另一个视角看待原来的情绪和行为</li></ul></li></ul><a id="more"></a><h2 id="理性看待他人的评论、观点和建议，保持就事论事的态度，切忌带有个人情绪，更不要被别人带着走（影响个人情绪、怀疑个人价值观等等）"><a href="#理性看待他人的评论、观点和建议，保持就事论事的态度，切忌带有个人情绪，更不要被别人带着走（影响个人情绪、怀疑个人价值观等等）" class="headerlink" title="理性看待他人的评论、观点和建议，保持就事论事的态度，切忌带有个人情绪，更不要被别人带着走（影响个人情绪、怀疑个人价值观等等）"></a>理性看待他人的评论、观点和建议，保持就事论事的态度，切忌带有个人情绪，更不要被别人带着走（影响个人情绪、怀疑个人价值观等等）</h2><p>提要：</p><ul><li>若无法静心并保持客观，那就禁用评论，不与人争论，专注于自己的思考方向，但需多接触不同观点，及时调整，不可过于执念</li><li>开放心态，放下恩怨是非，求同存异</li><li>事物的美好在于不同，不同的观点、思想的碰撞才能产生激烈的火花，而消灭差异最终只会沦为「行尸走肉」</li><li>「尊重你说话的权利，但也保留我的个人意见」</li><li>没有绝对的对错，对错都是相对的，在不同身份、不同环境、不同角度甚至可能发生反转。依据当前已知信息作出相对合理的选择，并在实践过程中不断调整</li></ul><h2 id="专注于探索自己的生活方式和方向，不羡慕别人的生活，先过好自己的"><a href="#专注于探索自己的生活方式和方向，不羡慕别人的生活，先过好自己的" class="headerlink" title="专注于探索自己的生活方式和方向，不羡慕别人的生活，先过好自己的"></a>专注于探索自己的生活方式和方向，不羡慕别人的生活，先过好自己的</h2><p>提要：</p><ul><li>时常在朋友圈、新闻、他人口中看到或听到某某光鲜亮丽、幸福美满、事业猛进，而自己依然处于迷茫、混沌、一人吃饱全家不饿的状态，心里倍感失落、感觉就是一loser，进而嫉妒别人，甚而诅咒他人</li><li>那你需要静下来分析，如何形成当前局面，自己真正需要的是什么，自己在生活的路上做了什么</li><li>别人都在幸福的路上忙碌奔波，而你却有如此闲心去妒嫉别人的生活？</li><li>人人都有自己的活法，也有不同的满足，找到属于自己的，并聚焦于此，为此而忙碌，心无杂念</li><li>以“出世”的态度去观察他人和自己，不要觉得自己过得不如意就希望全世界都得与你一起面对种种不如意，从他人的不幸中去寻找优越感，将会使自己越来越失败、愤恨、怀疑自己。不断战胜、超越自己才是正途</li><li>始终保持内心的平静，避免外界对自己的诱惑和干扰，要有自己的坚守，纯粹的名与利终究是带不走的</li><li>沉下心来专注于自己的事情，朝着自己认为可行的方向前行，也许会失败，但在行进过程中同样也能学到很多东西，所以，不要一开始就因为害怕失败而不去做，先勇敢地去做，快速尝试以快速失败或成功</li></ul><h2 id="对所见、所听、所接触的事、物、人，取其精华去其糟泊，吸收有用可取的方式，探索本质，获得处事之道"><a href="#对所见、所听、所接触的事、物、人，取其精华去其糟泊，吸收有用可取的方式，探索本质，获得处事之道" class="headerlink" title="对所见、所听、所接触的事、物、人，取其精华去其糟泊，吸收有用可取的方式，探索本质，获得处事之道"></a>对所见、所听、所接触的事、物、人，取其精华去其糟泊，吸收有用可取的方式，探索本质，获得处事之道</h2><p>提要：</p><ul><li>有些人就是人生路上的“小怪兽”，有些人是良师益友</li></ul><h2 id="随时准备两件事情，以避免当前事情完成后不知道该继续做什么的困境"><a href="#随时准备两件事情，以避免当前事情完成后不知道该继续做什么的困境" class="headerlink" title="随时准备两件事情，以避免当前事情完成后不知道该继续做什么的困境"></a>随时准备两件事情，以避免当前事情完成后不知道该继续做什么的困境</h2><h2 id="准备一份阅读书籍列表，在无所事事时，避免无目的的刷网页，转而看书会更加有益"><a href="#准备一份阅读书籍列表，在无所事事时，避免无目的的刷网页，转而看书会更加有益" class="headerlink" title="准备一份阅读书籍列表，在无所事事时，避免无目的的刷网页，转而看书会更加有益"></a>准备一份阅读书籍列表，在无所事事时，避免无目的的刷网页，转而看书会更加有益</h2>]]></content>
      
      
      <categories>
          
          <category> 自我剖析 </category>
          
          <category> 人性探索 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 自我 </tag>
            
            <tag> 静心 </tag>
            
            <tag> 优越感 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git使用案例</title>
      <link href="/git-usage-cases/"/>
      <url>/git-usage-cases/</url>
      
        <content type="html"><![CDATA[<h2 id="拆分子目录到新仓库"><a href="#拆分子目录到新仓库" class="headerlink" title="拆分子目录到新仓库"></a>拆分子目录到新仓库</h2><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>通常为便于项目开发和调试，开发前期会将多个组件放在同一仓库中，而当各个组件的功能结构和代码逐渐区域稳定后，<br>便需要将其拆分出来进行独立开发和管理，以便于与其他项目共享组件。</p><p>此时，不仅需要将组件所在目录内的代码全部拆分到单独的仓库，同时，还需要确保历史记录能够完整保留。</p><a id="more"></a><h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Clone the repository that contains the subfolder.</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/USERNAME/REPOSITORY-NAME</span><br><span class="line"><span class="built_in">cd</span> REPOSITORY-NAME</span><br><span class="line"></span><br><span class="line"><span class="comment"># To filter out the subfolder from the rest of the files in the repository</span></span><br><span class="line"><span class="comment">## FOLDER-NAME: The folder within your project that you'd like to create a separate repository from.</span></span><br><span class="line"><span class="comment">## BRANCH-NAME: The default branch for your current project, for example, 'master' or 'gh-pages'</span></span><br><span class="line">git filter-branch --prune-empty --subdirectory-filter FOLDER-NAME BRANCH-NAME</span><br><span class="line"></span><br><span class="line"><span class="comment"># Change the existing remote 'origin' (or other name) URL to the new repository URL</span></span><br><span class="line">git remote <span class="built_in">set</span>-url origin https://github.com/USERNAME/NEW-REPOSITORY-NAME.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># [Optional] Change BRANCH-NAME to the default branch (e.g. 'master') of the new repository</span></span><br><span class="line">git branch -m BRANCH-NAME master</span><br><span class="line"></span><br><span class="line"><span class="comment"># Push your changes to the new repository</span></span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li>在第二步操作后，当前目录将会只剩下子目录中的文件</li><li>最好在新的目录中进行上述操作：可以直接clone，也可以从复制已有项目到其他目录</li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://help.github.com/articles/splitting-a-subfolder-out-into-a-new-repository/" target="_blank" rel="noopener">Splitting a subfolder out into a new repository</a></li></ul><h2 id="修改变更提交人的信息"><a href="#修改变更提交人的信息" class="headerlink" title="修改变更提交人的信息"></a>修改变更提交人的信息</h2><h3 id="场景-1"><a href="#场景-1" class="headerlink" title="场景"></a>场景</h3><p>基于项目长远发展考虑，将某个具有实用价值且吸引力极大的项目开源，<br>需要将项目从公司内部仓库开放到Github上，但相关开发人员在两个系统中所用帐号不一致，<br>为了便于issue交流以及PR提交，这时，需要更改历史中的提交人信息。</p><p>其实，大多数时候，很可能是要弃用内部仓库并将工作全部移到公共仓库时才有这么做的需求，其余情况并不需要这么做。</p><h3 id="操作-1"><a href="#操作-1" class="headerlink" title="操作"></a>操作</h3><ul><li>部分替换：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git filter-branch --commit-filter \</span><br><span class="line">        <span class="string">'if [ "$GIT_AUTHOR_NAME" = "OldAuthor Name" ]; then \</span></span><br><span class="line"><span class="string">             export GIT_AUTHOR_NAME="Author Name"; \</span></span><br><span class="line"><span class="string">             export GIT_AUTHOR_EMAIL=authorEmail@example.com; \</span></span><br><span class="line"><span class="string">             export GIT_COMMITTER_NAME="Commmiter Name"; \</span></span><br><span class="line"><span class="string">             export GIT_COMMITTER_EMAIL=commiterEmail@example.com; \</span></span><br><span class="line"><span class="string">         fi; \</span></span><br><span class="line"><span class="string">         git commit-tree "$@" '</span></span><br><span class="line"><span class="comment"># Push to the branch 'master' of the existing repository</span></span><br><span class="line">git push --force origin master</span><br></pre></td></tr></table></figure><ul><li>全部替换：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git filter-branch --commit-filter \</span><br><span class="line">        <span class="string">'export GIT_AUTHOR_NAME="Author Name"; \</span></span><br><span class="line"><span class="string">         export GIT_AUTHOR_EMAIL=authorEmail@example.com; \</span></span><br><span class="line"><span class="string">         export GIT_COMMITTER_NAME="Commmiter Name"; \</span></span><br><span class="line"><span class="string">         export GIT_COMMITTER_EMAIL=commiterEmail@example.com; \</span></span><br><span class="line"><span class="string">         git commit-tree "$@" '</span></span><br><span class="line"><span class="comment"># Push to the branch 'master' of the existing repository</span></span><br><span class="line">git push --force origin master</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li>若出现类似<code>Cannot create a new backup. A previous backup already exists in refs/original/. Force overwriting the backup with -f</code>的异常提示，则需要在<code>filter-branch</code>命令中添加选项<code>-f</code>，即<code>git filter-branch -f</code>，以强制进行修改</li><li>如果提交的分支是受保护的，则在提交时会出现<code>remote: GitLab: You are not allowed to force push code to a protected branch on this project.</code>的错误信息，此时，需要调整仓库设置，临时取消对目标分支的保护</li></ul><h3 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://stackoverflow.com/questions/4493936/could-i-change-my-name-and-surname-in-all-previous-commits" target="_blank" rel="noopener">Could I change my name and surname in all previous commits?</a></li></ul><h2 id="迁移子分支至新仓库"><a href="#迁移子分支至新仓库" class="headerlink" title="迁移子分支至新仓库"></a>迁移子分支至新仓库</h2><h3 id="场景-2"><a href="#场景-2" class="headerlink" title="场景"></a>场景</h3><p>某个项目仓库中可能存在多个功能特性（features）分支，在一段时候后，基于产品功能规划和开发维护等方面的考虑，<br>需要将某些特性分支独立成新的项目或子项目，将其迁移到新的仓库中。</p><h3 id="操作-2"><a href="#操作-2" class="headerlink" title="操作"></a>操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Push 'feature-branch' to the branch 'master' (or others) of new repository</span></span><br><span class="line">git push url://to/new/repository.git feature-branch:master</span><br><span class="line"></span><br><span class="line"><span class="comment"># [Optional] Delete the 'feature-branch' from current repository</span></span><br><span class="line">git branch -d feature-branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clone codes from new repository</span></span><br><span class="line">git <span class="built_in">clone</span> url://to/new/repository.git feature-branch</span><br></pre></td></tr></table></figure><h3 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://stackoverflow.com/questions/2227062/how-do-i-move-a-git-branch-out-into-its-own-repository" target="_blank" rel="noopener">How do I move a Git branch out into its own repository?</a></li></ul><h2 id="修改历史提交备注信息"><a href="#修改历史提交备注信息" class="headerlink" title="修改历史提交备注信息"></a>修改历史提交备注信息</h2><h3 id="场景-3"><a href="#场景-3" class="headerlink" title="场景"></a>场景</h3><p>在<a href="#拆分子目录到新仓库">拆分子目录</a>和<a href="#迁移子分支至新仓库">迁移子分支</a>两个场景中，<br>在新仓库中的历史提交记录的备注信息可能存在与项目不相关的信息或者包含原始项目中的一些敏感内容。<br>这个时候，就可能需要修改这些备注信息。</p><p>当然，也可能是因为发现以前的提交备注中包含错别字或者表达不清晰，为了避免对其他人产生误导或困惑，<br>将提交的备注信息予以纠正也是很有必要的。</p><h3 id="操作-3"><a href="#操作-3" class="headerlink" title="操作"></a>操作</h3><ul><li>获取提交ID并Rebase到该提交</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># List histories and get the commit id which should be modified</span></span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rebase to 3 commits before the specified commit (e.g. 'ce0ac37c83')</span></span><br><span class="line">git rebase --interactive ce0ac37c83~3</span><br></pre></td></tr></table></figure><p><img src="/assets/images/git-usage-cases-rebase-to-target-commit.png" alt></p><ul><li>将提交所在行开始处的<code>pick</code>修改为<code>edit</code></li></ul><p><img src="/assets/images/git-usage-cases-change-history-commit.png" alt></p><ul><li>提交并应用修改</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># New commit message</span></span><br><span class="line">git commit --amend -m <span class="string">"fix that the dragging preview can not be shown"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Apply the changes and return to HEAD</span></span><br><span class="line">git rebase --<span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Push to the branch 'master' of the existing repository</span></span><br><span class="line"><span class="comment">## Make sure that the remote branch 'master' is unprotected</span></span><br><span class="line">git push --force origin master</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li>如果需要放弃修改，则运行命令<code>git rebase --abort</code></li><li>若直接<code>rebase</code>到目标commit，则该提交不会显示在可修改清单内，故，需选择从其之前的第N个（e.g. <code>~3</code>）提交开始</li><li>若提交至非空的仓库，需确保目标分支不是受保护（<code>protected</code>）的</li><li>在应用修改后，git将从修改位置开始重新构建commit tree，因此，从该位置开始到HEAD的commit id均会发生变化，但原始commit tree依然存在，通过<code>git diff ce0ac37c83</code>等可看到该提交的变更情况</li></ul><h3 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://stackoverflow.com/questions/179123/how-to-modify-existing-unpushed-commits" target="_blank" rel="noopener">How to modify existing, unpushed commits?</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 开发工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello world!</title>
      <link href="/hello-world/"/>
      <url>/hello-world/</url>
      
        <content type="html"><![CDATA[<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">"Hello world!"</span>);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert(<span class="string">'Hello world!'</span>);</span><br></pre></td></tr></table></figure><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"Hello world!"</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
